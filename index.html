<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conex√£o Secreta</title>
    <!-- Carrega o Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carrega a biblioteca de √≠cones Phosphor -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Carrega a biblioteca de Nuvem de Palavras -->
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>
    <style>
        /* Estilos personalizados para fontes, anima√ß√µes e temas */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Classe para o efeito de "cart√£o virando" */
        .card-inner {
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .card-container:hover .card-inner {
            transform: rotateY(180deg);
        }

        .card-front,
        .card-back {
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }

        .card-back {
            transform: rotateY(180deg);
        }

        /* Classes de temas de cores (Perfil Colorido) */
        .theme-blue {
            --color-primary: 219;
            --color-bg: 39, 102, 230;
            /* bg-blue-600 */
        }

        .theme-green {
            --color-primary: 134;
            --color-bg: 21, 128, 61;
            /* bg-green-700 */
        }

        .theme-purple {
            --color-primary: 279;
            --color-bg: 126, 34, 206;
            /* bg-purple-700 */
        }

        .theme-red {
            --color-primary: 347;
            --color-bg: 220, 38, 38;
            /* bg-red-600 */
        }

        .theme-yellow {
            --color-primary: 45;
            --color-bg: 202, 138, 4;
            /* bg-yellow-600 */
        }

        /* Aplicando as vari√°veis CSS */
        .bg-primary-themed {
            background-color: rgb(var(--color-bg));
        }

        .text-primary-themed {
            color: rgb(var(--color-bg));
        }

        .border-primary-themed {
            border-color: rgb(var(--color-bg));
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-900 antialiased">

    <!-- Recipiente Principal -->
    <div id="app" class="min-h-screen">

        <!-- 1. TELA DE CARREGAMENTO (Spinner) -->
        <div id="loading-spinner" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
            <i class="ph-bold ph-atom text-blue-600 text-6xl animate-spin"></i>
            <span class="mt-4 text-lg font-medium text-gray-700">Conectando...</span>
        </div>

        <!-- 2. TELA DE LOGIN / CADASTRO -->
        <div id="auth-screen" class="hidden min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8">
                <div class="flex justify-center mb-6">
                    <i class="ph-bold ph-users-three text-blue-600 text-5xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Conex√£o Secreta</h1>
                <p class="text-center text-gray-600 mb-6">Entre ou cadastre-se para iniciar.</p>

                <!-- Abas de Login / Cadastro -->
                <div class="flex mb-4 border-b border-gray-200">
                    <button id="tab-login" class="flex-1 py-2 font-medium text-blue-600 border-b-2 border-blue-600">Entrar</button>
                    <button id="tab-register" class="flex-1 py-2 font-medium text-gray-500">Cadastrar</button>
                </div>

                <!-- Formul√°rio de Login -->
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="login-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="seu.email@exemplo.com">
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                        <input type="password" id="login-password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center justify-center">
                        <i class="ph-bold ph-sign-in mr-2"></i>
                        Entrar
                    </button>
                </form>

                <!-- Formul√°rio de Cadastro -->
                <form id="register-form" class="hidden">
                    <div class="mb-4">
                        <label for="register-name" class="block text-sm font-medium text-gray-700 mb-1">Nome Completo</label>
                        <input type="text" id="register-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Seu nome vis√≠vel">
                    </div>
                    <div class="mb-4">
                        <label for="register-turma" class="block text-sm font-medium text-gray-700 mb-1">Selecione sua Turma</label>
                        <select id="register-turma" required class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Escolha sua turma --</option>
                            <option value="1IATEC-ANCHIETA">1IATEC-ANCHIETA</option>
                            <option value="1MA-CHAMPAGNAT">1MA-CHAMPAGNAT</option>
                            <option value="1MB-CHAMPAGNAT">1MB-CHAMPAGNAT</option>
                            <option value="1TB-CHAMPAGNAT">1TB-CHAMPAGNAT</option>
                            <option value="1MATEC-OLYMPIA">1MATEC-OLYMPIA</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="register-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="seu.email@exemplo.com">
                    </div>
                    <div class="mb-4">
                        <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                        <input type="password" id="register-password" required minlength="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="M√≠nimo 6 caracteres">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 flex items-center justify-center">
                        <i class="ph-bold ph-user-plus mr-2"></i>
                        Criar Conta
                    </button>
                </form>

                <p id="auth-error" class="text-red-500 text-sm text-center mt-4"></p>
            </div>
        </div>

        <!-- 3. TELA PRINCIPAL (Conte√∫do do App) -->
        <div id="main-app" class="hidden">
            <!-- Barra de Navega√ß√£o -->
            <nav class="bg-white shadow-md sticky top-0 z-40">
                <div class="container mx-auto max-w-6xl px-4 py-3 flex justify-between items-center">
                    <div class="flex items-center space-x-2">
                        <i class="ph-bold ph-users-three text-blue-600 text-3xl"></i>
                        <span class="text-xl font-bold text-gray-800">Conex√£o Secreta</span>
                    </div>
                    <div class="flex items-center space-x-2 md:space-x-4">
                        <span id="nav-turma" class="hidden md:inline-block text-sm font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full"></span>
                        <button id="nav-admin" title="Painel Admin" class="text-gray-600 hover:text-blue-600 p-2 rounded-full hover:bg-gray-100">
                            <i class="ph-bold ph-user-gear text-2xl"></i>
                        </button>
                        <button id="nav-profile" title="Meu Perfil" class="text-gray-600 hover:text-blue-600 p-2 rounded-full hover:bg-gray-100">
                            <i class="ph-bold ph-user-circle text-2xl"></i>
                        </button>
                        <button id="nav-logout" title="Sair" class="text-gray-600 hover:text-red-600 p-2 rounded-full hover:bg-gray-100">
                            <i class="ph-bold ph-sign-out text-2xl"></i>
                        </button>
                    </div>
                </div>
                <!-- Menu de Abas -->
                <div class="bg-gray-50 border-b border-t border-gray-200">
                    <div class="container mx-auto max-w-6xl px-4 flex space-x-4 overflow-x-auto">
                        <button classa="nav-tab" data-target="page-main" class="nav-tab-button text-blue-600 border-b-2 border-blue-600 py-3 px-2 md:px-4 font-medium flex items-center space-x-2">
                            <i class="ph-bold ph-game-controller"></i>
                            <span>Minha Rodada</span>
                        </button>
                        <button data-target="page-gifts" class="nav-tab-button text-gray-600 hover:text-black py-3 px-2 md:px-4 font-medium flex items-center space-x-2">
                            <i class="ph-bold ph-gift"></i>
                            <span>Minha Estante</span>
                        </button>
                        <button data-target="page-stats" class="nav-tab-button text-gray-600 hover:text-black py-3 px-2 md:px-4 font-medium flex items-center space-x-2">
                            <i class="ph-bold ph-chart-bar"></i>
                            <span>Meu Painel</span>
                        </button>
                        <button data-target="page-tips" class="nav-tab-button text-gray-600 hover:text-black py-3 px-2 md:px-4 font-medium flex items-center space-x-2">
                            <i class="ph-bold ph-lightbulb"></i>
                            <span>Mural de Dicas</span>
                        </button>
                        <button data-target="page-thanks" class="nav-tab-button text-gray-600 hover:text-black py-3 px-2 md:px-4 font-medium flex items-center space-x-2">
                            <i class="ph-bold ph-heart"></i>
                            <span>Mural de Agradecimentos</span>
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Conte√∫do da P√°gina (Alterna com base nas abas) -->
            <main class="container mx-auto max-w-6xl p-4 md:p-6">

                <!-- P√ÅGINA 1: MINHA RODADA -->
                <div id="page-main" class="app-page">
                    <!-- Estado 1: Jogo n√£o iniciado -->
                    <div id="game-state-waiting" class="hidden text-center bg-white p-8 rounded-2xl shadow-lg">
                        <i class="ph-bold ph-hourglass-high text-blue-600 text-6xl mx-auto animate-bounce"></i>
                        <h2 class="text-2xl font-bold mt-4">Aguardando In√≠cio</h2>
                        <p class="text-gray-600 mt-2 max-w-lg mx-auto">O administrador da turma ainda n√£o iniciou a rodada. Assim que o jogo come√ßar, seu amigo secreto aparecer√° aqui!</p>
                        <p class="text-sm text-gray-500 mt-6">Aproveite para preencher seu perfil ou dar uma olhada no Mural de Dicas.</p>
                    </div>

                    <!-- Estado 2: Perfil Incompleto -->
                    <div id="game-state-profile-incomplete" class="hidden text-center bg-white p-8 rounded-2xl shadow-lg">
                        <i class="ph-bold ph-warning-circle text-yellow-500 text-6xl mx-auto"></i>
                        <h2 class="text-2xl font-bold mt-4">Perfil Incompleto!</h2>
                        <p class="text-gray-600 mt-2 max-w-lg mx-auto">Voc√™ precisa preencher seu perfil antes de participar da rodada. Suas respostas ser√£o as dicas para o seu amigo secreto!</p>
                        <button id="go-to-profile-btn" class="mt-6 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300">
                            Preencher Perfil Agora
                        </button>
                    </div>

                    <!-- Estado 3: Jogo Ativo (Adivinha√ß√£o) -->
                    <div id="game-state-guessing" class="hidden">
                        <div class="text-center mb-6">
                            <h2 class="text-3xl font-bold text-gray-800">Decifre seu Amigo Secreto!</h2>
                            <p class="text-lg text-gray-600">Baseado nas dicas abaixo, tente adivinhar quem voc√™ tirou.</p>
                        </div>

                        <!-- Anima√ß√£o Sorteio (Aparece 1x) -->
                        <div id="draw-animation" class="hidden w-full max-w-md mx-auto my-8 p-6 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl shadow-2xl text-white text-center">
                            <i class="ph-bold ph-gift text-6xl animate-bounce"></i>
                            <h3 class="text-2xl font-bold mt-4">Sorteio Realizado!</h3>
                            <p class="mt-2">Seu amigo secreto foi sorteado! Prepare-se para decifrar as pistas...</p>
                        </div>

                        <!-- Card de Dicas -->
                        <div id="target-profile" class="w-full max-w-lg mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-xl">
                            <div class="flex items-center mb-6">
                                <div id="target-avatar-bg" class="w-16 h-16 rounded-full flex items-center justify-center text-4xl mr-4 bg-primary-themed text-white">
                                    <span id="target-avatar-emoji">‚ùì</span>
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-800">Quem √© essa pessoa?</h3>
                                    <p class="text-gray-500">Analise as dicas e d√™ seu palpite!</p>
                                </div>
                            </div>

                            <!-- Dicas -->
                            <div classs="space-y-4">
                                <div class="border-l-4 border-primary-themed pl-4 py-2 bg-gray-50 rounded-r-lg">
                                    <p class="text-sm font-medium text-gray-500">Se pudesse criar um app, ele faria...</p>
                                    <p id="target-q1" class="text-gray-800 font-medium italic">...</p>
                                </div>
                                <div class="border-l-4 border-primary-themed pl-4 py-2 bg-gray-50 rounded-r-lg mt-4">
                                    <p class="text-sm font-medium text-gray-500">A tecnologia que mais gostaria de ter √©...</p>
                                    <p id="target-q2" class="text-gray-800 font-medium italic">...</p>
                                </div>
                                <div class="border-l-4 border-primary-themed pl-4 py-2 bg-gray-50 rounded-r-lg mt-4">
                                    <p class="text-sm font-medium text-gray-500">Algo interessante que descobri/aprendi com tecnologia foi...</p>
                                    <p id="target-q3" class="text-gray-800 font-medium italic">...</p>
                                </div>
                            </div>

                            <!-- Formul√°rio de Adivinha√ß√£o -->
                            <div class="mt-8 pt-6 border-t border-gray-200">
                                <form id="guess-form">
                                    <label for="guess-select" class="block text-lg font-medium text-gray-700 mb-2 text-center">Qual √© o seu palpite?</label>
                                    <select id="guess-select" class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500">
                                        <option value="">Selecione um nome...</option>
                                        <!-- Nomes da turma ser√£o preenchidos aqui -->
                                    </select>
                                    <p class="text-center text-gray-500 mt-2 text-sm">Tentativas restantes: <span id="guess-attempts-left" class="font-bold">3</span></p>
                                    <button type="submit" class="w-full mt-4 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 flex items-center justify-center">
                                        <i class="ph-bold ph-check-circle mr-2"></i>
                                        Confirmar Palpite
                                    </button>
                                    <p id="guess-error" class="text-red-500 text-sm text-center mt-2"></p>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Estado 4: Jogo Ativo (Feedback) -->
                    <div id="game-state-feedback" class="hidden">
                        <div class="text-center mb-6">
                            <i class="ph-bold ph-check-circle text-green-500 text-6xl mx-auto"></i>
                            <h2 class="text-3xl font-bold text-gray-800 mt-4">Voc√™ Acertou!</h2>
                            <p class="text-lg text-gray-600">Seu amigo secreto era <span id="target-name" class="font-bold text-blue-600">...</span>.</p>
                            <p class="text-sm text-gray-500">(O nome ser√° ocultado em 10 segundos por privacidade)</p>
                        </div>

                        <!-- Formul√°rio de Feedback -->
                        <form id="feedback-form" class="w-full max-w-lg mx-auto bg-white p-6 md:p-8 rounded-2xl shadow-xl">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Deixe seu feedback e presente</h3>
                            <!-- Dicas de Bom Feedback -->
                            <details class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 cursor-pointer">
                                <summary class="font-medium text-blue-700 flex items-center justify-between">
                                    <span>Ver Dicas de Bom Feedback</span>
                                    <i class="ph-bold ph-caret-down"></i>
                                </summary>
                                <ul class="list-disc list-inside text-blue-800 mt-2 space-y-1 text-sm">
                                    <li><b>Seja espec√≠fico:</b> Em vez de "voc√™ √© legal", diga "admiro como voc√™ ajuda os colegas".</li>
                                    <li><b>Foque na a√ß√£o:</b> Em vez de "voc√™ √© bagunceiro", diga "√†s vezes, quando conversamos, eu me distraio".</li>
                                    <li><b>Seja gentil:</b> O objetivo √© ajudar, n√£o magoar. Foque no positivo!</li>
                                </ul>
                            </details>

                            <!-- Campo 1: Positivo -->
                            <div class="mb-4">
                                <label for="feedback-positive" class="block text-sm font-medium text-gray-700 mb-1"><i class="ph-fill ph-sun text-yellow-500 mr-1"></i> Algo que eu realmente admiro em voc√™ √©...</label>
                                <textarea id="feedback-positive" required rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Seja espec√≠fico e positivo..."></textarea>
                            </div>

                            <!-- Campo 2: Construtivo -->
                            <div class="mb-4">
                                <label for="feedback-constructive" class="block text-sm font-medium text-gray-700 mb-1"><i class="ph-fill ph-plant text-green-500 mr-1"></i> Uma sugest√£o que eu te daria como amigo(a) √©...</label>
                                <textarea id="feedback-constructive" required rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Uma dica amig√°vel para ajudar a pessoa..."></textarea>
                            </div>

                            <!-- Campo 3: Escolha do Presente -->
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Meu Presente para Voc√™ (Escolha UMA op√ß√£o):</label>
                                <div class="flex space-x-4">
                                    <label class="flex items-center p-3 border border-gray-300 rounded-lg flex-1 cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                                        <input type="radio" id="gift-type-real" name="gift-type" value="real" class="mr-2 text-blue-600 focus:ring-blue-500">
                                        <i class="ph-fill ph-gift text-blue-600 text-xl mr-2"></i>
                                        <span>Presente Real</span>
                                    </label>
                                    <label class="flex items-center p-3 border border-gray-300 rounded-lg flex-1 cursor-pointer has-[:checked]:bg-purple-50 has-[:checked]:border-purple-400">
                                        <input type="radio" id="gift-type-joke" name="gift-type" value="joke" class="mr-2 text-purple-600 focus:ring-purple-500">
                                        <i class="ph-fill ph-smiley-wink text-purple-600 text-xl mr-2"></i>
                                        <span>Presente Zueira</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Campo 3.1: Presente Real -->
                            <div id="gift-real-box" class="hidden mb-4">
                                <label for="feedback-gift-real" class="block text-sm font-medium text-gray-700 mb-1">Se fosse um presente real, eu te daria...</label>
                                <input type="text" id="feedback-gift-real" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Ex: Um livro, um fone de ouvido, etc.">
                                <label for="feedback-gift-real-reason" class="block text-sm font-medium text-gray-700 mt-2 mb-1">Justificativa do presente:</label>
                                <input type="text" id="feedback-gift-real-reason" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Porque voc√™ merece...">
                            </div>

                            <!-- Campo 3.2: Presente Zueira -->
                            <div id="gift-joke-box" class="hidden mb-4">
                                <label for="feedback-gift-joke" class="block text-sm font-medium text-gray-700 mb-1">Se fosse um presente "da zueira", eu te daria...</label>
                                <input type="text" id="feedback-gift-joke" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Ex: Um dicion√°rio, um despertador, etc.">
                                <label for="feedback-gift-joke-reason" class="block text-sm font-medium text-gray-700 mt-2 mb-1">Justificativa da zueira:</label>
                                <input type="text" id="feedback-gift-joke-reason" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="Porque voc√™ sempre...">
                            </div>

                            <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300 flex items-center justify-center">
                                <i class="ph-bold ph-paper-plane-tilt mr-2"></i>
                                Enviar Feedback e Presente
                            </button>
                        </form>
                    </div>

                    <!-- Estado 5: Feedback Enviado -->
                    <div id="game-state-done" class="hidden text-center bg-white p-8 rounded-2xl shadow-lg">
                        <i class="ph-bold ph-paper-plane-tilt text-green-500 text-6xl mx-auto"></i>
                        <h2 class="text-2xl font-bold mt-4">Feedback Enviado!</h2>
                        <p class="text-gray-600 mt-2 max-w-lg mx-auto">Sua miss√£o est√° completa! Agora s√≥ precisamos aguardar o administrador liberar a entrega dos presentes para que voc√™ possa ver o que recebeu.</p>
                        <p class="text-sm text-gray-500 mt-6">Enquanto espera, que tal um Quiz?</p>
                        <button id="start-quiz-btn" class="mt-4 bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition duration-300">
                            <i class="ph-bold ph-question mr-2"></i>
                            Iniciar Quiz Surpresa
                        </button>
                    </div>
                </div>

                <!-- P√ÅGINA 2: MINHA ESTANTE -->
                <div id="page-gifts" class="app-page hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Minha Estante de Presentes</h2>
                    <div id="gifts-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Estado Vazio -->
                        <div id="gifts-empty-state" class="hidden md:col-span-2 lg:col-span-3 text-center bg-white p-8 rounded-2xl shadow-lg">
                            <i class="ph-bold ph-package text-gray-400 text-6xl mx-auto"></i>
                            <h3 class="text-2xl font-bold mt-4">Sua Estante est√° vazia</h3>
                            <p class="text-gray-600 mt-2 max-w-lg mx-auto">Quando o administrador liberar a entrega, os feedbacks e presentes que voc√™ recebeu aparecer√£o aqui, rodada ap√≥s rodada.</p>
                        </div>
                        <!-- Cards de Presente (Modelo) 
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <span class="text-sm font-medium bg-blue-100 text-blue-700 px-3 py-1 rounded-full">Rodada 1</span>
                            <div class="mt-4">
                                <p class="text-sm text-gray-500"><i class="ph-fill ph-sun text-yellow-500 mr-1"></i> "Admiro em voc√™..."</p>
                                <p class="text-gray-800 font-medium italic">"Sua incr√≠vel capacidade de explicar l√≥gica de programa√ß√£o."</p>
                            </div>
                            <div class="mt-3">
                                <p class="text-sm text-gray-500"><i class="ph-fill ph-plant text-green-500 mr-1"></i> "Uma sugest√£o..."</p>
                                <p class="text-gray-800 font-medium italic">"Lembrar de subir o c√≥digo pro GitHub mais cedo."</p>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <p class="text-sm font-medium text-gray-700 mb-2">Presente Recebido (Real):</p>
                                <div class="flex items-center">
                                    <i class="ph-fill ph-gift text-blue-600 text-3xl mr-3"></i>
                                    <div>
                                        <p class="font-bold text-gray-800">Um Kit de Pe√ßas de Rob√≥tica</p>
                                        <p class="text-sm text-gray-600 italic">"Para seus projetos incr√≠veis."</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200 flex space-x-2">
                                <button title="Obrigado!" class="reaction-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-reaction="üôè" data-gift-id="...">üôè</button>
                                <button title="Adorei!" class="reaction-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-reaction="‚ù§Ô∏è" data-gift-id="...">‚ù§Ô∏è</button>
                                <button title="Engra√ßado!" class="reaction-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-reaction="üòÇ" data-gift-id="...">üòÇ</button>
                                <button title="Interessante!" class="reaction-btn p-2 rounded-full hover:bg-gray-200 transition-colors" data-reaction="üí°" data-gift-id="...">üí°</button>
                            </div>
                        </div>
                        -->
                    </div>
                </div>

                <!-- P√ÅGINA 3: MEU PAINEL -->
                <div id="page-stats" class="app-page hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Meu Painel Pessoal</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Badges -->
                        <div class="md:col-span-2 bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Minhas Conquistas (Badges)</h3>
                            <div id="badges-grid" class="flex flex-wrap gap-4">
                                <!-- Badge Ativa (Modelo) -->
                                <!-- <div class="text-center" title="Detetive de Primeira: Acertou o amigo secreto na primeira tentativa.">
                                    <div class="w-20 h-20 rounded-full bg-yellow-400 flex items-center justify-center text-white text-4xl shadow-md">
                                        <i class="ph-bold ph-detective"></i>
                                    </div>
                                    <p class="text-sm font-medium mt-2">Detetive</p>
                                </div> -->
                                <!-- Badge Inativa (Modelo) -->
                                <!-- <div class="text-center opacity-40" title="Perfil Completo: Preencheu todas as perguntas do perfil.">
                                    <div class="w-20 h-20 rounded-full bg-gray-300 flex items-center justify-center text-gray-500 text-4xl">
                                        <i class="ph-bold ph-user"></i>
                                    </div>
                                    <p class="text-sm font-medium mt-2">Perfil Completo</p>
                                </div> -->
                            </div>
                        </div>

                        <!-- Estat√≠sticas -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Minhas Estat√≠sticas</h3>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <span class="font-medium text-gray-700">Rodadas Participadas</span>
                                    <span id="stats-rounds" class="font-bold text-blue-600 text-lg">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <span class="font-medium text-gray-700">Feedbacks Enviados</span>
                                    <span id="stats-sent" class="font-bold text-green-600 text-lg">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <span class="font-medium text-gray-700">Feedbacks Recebidos</span>
                                    <span id="stats-received" class="font-bold text-purple-600 text-lg">0</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                    <span class="font-medium text-gray-700">Rea√ß√µes Recebidas (nos que enviei)</span>
                                    <span id="stats-reactions" class="font-bold text-red-500 text-lg">0 ‚ù§Ô∏è</span>
                                </div>
                            </div>
                        </div>

                        <!-- Qu√£o Enigm√°tico? -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Qu√£o Enigm√°tico(a) eu sou?</h3>
                            <p class="text-gray-600 mb-4">Estat√≠sticas sobre quantas tentativas as pessoas levaram para te adivinhar.</p>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                    <span class="font-medium text-green-800">Adivinhado na 1¬™ Tentativa</span>
                                    <span id="stats-guess-1" class="font-bold text-green-600 text-lg">0 vezes</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                                    <span class="font-medium text-yellow-800">Adivinhado na 2¬™ Tentativa</span>
                                    <span id="stats-guess-2" class="font-bold text-yellow-600 text-lg">0 vezes</span>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                                    <span class="font-medium text-red-800">Adivinhado na 3¬™ Tentativa</span>
                                    <span id="stats-guess-3" class="font-bold text-red-600 text-lg">0 vezes</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- P√ÅGINA 4: MURAL DE DICAS -->
                <div id="page-tips" class="app-page hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800">Mural de Dicas</h2>
                            <p class="text-gray-600 mt-1">Veja dicas an√¥nimas extras ou poste a sua (ap√≥s aprova√ß√£o do admin).</p>
                        </div>
                        <button id="add-tip-btn" class="mt-4 md:mt-0 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                            <i class="ph-bold ph-plus mr-1"></i>
                            Postar minha dica
                        </button>
                    </div>
                    <div id="tips-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Estado Vazio -->
                        <div id="tips-empty-state" class="hidden md:col-span-2 lg:col-span-3 text-center bg-white p-8 rounded-2xl shadow-lg">
                            <i class="ph-bold ph-lightbulb-filament text-gray-400 text-6xl mx-auto"></i>
                            <h3 class="text-2xl font-bold mt-4">Mural Vazio</h3>
                            <p class="text-gray-600 mt-2 max-w-lg mx-auto">Nenhuma dica extra foi postada (ou aprovada) ainda. Seja o primeiro!</p>
                        </div>
                        <!-- Modelo de Card de Dica -->
                        <!-- 
                        <div class="bg-white p-6 rounded-2xl shadow-lg card-container">
                            <div class="card-inner relative w-full h-full">
                                <div class="card-front absolute w-full h-full flex flex-col items-center justify-center text-center p-4 bg-white rounded-2xl">
                                    <i class="ph-bold ph-question text-blue-600 text-6xl"></i>
                                    <p class="text-lg font-medium mt-2">Dica An√¥nima</p>
                                    <p class="text-sm text-gray-500 mt-2">(Passe o mouse para revelar)</p>
                                </div>
                                <div class="card-back absolute w-full h-full p-6 bg-blue-50 rounded-2xl">
                                    <p class="text-lg font-medium text-blue-800 italic">"Minha s√©rie favorita √© de um universo 'bem, bem distante'..."</p>
                                </div>
                            </div>
                        </div>
                         -->
                    </div>
                </div>

                <!-- P√ÅGINA 5: MURAL DE AGRADECIMENTOS -->
                <div id="page-thanks" class="app-page hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800">Mural de Agradecimentos</h2>
                            <p class="text-gray-600 mt-1">Deixe uma mensagem (n√£o-an√¥nima) de agradecimento para a turma.</p>
                        </div>
                        <button id="add-thanks-btn" class="mt-4 md:mt-0 bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition duration-300">
                            <i class="ph-bold ph-heart mr-1"></i>
                            Deixar Agradecimento
                        </button>
                    </div>

                    <!-- Estado Desativado -->
                    <div id="thanks-disabled-state" class="hidden text-center bg-white p-8 rounded-2xl shadow-lg">
                        <i class="ph-bold ph-lock-key text-gray-400 text-6xl mx-auto"></i>
                        <h3 class="text-2xl font-bold mt-4">Mural Trancado</h3>
                        <p class="text-gray-600 mt-2 max-w-lg mx-auto">O administrador ainda n√£o liberou o Mural de Agradecimentos. Ele geralmente √© liberado ap√≥s a √∫ltima rodada da brincadeira.</p>
                    </div>

                    <!-- Lista de Agradecimentos -->
                    <div id="thanks-list" class="hidden space-y-4">
                        <!-- Modelo de Card de Agradecimento -->
                        <!-- 
                        <div class="bg-white p-5 rounded-2xl shadow-lg flex items-start space-x-4">
                            <div class="w-12 h-12 rounded-full bg-green-600 flex items-center justify-center text-white text-2xl font-bold">
                                <span>JP</span>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800">Jo√£o Pedro</p>
                                <p class="text-gray-700 mt-1 italic">"Gente, adorei os feedbacks! Foi muito legal conhecer mais de voc√™s. Obrigado por tudo!"</p>
                                <p class="text-xs text-gray-400 mt-2">10 de Nov, 14:30</p>
                            </div>
                        </div>
                        -->
                    </div>
                </div>

            </main>
        </div>

        <!-- MODAIS -->

        <!-- Modal: Perfil do Usu√°rio -->
        <div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white w-full max-w-lg rounded-2xl shadow-xl overflow-hidden">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800">Meu Perfil</h2>
                    <button id="close-profile-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="ph-bold ph-x text-2xl"></i>
                    </button>
                </div>
                <form id="profile-form" class="p-6 space-y-4">
                    <div class="text-center">
                        <p class="text-sm font-medium text-gray-700 mb-2">Meu Avatar (Emoji)</p>
                        <div class="flex justify-center space-x-2">
                            <button type="button" class="profile-avatar-btn text-3xl p-2 rounded-lg" data-emoji="üë§">üë§</button>
                            <button type="button" class="profile-avatar-btn text-3xl p-2 rounded-lg" data-emoji="üòé">üòé</button>
                            <button type="button" class="profile-avatar-btn text-3xl p-2 rounded-lg" data-emoji="üöÄ">üöÄ</button>
                            <button type="button" class="profile-avatar-btn text-3xl p-2 rounded-lg" data-emoji="üí°">üí°</button>
                            <button type="button" class="profile-avatar-btn text-3xl p-2 rounded-lg" data-emoji="ü§ñ">ü§ñ</button>
                            <button type="button" class="profile-avatar-btn text-3xl p-2 rounded-lg" data-emoji="üß†">üß†</button>
                        </div>
                        <div class="flex justify-center space-x-2 mt-2"> <!-- Nova linha de emojis -->
                            <button type="button" class="profile-avatar-btn text-3xl p-2 rounded-lg" data-emoji="üéì">üéì</button>
                            <button type="button" class="profile-avatar-btn text-3xl p-2 rounded-lg" data-emoji="üíª">üíª</button>
                            <button type="button" class="profile-avatar-btn text-3xl p-2 rounded-lg" data-emoji="üéÆ">üéÆ</button>
                            <button type="button" class="profile-avatar-btn text-3xl p-2 rounded-lg" data-emoji="üé®">üé®</button>
                            <button type="button" class="profile-avatar-btn text-3xl p-2 rounded-lg" data-emoji="üß™">üß™</button>
                            <button type="button" class="profile-avatar-btn text-3xl p-2 rounded-lg" data-emoji="ü¶â">ü¶â</button>
                        </div>
                        <input type="hidden" id="profile-avatar" value="üë§">
                    </div>

                    <div class="text-center">
                        <p class="text-sm font-medium text-gray-700 mb-2">Minha Cor Tema</p>
                        <div class="flex justify-center space-x-2">
                            <button type="button" class="profile-color-btn w-10 h-10 rounded-full bg-blue-600" data-theme="theme-blue"></button>
                            <button type="button" class="profile-color-btn w-10 h-10 rounded-full bg-green-700" data-theme="theme-green"></button>
                            <button type="button" class="profile-color-btn w-10 h-10 rounded-full bg-purple-700" data-theme="theme-purple"></button>
                            <button type="button" class="profile-color-btn w-10 h-10 rounded-full bg-red-600" data-theme="theme-red"></button>
                            <button type="button" class="profile-color-btn w-10 h-10 rounded-full bg-yellow-600" data-theme="theme-yellow"></button>
                        </div>
                        <input type="hidden" id="profile-theme" value="theme-blue">
                    </div>

                    <hr class="pt-2">

                    <div>
                        <label for="profile-q1" class="block text-sm font-medium text-gray-700 mb-1">Se voc√™ pudesse criar um aplicativo para resolver qualquer problema do mundo, o que ele faria?</label>
                        <textarea id="profile-q1" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Descreva sua ideia..."></textarea>
                    </div>
                    <div>
                        <label for="profile-q2" class="block text-sm font-medium text-gray-700 mb-1">Qual tecnologia (real ou fict√≠cia) voc√™ mais gostaria de ter no seu dia-a-dia e por qu√™?</label>
                        <textarea id="profile-q2" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Ex: Teletransporte, um rob√¥ assistente..."></textarea>
                    </div>
                    <div>
                        <label for="profile-q3" class="block text-sm font-medium text-gray-700 mb-1">Qual foi a coisa mais interessante ou surpreendente que voc√™ descobriu/aprendeu usando a tecnologia esta semana?</label>
                        <textarea id="profile-q3" rows="3" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Pode ser um atalho, um app novo, uma not√≠cia..."></textarea>
                    </div>

                    <div class="pt-4 flex justify-end">
                        <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition duration-300">
                            Salvar Perfil
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal: Painel Admin -->
        <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white w-full max-w-4xl h-[90vh] rounded-2xl shadow-xl flex flex-col">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800">Painel do Administrador</h2>
                    <button id="close-admin-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="ph-bold ph-x text-2xl"></i>
                    </button>
                </div>

                <!-- Tela 1: Senha Admin -->
                <div id="admin-password-screen" class="p-6 flex-1 flex flex-col items-center justify-center text-center">
                    <i class="ph-bold ph-shield-check text-blue-600 text-6xl"></i>
                    <h3 id="admin-password-title" class="text-xl font-bold mt-4">Definir Senha de Admin da Turma</h3>
                    <p class="text-gray-600 mt-1 max-w-sm mx-auto">Esta senha ser√° usada por qualquer administrador desta turma.</p>
                    <form id="admin-password-form" class="mt-6 w-full max-w-sm">
                        <label for="admin-password-input" class="block text-sm font-medium text-gray-700 mb-1 text-left">Senha</label>
                        <input type="password" id="admin-password-input" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <p id="admin-password-error" class="text-red-500 text-sm text-center mt-2"></p>
                        <button type="submit" class="w-full mt-4 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                            Entrar
                        </button>
                    </form>
                </div>

                <!-- Tela 2: Painel Principal Admin -->
                <div id="admin-dashboard" class="hidden flex-1 p-6 space-y-6 overflow-y-auto">
                    <!-- A√ß√µes da Rodada -->
                    <div class="bg-gray-50 p-6 rounded-2xl shadow-md">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Gerenciamento da Rodada</h3>
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="flex-1">
                                <p class="text-sm font-medium">Rodada Atual: <span id="admin-current-round" class="font-bold text-blue-600">0</span></p>
                                <p class="text-sm font-medium">Estado: <span id="admin-game-status" class="font-bold text-gray-700">Aguardando</span></p>
                            </div>
                            <div class="flex-1 flex flex-col md:flex-row gap-4">
                                <button id="admin-start-round-btn" class="flex-1 bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition duration-300">
                                    <i class="ph-bold ph-play-circle mr-1"></i> Iniciar Rodada
                                </button>
                                <button id="admin-release-gifts-btn" disabled class="flex-1 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    <i class="ph-bold ph-gift mr-1"></i> Liberar Presentes
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Progresso da Turma -->
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Progresso da Turma (<span id="admin-round-progress-text">0/0</span>)</h3>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div id="admin-round-progress-bar" class="bg-green-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div id="admin-participants-list" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Modelo de Card de Participante -->
                            <!-- <div class="bg-white p-4 rounded-lg shadow flex items-center justify-between">
                                <span class="font-medium">Aluno Exemplo</span>
                                <span class="text-sm font-bold text-green-600">Completo</span>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow flex items-center justify-between">
                                <span class="font-medium">Outro Aluno</span>
                                <span class="text-sm font-bold text-red-600">Pendente</span>
                            </div> -->
                        </div>
                    </div>

                    <!-- Nuvem de Palavras -->
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Nuvem de Palavras (Feedbacks Positivos)</h3>
                        <div class="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center">
                            <canvas id="word-cloud-canvas" width="600" height="250">Seu navegador n√£o suporta canvas.</canvas>
                        </div>
                    </div>

                    <!-- Gerenciamento (Dicas, Agradecimentos) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Mural de Dicas -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Aprovar Dicas do Mural</h3>
                            <div id="admin-tips-list" class="space-y-3 max-h-64 overflow-y-auto">
                                <p id="admin-tips-empty" class="text-gray-500 text-center p-4">Nenhuma dica pendente.</p>
                                <!-- Modelo de Dica Pendente -->
                                <!-- 
                                <div class="bg-gray-50 p-3 rounded-lg flex items-center justify-between">
                                    <span class="italic text-gray-700">"Minha cor favorita √© azul..."</span>
                                    <div class="flex space-x-2">
                                        <button class="text-green-600 hover:text-green-800"><i class="ph-bold ph-check-circle text-2xl"></i></button>
                                        <button class="text-red-600 hover:text-red-800"><i class="ph-bold ph-x-circle text-2xl"></i></button>
                                    </div>
                                </div>
                                 -->
                            </div>
                        </div>
                        <!-- Outras A√ß√µes -->
                        <div class="bg-white p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Outras A√ß√µes</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <label for="admin-toggle-thanks" class="font-medium text-gray-700">Mural de Agradecimentos</label>
                                    <button id="admin-toggle-thanks-btn" class="px-4 py-2 rounded-lg font-bold text-sm bg-red-100 text-red-700">
                                        Liberar
                                    </button>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                    <label for="admin-grant-badge" class="font-medium text-gray-700">Dar Badge "Escritor de Ouro"</label>
                                    <button id="admin-grant-badge-btn" class="px-4 py-2 rounded-lg font-bold text-sm bg-yellow-100 text-yellow-700">
                                        Conceder
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal: Gen√©rico (Postar Dica, Agradecimento, Quiz, etc.) -->
        <div id="generic-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white w-full max-w-lg rounded-2xl shadow-xl">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h2 id="generic-modal-title" class="text-2xl font-bold text-gray-800">...</h2>
                    <button id="close-generic-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="ph-bold ph-x text-2xl"></i>
                    </button>
                </div>
                <div id="generic-modal-body" class="p-6">
                    <!-- Conte√∫do din√¢mico ser√° injetado aqui -->
                </div>
            </div>
        </div>

    </div> <!-- Fim do #app -->


    <!-- =================================================================================== -->
    <!-- JAVASCRIPT -->
    <!-- =================================================================================== -->
    <script type="module">
        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            addDoc,
            updateDoc,
            onSnapshot,
            collection,
            query,
            where,
            writeBatch,
            arrayUnion,
            getDocs,
            runTransaction,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===== CONFIGURA√á√ÉO DO FIREBASE =====
        // COLE A CONFIGURA√á√ÉO DO SEU PROJETO AQUI
        const firebaseConfig = {
            apiKey: "AIzaSyDnqK4Hx-Y_Hr9_Cc5oKD9g6RTZSe-eBTA",
            authDomain: "conexao-secreta.firebaseapp.com",
            projectId: "conexao-secreta",
            storageBucket: "conexao-secreta.firebasestorage.app",
            messagingSenderId: "156846006416",
            appId: "1:156846006416:web:9e87f70a3afe9e8264b815",
            measurementId: "G-G4KFHMMCTJ"
        };
        // ===================================
 
        // Inicializa√ß√£o do Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            // setLogLevel('debug'); // Descomente para logs detalhados do Firestore
        } catch (error) {
            console.error("Erro ao inicializar o Firebase:", error);
            el('loading-spinner').innerHTML = '<p class="text-red-500 p-4">Erro Cr√≠tico: Falha ao carregar a configura√ß√£o do Firebase. Verifique seu `firebaseConfig`.</p>';
            // A linha 'return;' foi removida daqui
        }


        // Vari√°veis de estado global
        let currentUser = null;
        let userData = null;
        let currentTurmaData = null;
        let unsubscribeUser = null; // Listener para dados do usu√°rio
        let unsubscribeTurma = null; // Listener para dados da turma
        let unsubscribeTips = null; // Listener para dicas
        let unsubscribeThanks = null; // Listener para agradecimentos
        let unsubscribeGifts = null; // Listener para presentes
        let adminPasswordVerified = false;
        let targetNameHiddenTimeout = null;
        let currentQuizQuestion = 0;
        let quizScore = 0;

        // Seletor de Elementos (atalho)
        const el = (id) => document.getElementById(id);
        const qsa = (selector) => document.querySelectorAll(selector);

        // Defini√ß√£o das Badges (para f√°cil consulta)
        const allBadges = {
            'detetive': { icon: 'detective', name: 'Detetive de Primeira', desc: 'Acertou o amigo secreto na primeira tentativa.' },
            'escritor': { icon: 'scroll', name: 'Escritor(a) de Ouro', desc: 'Concedido pelo Admin pelo feedback mais construtivo.' },
            'turma-unida': { icon: 'users-three', name: 'Turma Unida', desc: 'Concedido a todos quando 100% da turma envia os feedbacks.' },
            'veterano': { icon: 'medal', name: 'Veterano(a) da Conex√£o', desc: 'Completou 3 (ou mais) rodadas.' },
            'queridinho': { icon: 'heart', name: 'Queridinho(a) An√¥nimo(a)', desc: 'Recebeu 5+ rea√ß√µes positivas nos feedbacks que *escreveu*.' },
            'enigma': { icon: 'puzzle-piece', name: 'Mestre do Enigma', desc: 'Seu perfil foi o mais dif√≠cil de adivinhar na rodada.' },
            'observador': { icon: 'binoculars', name: 'O(A) Observador(a)', desc: 'Usou o "Mural de Dicas" para ajudar na adivinha√ß√£o.' },
            'perfil-completo': { icon: 'user-check', name: 'Perfil Completo', desc: 'Preencheu todas as perguntas do perfil.' },
            'sabe-tudo': { icon: 'brain', name: 'Sabe-Tudo', desc: 'Acertou 5 (ou mais) perguntas no "Quiz Surpresa".' }
        };

        // Banco de Quest√µes do Quiz (Tecnologia da Informa√ß√£o)
        const quizQuestions = [
            { q: "Qual componente √© considerado o 'c√©rebro' do computador?", a: ["CPU", "RAM", "HD", "Placa-m√£e"], correct: 0 },
            { q: "O que significa 'IoT'?", a: ["Internet of Things", "Internet of Threats", "Input/Output Transfer", "Internal Office Tech"], correct: 0 },
            { q: "Qual destes N√ÉO √© um software de planilha eletr√¥nica?", a: ["Excel", "Google Sheets", "PowerPoint", "LibreOffice Calc"], correct: 2 },
            { q: "O que √© 'Phishing'?", a: ["Um tipo de v√≠rus", "Uma falha de hardware", "Uma t√©cnica para roubar senhas fingindo ser um site confi√°vel", "Uma linguagem de programa√ß√£o"], correct: 2 },
            { q: "Qual a fun√ß√£o principal de um 'Firewall'?", a: ["Acelerar a internet", "Monitorar e filtrar o tr√°fego de rede", "Armazenar arquivos", "Limpar v√≠rus"], correct: 1 },
            { q: "O que significa 'URL'?", a: ["Universal Resource Locator", "User Registration Link", "Uniform Readme Language", "Upload/Retrieve Link"], correct: 0 },
            { q: "Em Word ou Google Docs, qual atalho salva o documento?", a: ["Ctrl+P", "Ctrl+C", "Ctrl+S", "Ctrl+V"], correct: 2 },
            { q: "O que √© 'Software Livre'?", a: ["Um software gratuito", "Um software que pode ser usado, copiado, estudado e modificado livremente", "Um software de c√≥digo-fonte aberto, mas pago", "Um software que n√£o precisa de instala√ß√£o"], correct: 1 },
            { q: "Qual destes √© um exemplo de 'Hardware'?", a: ["Sistema Operacional", "Navegador Chrome", "Mouse", "Microsoft Word"], correct: 2 },
            { q: "O que √© 'HTTPS'?", a: ["Um tipo de cabo de rede", "Um protocolo de internet mais r√°pido", "Uma vers√£o segura do protocolo HTTP", "Uma linguagem de design"], correct: 2 }
        ].sort(() => 0.5 - Math.random()); // Embaralha as perguntas

        // ===================================================================================
        // 1. INICIALIZA√á√ÉO
        // ===================================================================================

        // Ponto de entrada principal
        document.addEventListener('DOMContentLoaded', () => {
            // CORRE√á√ÉO: As fun√ß√µes de setup estavam faltando aqui, impedindo o app de iniciar.
            setupAuthHandlers();
            setupNavigation();
            setupModals();
            setupProfileForm();
            setupFeedbackForm();
        });


        // Observador de Autentica√ß√£o (O "Cora√ß√£o" do App)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usu√°rio est√° logado
                currentUser = user;
                // Desinscrever-se de listeners antigos se existirem
                clearAllListeners();

                // Iniciar listener para dados do usu√°rio
                const userRef = doc(db, 'users', user.uid);
                unsubscribeUser = onSnapshot(userRef, (docSnap) => {
                    if (docSnap.exists()) {
                        userData = { id: docSnap.id, ...docSnap.data() };
                        startAppListeners(); // Inicia os listeners da turma
                        updateUIAfterLogin(); // Atualiza a UI
                    } else {
                        // Isso pode acontecer se o cadastro falhou em criar o doc
                        console.warn("Usu√°rio logado mas sem documento no Firestore. Tentando criar...");
                        // (L√≥gica de fallback, mas o formul√°rio de cadastro j√° deve fazer isso)
                    }
                }, (error) => {
                    console.error("Erro ao ouvir dados do usu√°rio:", error);
                    showAuthError("Erro ao carregar seus dados. Tente recarregar a p√°gina.");
                    el('loading-spinner').classList.add('hidden');
                });

            } else {
                // Usu√°rio est√° deslogado
                currentUser = null;
                userData = null;
                clearAllListeners();
                showAuthScreen();
                // CORRE√á√ÉO: Esconder o spinner se o usu√°rio estiver deslogado
                el('loading-spinner').classList.add('hidden');
            }
        });

        // ===================================================================================
        // 2. FUN√á√ïES DE AUTENTICA√á√ÉO E NAVEGA√á√ÉO
        // ===================================================================================

        function setupAuthHandlers() {
            // Alternar abas
            el('tab-login').addEventListener('click', () => {
                el('tab-login').classList.add('text-blue-600', 'border-blue-600');
                el('tab-register').classList.remove('text-blue-600', 'border-blue-600');
                el('login-form').classList.remove('hidden');
                el('register-form').classList.add('hidden');
                showAuthError('');
            });
            el('tab-register').addEventListener('click', () => {
                el('tab-register').classList.add('text-blue-600', 'border-blue-600');
                el('tab-login').classList.remove('text-blue-600', 'border-blue-600');
                el('register-form').classList.remove('hidden');
                el('login-form').classList.add('hidden');
                showAuthError('');
            });

            // Handler de Login
            el('login-form').addEventListener('submit', async(e) => {
                e.preventDefault();
                showAuthError('');
                const email = el('login-email').value;
                const password = el('login-password').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // SUCESSO: onAuthStateChanged vai cuidar da mudan√ßa de tela
                    // CORRE√á√ÉO: For√ßar mudan√ßa de tela para evitar "tela presa"
                    el('auth-screen').classList.add('hidden');
                    el('loading-spinner').classList.remove('hidden');

                } catch (error) {
                    console.error("Erro de login:", error.code);
                    showAuthError(getFriendlyAuthError(error.code));
                }
            });

            // Handler de Cadastro
            el('register-form').addEventListener('submit', async(e) => {
                e.preventDefault();
                showAuthError('');
                const email = el('register-email').value;
                const password = el('register-password').value;
                const name = el('register-name').value;
                const turma = el('register-turma').value;

                if (!name || !turma) {
                    showAuthError("Nome e Turma s√£o obrigat√≥rios.");
                    return;
                }

                try {
                    // 1. Criar o usu√°rio no Auth
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // 2. Atualizar o perfil do Auth (nome)
                    await updateProfile(user, { displayName: name });

                    // 3. Criar o documento do usu√°rio no Firestore
                    const userRef = doc(db, 'users', user.uid);
                    const newUserDoc = {
                        uid: user.uid,
                        name: name,
                        email: email,
                        turma: turma,
                        profile: {
                            avatar: "üë§",
                            theme: "theme-blue",
                            q1: "",
                            q2: "",
                            q3: ""
                        },
                        badges: [],
                        stats: {
                            rounds: 0,
                            sent: 0,
                            received: 0,
                            reactions: 0,
                            guess1: 0,
                            guess2: 0,
                            guess3: 0
                        },
                        currentGame: {
                            target: null, // ID do alvo
                            targetName: null, // Nome do alvo (ap√≥s acertar)
                            guesses: 3,
                            status: 'pending' // pending, guessing, feedback, done
                        },
                        gameHistory: [] // { round, targetId, feedbackSent }
                    };
                    await setDoc(userRef, newUserDoc);

                    // 4. (Opcional) Criar doc da turma se n√£o existir
                    const turmaRef = doc(db, 'turmas', turma);
                    await setDoc(turmaRef, {
                        turmaId: turma,
                        game: {
                            round: 0,
                            status: 'waiting', // waiting, running, revealing
                            thanksMuralEnabled: false,
                        },
                        adminPassword: null // Primeira pessoa a setar vira admin
                    }, { merge: true }); // Merge para n√£o sobrescrever

                    // SUCESSO: onAuthStateChanged vai cuidar da mudan√ßa de tela

                } catch (error) {
                    console.error("Erro de cadastro:", error.code);
                    showAuthError(getFriendlyAuthError(error.code));
                }
            });

            // Handler de Logout
            el('nav-logout').addEventListener('click', async() => {
                try {
                    await signOut(auth);
                    // onAuthStateChanged vai cuidar da mudan√ßa de tela
                    showAuthScreen();
                } catch (error) {
                    console.error("Erro no logout:", error);
                }
            });
        }

        function setupNavigation() {
            // Navega√ß√£o por Abas
            qsa('.nav-tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const targetPageId = button.dataset.target;

                    // Esconder todas as p√°ginas
                    qsa('.app-page').forEach(page => page.classList.add('hidden'));
                    // Mostrar a p√°gina alvo
                    el(targetPageId).classList.remove('hidden');

                    // Atualizar estilo das abas
                    qsa('.nav-tab-button').forEach(btn => {
                        btn.classList.remove('text-blue-600', 'border-blue-600');
                        btn.classList.add('text-gray-600', 'hover:text-black');
                    });
                    button.classList.add('text-blue-600', 'border-blue-600');
                    button.classList.remove('text-gray-600', 'hover:text-black');
                });
            });

            // Bot√£o "Ir para Perfil"
            el('go-to-profile-btn').addEventListener('click', () => {
                el('profile-modal').classList.remove('hidden');
            });
        }

        // Limpa todos os listeners do Firestore (ao deslogar ou trocar de usu√°rio)
        function clearAllListeners() {
            if (unsubscribeUser) unsubscribeUser();
            if (unsubscribeTurma) unsubscribeTurma();
            if (unsubscribeTips) unsubscribeTips();
            if (unsubscribeThanks) unsubscribeThanks();
            if (unsubscribeGifts) unsubscribeGifts();
        }

        // Inicia os listeners espec√≠ficos da turma
        function startAppListeners() {
            if (!userData || !userData.turma) return;

            // 1. Listener da Turma
            const turmaRef = doc(db, 'turmas', userData.turma);
            unsubscribeTurma = onSnapshot(turmaRef, (docSnap) => {
                currentTurmaData = docSnap.data();
                updateUIBasedOnTurma(); // Atualiza UI do admin, estado do jogo, etc.
            });

            // 2. Listener de Dicas (Mural de Dicas)
            const tipsQuery = query(collection(db, 'turmas', userData.turma, 'tips'), where("approved", "==", true));
            unsubscribeTips = onSnapshot(tipsQuery, (querySnapshot) => {
                const tips = [];
                querySnapshot.forEach((doc) => {
                    tips.push(doc.data());
                });
                renderTipsMural(tips);
            });

            // 3. Listener de Agradecimentos
            const thanksQuery = query(collection(db, 'turmas', userData.turma, 'thanks'));
            unsubscribeThanks = onSnapshot(thanksQuery, (querySnapshot) => {
                const thanks = [];
                querySnapshot.forEach((doc) => {
                    thanks.push(doc.data());
                });
                renderThanksMural(thanks);
            });

            // 4. Listener de Presentes (Minha Estante)
            const giftsQuery = query(collection(db, 'users', currentUser.uid, 'receivedGifts'));
            unsubscribeGifts = onSnapshot(giftsQuery, (querySnapshot) => {
                const gifts = [];
                querySnapshot.forEach((doc) => {
                    gifts.push({ id: doc.id, ...doc.data() });
                });
                renderGiftsList(gifts);
            });
        }

        function showAuthScreen() {
            el('auth-screen').classList.remove('hidden');
            el('main-app').classList.add('hidden');
            el('loading-spinner').classList.add('hidden');
        }

        function updateUIAfterLogin() {
            el('loading-spinner').classList.add('hidden');
            el('auth-screen').classList.add('hidden');
            el('main-app').classList.remove('hidden');

            // Preencher dados do usu√°rio
            el('nav-turma').textContent = userData.turma;
            document.body.className = `bg-gray-100 text-gray-900 antialiased ${userData.profile.theme}`;

            // Renderizar pain√©is
            renderMyStats();
            renderBadges();
            updateGameUI(); // Atualiza a tela principal do jogo
        }

        // Atualiza a UI com base nos dados da turma (estado do jogo)
        function updateUIBasedOnTurma() {
            if (!currentTurmaData || !userData) return;

            // Atualiza o painel de Agradecimentos
            if (currentTurmaData.game.thanksMuralEnabled) {
                el('thanks-disabled-state').classList.add('hidden');
                el('thanks-list').classList.remove('hidden');
                el('add-thanks-btn').classList.remove('hidden');
            } else {
                el('thanks-disabled-state').classList.remove('hidden');
                el('thanks-list').classList.add('hidden');
                el('add-thanks-btn').classList.add('hidden');
            }

            // Atualiza o painel Admin (se estiver aberto)
            if (adminPasswordVerified) {
                renderAdminDashboard();
            }

            // Atualiza a UI principal do Jogo
            updateGameUI();
        }

        function getFriendlyAuthError(code) {
            switch (code) {
                case 'auth/invalid-email':
                    return 'Email inv√°lido.';
                case 'auth/user-not-found':
                    return 'Usu√°rio n√£o encontrado. Verifique o email.';
                case 'auth/wrong-password':
                    return 'Senha incorreta.';
                case 'auth/email-already-in-use':
                    return 'Este email j√° est√° cadastrado.';
                case 'auth/weak-password':
                    return 'Senha muito fraca. Use pelo menos 6 caracteres.';
                default:
                    return 'Ocorreu um erro. Tente novamente.';
            }
        }

        function showAuthError(message) {
            el('auth-error').textContent = message;
        }

        // ===================================================================================
        // 3. MODAIS E FORMUL√ÅRIOS
        // ===================================================================================

        function setupModals() {
            // Modal de Perfil
            el('nav-profile').addEventListener('click', () => {
                loadProfileForm();
                el('profile-modal').classList.remove('hidden');
            });
            el('close-profile-modal').addEventListener('click', () => {
                el('profile-modal').classList.add('hidden');
            });

            // Modal Admin
            el('nav-admin').addEventListener('click', () => {
                el('admin-modal').classList.remove('hidden');
                if (adminPasswordVerified) {
                    renderAdminDashboard();
                    el('admin-password-screen').classList.add('hidden');
                    el('admin-dashboard').classList.remove('hidden');
                } else {
                    el('admin-password-screen').classList.remove('hidden');
                    el('admin-dashboard').classList.add('hidden');
                    // Checar se a senha j√° foi definida
                    if (currentTurmaData && currentTurmaData.adminPassword) {
                        el('admin-password-title').textContent = "Acessar Painel Admin";
                    } else {
                        el('admin-password-title').textContent = "Definir Senha de Admin da Turma";
                    }
                }
            });
            el('close-admin-modal').addEventListener('click', () => {
                el('admin-modal').classList.add('hidden');
            });
            el('admin-password-form').addEventListener('submit', handleAdminLogin);

            // Modal Gen√©rico (Dicas, Quiz, etc.)
            el('close-generic-modal').addEventListener('click', () => {
                el('generic-modal').classList.add('hidden');
            });
            el('add-tip-btn').addEventListener('click', showAddTipModal);
            el('add-thanks-btn').addEventListener('click', showAddThanksModal);
            el('start-quiz-btn').addEventListener('click', showQuizModal);
            el('admin-grant-badge-btn').addEventListener('click', showGrantBadgeModal);
        }

        // ---- Perfil do Usu√°rio ----
        function setupProfileForm() {
            // Sele√ß√£o de Avatar
            qsa('.profile-avatar-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const emoji = e.currentTarget.dataset.emoji;
                    el('profile-avatar').value = emoji;
                    // Estilo de sele√ß√£o
                    qsa('.profile-avatar-btn').forEach(b => b.classList.remove('bg-gray-200', 'ring-2', 'ring-blue-500'));
                    e.currentTarget.classList.add('bg-gray-200', 'ring-2', 'ring-blue-500');
                });
            });
            // Sele√ß√£o de Cor
            qsa('.profile-color-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const theme = e.currentTarget.dataset.theme;
                    el('profile-theme').value = theme;
                    // Estilo de sele√ß√£o
                    qsa('.profile-color-btn').forEach(b => b.classList.remove('ring-4', 'ring-offset-2', 'ring-blue-500'));
                    e.currentTarget.classList.add('ring-4', 'ring-offset-2', 'ring-blue-500');
                });
            });

            // Salvar Perfil
            el('profile-form').addEventListener('submit', async(e) => {
                e.preventDefault();
                const newProfile = {
                    avatar: el('profile-avatar').value,
                    theme: el('profile-theme').value,
                    q1: el('profile-q1').value,
                    q2: el('profile-q2').value,
                    q3: el('profile-q3').value
                };

                try {
                    const userRef = doc(db, 'users', currentUser.uid);
                    await updateDoc(userRef, { profile: newProfile });

                    // Conceder badge "Perfil Completo"
                    if (newProfile.q1 && newProfile.q2 && newProfile.q3) {
                        await grantBadge(currentUser.uid, 'perfil-completo');
                    }

                    el('profile-modal').classList.add('hidden');
                    // A UI vai se atualizar automaticamente pelo listener onSnapshot (userData)
                } catch (error) {
                    console.error("Erro ao salvar perfil:", error);
                    alert("Erro ao salvar. Tente novamente."); // (Substituir por modal de erro)
                }
            });
        }

        function loadProfileForm() {
            if (!userData) return;
            const profile = userData.profile;

            el('profile-q1').value = profile.q1 || '';
            el('profile-q2').value = profile.q2 || '';
            el('profile-q3').value = profile.q3 || '';
            el('profile-avatar').value = profile.avatar || 'üë§';
            el('profile-theme').value = profile.theme || 'theme-blue';

            // Marcar sele√ß√£o de avatar
            qsa('.profile-avatar-btn').forEach(btn => {
                btn.classList.remove('bg-gray-200', 'ring-2', 'ring-blue-500');
                if (btn.dataset.emoji === profile.avatar) {
                    btn.classList.add('bg-gray-200', 'ring-2', 'ring-blue-500');
                }
            });
            // Marcar sele√ß√£o de cor
            qsa('.profile-color-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-offset-2', 'ring-blue-500');
                if (btn.dataset.theme === profile.theme) {
                    btn.classList.add('ring-4', 'ring-offset-2', 'ring-blue-500');
                }
            });
        }

        // ===================================================================================
        // 4. L√ìGICA PRINCIPAL DO JOGO
        // ===================================================================================

        // Atualiza a tela principal (Minha Rodada) com base no estado do usu√°rio e da turma
        async function updateGameUI() {
            if (!userData || !currentTurmaData) {
                // Se os dados n√£o carregaram, mant√©m o spinner
                el('loading-spinner').classList.remove('hidden');
                return;
            }

            // Esconde todos os estados
            qsa('#page-main > div').forEach(div => div.classList.add('hidden'));

            const userGame = userData.currentGame;
            const turmaGame = currentTurmaData.game;

            // Checagem de Perfil Completo
            const profile = userData.profile;
            const isProfileComplete = profile.q1 && profile.q2 && profile.q3;

            if (turmaGame.status === 'waiting' && userGame.status !== 'done') {
                el('game-state-waiting').classList.remove('hidden');
            } else if (!isProfileComplete && turmaGame.status === 'running' && userGame.status !== 'done') {
                el('game-state-profile-incomplete').classList.remove('hidden');
            } else if (turmaGame.status === 'running' && userGame.status === 'pending') {
                // Usu√°rio ainda n√£o tem um alvo (pode ter acabado de entrar)
                el('game-state-waiting').classList.remove('hidden');
                el('game-state-waiting').querySelector('h2').textContent = "Rodada em Andamento";
                el('game-state-waiting').querySelector('p').textContent = "Voc√™ entrou com a rodada em andamento. Aguarde o administrador te incluir ou a pr√≥xima rodada come√ßar.";
            } else if (turmaGame.status === 'running' && userGame.status === 'guessing') {
                await setupGuessingState();
                el('game-state-guessing').classList.remove('hidden');
            } else if (turmaGame.status === 'running' && userGame.status === 'feedback') {
                setupFeedbackState();
                el('game-state-feedback').classList.remove('hidden');
            } else if (userGame.status === 'done') {
                el('game-state-done').classList.remove('hidden');
            } else {
                // Fallback, deve ser o estado de espera
                el('game-state-waiting').classList.remove('hidden');
            }
        }

        // Configura a tela de Adivinha√ß√£o
        async function setupGuessingState() {
            const targetId = userData.currentGame.target;
            if (!targetId) return;

            try {
                // 1. Buscar o perfil do alvo
                const targetRef = doc(db, 'users', targetId);
                const targetSnap = await getDoc(targetRef);
                if (!targetSnap.exists()) {
                    console.error("Erro: Alvo n√£o encontrado no DB.");
                    return;
                }
                const targetData = targetSnap.data();
                const targetProfile = targetData.profile;

                // 2. Preencher as dicas
                el('target-q1').textContent = targetProfile.q1 || "(N√£o preenchido)";
                el('target-q2').textContent = targetProfile.q2 || "(N√£o preenchido)";
                el('target-q3').textContent = targetProfile.q3 || "(N√£o preenchido)";
                el('target-avatar-emoji').textContent = targetProfile.avatar || '‚ùì';

                // 3. Aplicar o tema de cor do alvo
                const themeClass = targetProfile.theme || 'theme-blue';
                const avatarBG = el('target-avatar-bg');
                avatarBG.className = `w-16 h-16 rounded-full flex items-center justify-center text-4xl mr-4 bg-primary-themed text-white ${themeClass}`;
                qsa('#target-profile .border-l-4').forEach(elem => {
                    elem.className = `border-l-4 border-primary-themed pl-4 py-2 bg-gray-50 rounded-r-lg mt-4 ${themeClass}`;
                });


                // 4. Preencher o select de palpites
                const usersQuery = query(collection(db, 'users'), where('turma', '==', userData.turma));
                const querySnapshot = await getDocs(usersQuery);
                const select = el('guess-select');
                select.innerHTML = '<option value="">Selecione um nome...</option>';
                querySnapshot.forEach(docSnap => {
                    const user = docSnap.data();
                    if (user.uid !== currentUser.uid) { // N√£o pode chutar a si mesmo
                        const option = document.createElement('option');
                        option.value = user.uid;
                        option.textContent = user.name;
                        select.appendChild(option);
                    }
                });

                // 5. Atualizar tentativas
                el('guess-attempts-left').textContent = userData.currentGame.guesses;

                // 6. Mostrar anima√ß√£o de sorteio (se for a primeira vez)
                if (userData.currentGame.guesses === 3) {
                    el('draw-animation').classList.remove('hidden');
                    setTimeout(() => {
                        el('draw-animation').classList.add('hidden');
                    }, 4000);
                }

                // 7. Adicionar listener ao formul√°rio
                el('guess-form').onsubmit = handleGuessSubmit;

            } catch (error) {
                console.error("Erro ao configurar estado de adivinha√ß√£o:", error);
            }
        }

        // Handler para envio de palpite
        async function handleGuessSubmit(e) {
            e.preventDefault();
            el('guess-error').textContent = '';
            const guessedId = el('guess-select').value;
            const targetId = userData.currentGame.target;

            if (!guessedId) {
                el('guess-error').textContent = 'Voc√™ precisa selecionar um nome.';
                return;
            }

            const userRef = doc(db, 'users', currentUser.uid);
            let newGuesses = userData.currentGame.guesses - 1;

            // Conceder badge "Observador"
            if (currentTurmaData.tips.length > 0) {
                await grantBadge(currentUser.uid, 'observador');
            }

            if (guessedId === targetId) {
                // ACERTOU!
                try {
                    // Buscar nome do alvo para mostrar
                    const targetSnap = await getDoc(doc(db, 'users', targetId));
                    const targetName = targetSnap.data().name;

                    // Registrar estat√≠stica de adivinha√ß√£o no *alvo*
                    const targetRef = doc(db, 'users', targetId);
                    let guessField;
                    if (newGuesses === 2) guessField = 'stats.guess1'; // Acertou na 1¬™
                    else if (newGuesses === 1) guessField = 'stats.guess2'; // Acertou na 2¬™
                    else guessField = 'stats.guess3'; // Acertou na 3¬™

                    // Usar transa√ß√£o para incrementar
                    await runTransaction(db, async(transaction) => {
                        const targetDoc = await transaction.get(targetRef);
                        if (!targetDoc.exists()) throw "Alvo n√£o existe";
                        const currentGuessCount = targetDoc.data().stats[guessField.split('.')[1]] || 0;
                        transaction.update(targetRef, {
                            [guessField]: currentGuessCount + 1
                        });
                    });

                    // Conceder badge "Detetive de Primeira"
                    if (newGuesses === 2) {
                        await grantBadge(currentUser.uid, 'detetive');
                    }
                    // Conceder badge "Mestre do Enigma" (se foi na √∫ltima)
                    if (newGuesses === 0) {
                        await grantBadge(targetId, 'enigma');
                    }

                    // Atualizar estado do usu√°rio
                    await updateDoc(userRef, {
                        'currentGame.status': 'feedback',
                        'currentGame.targetName': targetName,
                        'currentGame.guesses': newGuesses
                    });
                    // UI ser√° atualizada pelo onSnapshot

                } catch (error) {
                    console.error("Erro ao processar acerto:", error);
                }

            } else {
                // ERROU!
                el('guess-error').textContent = 'N√£o foi dessa vez! Tente de novo.';
                await updateDoc(userRef, {
                    'currentGame.guesses': newGuesses
                });

                if (newGuesses === 0) {
                    // Acabaram as tentativas (travar ou pedir dica? Por enquanto, trava)
                    el('guess-error').textContent = 'Suas tentativas acabaram! O nome correto ser√° revelado em breve.';
                    // (L√≥gica futura: admin revela ou espera a rodada acabar)
                    // Por enquanto, apenas bloqueia o form
                    el('guess-select').disabled = true;
                    el('guess-form').querySelector('button').disabled = true;
                }
                // UI de tentativas ser√° atualizada pelo onSnapshot
            }
        }

        // Configura a tela de Feedback
        function setupFeedbackState() {
            const targetName = userData.currentGame.targetName;
            el('target-name').textContent = targetName;

            // Esconde o nome ap√≥s 10 segundos
            if (targetNameHiddenTimeout) clearTimeout(targetNameHiddenTimeout);
            targetNameHiddenTimeout = setTimeout(() => {
                el('target-name').textContent = "[Oculto por Privacidade]";
            }, 10000);

            // Adiciona listener ao formul√°rio
            el('feedback-form').onsubmit = handleFeedbackSubmit;
        }

        // L√≥gica de escolha de tipo de presente
        function setupFeedbackForm() {
            el('gift-type-real').addEventListener('change', () => {
                el('gift-real-box').classList.remove('hidden');
                el('gift-joke-box').classList.add('hidden');
                el('feedback-gift-real').required = true;
                el('feedback-gift-real-reason').required = true;
                el('feedback-gift-joke').required = false;
                el('feedback-gift-joke-reason').required = false;
            });
            el('gift-type-joke').addEventListener('change', () => {
                el('gift-joke-box').classList.remove('hidden');
                el('gift-real-box').classList.add('hidden');
                el('feedback-gift-joke').required = true;
                el('feedback-gift-joke-reason').required = true;
                el('feedback-gift-real').required = false;
                el('feedback-gift-real-reason').required = false;
            });
        }

        // Handler para envio de feedback
        async function handleFeedbackSubmit(e) {
            e.preventDefault();

            // Validar tipo de presente
            const giftType = document.querySelector('input[name="gift-type"]:checked');
            if (!giftType) {
                alert("Voc√™ precisa escolher um tipo de presente."); // (Substituir por modal)
                return;
            }

            const feedbackData = {
                fromId: currentUser.uid,
                fromName: userData.name, // Para o admin ver
                toId: userData.currentGame.target,
                round: currentTurmaData.game.round,
                feedbackPositive: el('feedback-positive').value,
                feedbackConstructive: el('feedback-constructive').value,
                giftType: giftType.value,
                giftName: (giftType.value === 'real') ? el('feedback-gift-real').value : el('feedback-gift-joke').value,
                giftReason: (giftType.value === 'real') ? el('feedback-gift-real-reason').value : el('feedback-gift-joke-reason').value,
                reactions: [],
                createdAt: new Date().toISOString()
            };

            try {
                // 1. Salvar o feedback (como um presente recebido para o *alvo*)
                const targetGiftsRef = collection(db, 'users', feedbackData.toId, 'receivedGifts');
                await addDoc(targetGiftsRef, feedbackData);

                // 2. Atualizar o estado do usu√°rio (local)
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    'currentGame.status': 'done',
                    'stats.sent': (userData.stats.sent || 0) + 1,
                    'gameHistory': arrayUnion({
                        round: currentTurmaData.game.round,
                        targetId: feedbackData.toId,
                        feedbackSent: true
                    })
                });

                // 3. Atualizar o progresso da rodada (na turma)
                const turmaRef = doc(db, 'turmas', userData.turma);
                await runTransaction(db, async(transaction) => {
                    const turmaDoc = await transaction.get(turmaRef);
                    if (!turmaDoc.exists()) throw "Turma n√£o existe";
                    const currentProgress = turmaDoc.data().game.progress || 0;
                    transaction.update(turmaRef, {
                        'game.progress': currentProgress + 1
                    });
                });

                // 4. Resetar o formul√°rio
                el('feedback-form').reset();
                el('gift-real-box').classList.add('hidden');
                el('gift-joke-box').classList.add('hidden');

                // UI ser√° atualizada pelo onSnapshot

            } catch (error) {
                console.error("Erro ao enviar feedback:", error);
                alert("Erro ao enviar. Tente novamente."); // (Substituir por modal)
            }
        }


        // ===================================================================================
        // 5. RENDERIZA√á√ÉO DE LISTAS E PAIN√âIS
        // ===================================================================================

        // ---- Minha Estante (Presentes Recebidos) ----
        function renderGiftsList(gifts) {
            const list = el('gifts-list');
            const emptyState = el('gifts-empty-state');

            if (gifts.length === 0) {
                emptyState.classList.remove('hidden');
                list.innerHTML = '';
                return;
            }

            emptyState.classList.add('hidden');
            list.innerHTML = ''; // Limpa a lista antes de renderizar

            // Ordena por rodada
            gifts.sort((a, b) => (a.round || 0) - (b.round || 0));

            gifts.forEach(gift => {
                const isReal = gift.giftType === 'real';
                const giftIcon = isReal ? 'ph-gift' : 'ph-smiley-wink';
                const giftColor = isReal ? 'blue' : 'purple';

                const card = `
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <span class="text-sm font-medium bg-${giftColor}-100 text-${giftColor}-700 px-3 py-1 rounded-full">Rodada ${gift.round}</span>
                        <div class="mt-4">
                            <p class="text-sm text-gray-500"><i class="ph-fill ph-sun text-yellow-500 mr-1"></i> "Admiro em voc√™..."</p>
                            <p class="text-gray-800 font-medium italic">"${escapeHTML(gift.feedbackPositive)}"</p>
                        </div>
                        <div class="mt-3">
                            <p class="text-sm text-gray-500"><i class="ph-fill ph-plant text-green-500 mr-1"></i> "Uma sugest√£o..."</p>
                            <p class="text-gray-800 font-medium italic">"${escapeHTML(gift.feedbackConstructive)}"</p>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <p class="text-sm font-medium text-gray-700 mb-2">Presente Recebido (${isReal ? 'Real' : 'Zueira'}):</p>
                            <div class="flex items-center">
                                <i class="ph-fill ${giftIcon} text-${giftColor}-600 text-3xl mr-3"></i>
                                <div>
                                    <p class="font-bold text-gray-800">${escapeHTML(gift.giftName)}</p>
                                    <p class="text-sm text-gray-600 italic">"${escapeHTML(gift.giftReason)}"</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200 flex space-x-2">
                            <button title="Obrigado!" class="reaction-btn p-2 rounded-full ${gift.reactions.includes(`üôè:${currentUser.uid}`) ? 'bg-gray-300' : 'hover:bg-gray-200'} transition-colors" data-reaction="üôè" data-gift-id="${gift.id}" data-author-id="${gift.fromId}">üôè</button>
                            <button title="Adorei!" class="reaction-btn p-2 rounded-full ${gift.reactions.includes(`‚ù§Ô∏è:${currentUser.uid}`) ? 'bg-gray-300' : 'hover:bg-gray-200'} transition-colors" data-reaction="‚ù§Ô∏è" data-gift-id="${gift.id}" data-author-id="${gift.fromId}">‚ù§Ô∏è</button>
                            <button title="Engra√ßado!" class="reaction-btn p-2 rounded-full ${gift.reactions.includes(`üòÇ:${currentUser.uid}`) ? 'bg-gray-300' : 'hover:bg-gray-200'} transition-colors" data-reaction="üòÇ" data-gift-id="${gift.id}" data-author-id="${gift.fromId}">üòÇ</button>
                            <button title="Interessante!" class="reaction-btn p-2 rounded-full ${gift.reactions.includes(`üí°:${currentUser.uid}`) ? 'bg-gray-300' : 'hover:bg-gray-200'} transition-colors" data-reaction="üí°" data-gift-id="${gift.id}" data-author-id="${gift.fromId}">üí°</button>
                            <button title="Gostei!" class="reaction-btn p-2 rounded-full ${gift.reactions.includes(`üëç:${currentUser.uid}`) ? 'bg-gray-300' : 'hover:bg-gray-200'} transition-colors" data-reaction="üëç" data-gift-id="${gift.id}" data-author-id="${gift.fromId}">üëç</button>
                            <button title="Genial!" class="reaction-btn p-2 rounded-full ${gift.reactions.includes(`üëè:${currentUser.uid}`) ? 'bg-gray-300' : 'hover:bg-gray-200'} transition-colors" data-reaction="üëè" data-gift-id="${gift.id}" data-author-id="${gift.fromId}">üëè</button>
                            <button title="Uau!" class="reaction-btn p-2 rounded-full ${gift.reactions.includes(`üòÆ:${currentUser.uid}`) ? 'bg-gray-300' : 'hover:bg-gray-200'} transition-colors" data-reaction="üòÆ" data-gift-id="${gift.id}" data-author-id="${gift.fromId}">üòÆ</button>
                        </div>
                    </div>
                `;
                list.innerHTML += card;
            });

            // CORRE√á√ÉO: A l√≥gica de rea√ß√£o estava faltando ou no lugar errado (causando o SyntaxError).
            // Mover para c√°, dentro da fun√ß√£o `handleReactionClick` e adicionar os listeners.
            qsa('.reaction-btn').forEach(btn => {
                btn.addEventListener('click', handleReactionClick);
            });
        }

        // CORRE√á√ÉO: Fun√ß√£o para lidar com o clique na rea√ß√£o
        async function handleReactionClick(e) {
            const button = e.currentTarget;
            const reaction = button.dataset.reaction;
            const giftId = button.dataset.giftId;
            const authorId = button.dataset.authorId;
            const reactionId = `${reaction}:${currentUser.uid}`;

            const giftRef = doc(db, 'users', currentUser.uid, 'receivedGifts', giftId);
            const authorRef = doc(db, 'users', authorId);

            try {
                // Verificar se j√° reagiu com este emoji
                const giftSnap = await getDoc(giftRef);
                const currentReactions = giftSnap.data().reactions || [];
                const hasReacted = currentReactions.includes(reactionId);

                const batch = writeBatch(db);

                if (hasReacted) {
                    // Remover rea√ß√£o
                    batch.update(giftRef, { reactions: arrayRemove(reactionId) });
                    // Decrementar estat√≠stica do autor (apenas se for positiva)
                    if (['üôè', '‚ù§Ô∏è', 'üí°', 'üëç', 'üëè', 'üòÆ'].includes(reaction)) {
                        await runTransaction(db, async(t) => {
                            const authorDoc = await t.get(authorRef);
                            const currentStats = authorDoc.data().stats;
                            t.update(authorRef, { 'stats.reactions': Math.max(0, (currentStats.reactions || 0) - 1) });
                        });
                    }
                    button.classList.remove('bg-gray-300');
                } else {
                    // Adicionar rea√ß√£o
                    batch.update(giftRef, { reactions: arrayUnion(reactionId) });
                    // Incrementar estat√≠stica do autor (apenas se for positiva)
                    if (['üôè', '‚ù§Ô∏è', 'üí°', 'üëç', 'üëè', 'üòÆ'].includes(reaction)) {
                        await runTransaction(db, async(t) => {
                            const authorDoc = await t.get(authorRef);
                            const currentStats = authorDoc.data().stats;
                            const newReactionCount = (currentStats.reactions || 0) + 1;
                            t.update(authorRef, { 'stats.reactions': newReactionCount });

                            // Conceder badge "Queridinho(a)"
                            // CORRE√á√ÉO: A l√≥gica original era '>= 4', o correto √© '== 5' ou '>= 5'.
                            if (newReactionCount >= 5) {
                                // Usar 't.update' em vez de 'grantBadge' dentro de transa√ß√£o, se poss√≠vel,
                                // ou chamar 'grantBadge' fora. Vamos chamar grantBadge por seguran√ßa.
                                // (grantBadge usa arrayUnion, √© seguro)
                                await grantBadge(authorId, 'queridinho');
                            }
                        });
                    }
                    button.classList.add('bg-gray-300');
                }
                await batch.commit();
                // O listener onSnapshot (unsubscribeGifts) vai atualizar a UI

            } catch (error) {
                console.error("Erro ao enviar rea√ß√£o:", error);
            }
        }


        // ---- Meu Painel (Estat√≠sticas e Badges) ----
        function renderMyStats() {
            if (!userData) return;
            const stats = userData.stats;
            el('stats-rounds').textContent = stats.rounds || 0;
            el('stats-sent').textContent = stats.sent || 0;
            el('stats-received').textContent = stats.received || 0;
            el('stats-reactions').textContent = `${stats.reactions || 0} ‚ù§Ô∏è`;
            el('stats-guess-1').textContent = `${stats.guess1 || 0} vezes`;
            el('stats-guess-2').textContent = `${stats.guess2 || 0} vezes`;
            el('stats-guess-3').textContent = `${stats.guess3 || 0} vezes`;
        }

        function renderBadges() {
            if (!userData) return;
            const userBadges = userData.badges || [];
            const grid = el('badges-grid');
            grid.innerHTML = '';

            for (const badgeKey in allBadges) {
                const badge = allBadges[badgeKey];
                const hasBadge = userBadges.includes(badgeKey);
                const color = hasBadge ? 'yellow-400' : 'gray-300';
                const textColor = hasBadge ? 'white' : 'gray-500';
                const opacity = hasBadge ? '' : 'opacity-40';

                const badgeHTML = `
                    <div class="text-center w-20 ${opacity}" title="${badge.name}: ${badge.desc}">
                        <div class="w-20 h-20 rounded-full bg-${color} flex items-center justify-center text-${textColor} text-4xl shadow-md">
                            <i class="ph-bold ph-${badge.icon}"></i>
                        </div>
                        <p class="text-sm font-medium mt-2">${badge.name}</p>
                    </div>
                `;
                grid.innerHTML += badgeHTML;
            }
        }

        // ---- Mural de Dicas ----
        function renderTipsMural(tips) {
            const list = el('tips-list');
            const emptyState = el('tips-empty-state');

            if (tips.length === 0) {
                emptyState.classList.remove('hidden');
                list.innerHTML = '';
                return;
            }

            emptyState.classList.add('hidden');
            list.innerHTML = ''; // Limpa

            // Embaralha as dicas
            tips.sort(() => 0.5 - Math.random());

            tips.forEach(tip => {
                const card = `
                    <div class="bg-white rounded-2xl shadow-lg h-48 card-container">
                        <div class="card-inner relative w-full h-full">
                            <div class="card-front absolute w-full h-full flex flex-col items-center justify-center text-center p-4 bg-white rounded-2xl border-2 border-blue-200">
                                <i class="ph-bold ph-question text-blue-600 text-6xl"></i>
                                <p class="text-lg font-medium mt-2">Dica An√¥nima</p>
                                <p class="text-sm text-gray-500 mt-2">(Passe o mouse para revelar)</p>
                            </div>
                            <div class="card-back absolute w-full h-full p-6 bg-blue-50 rounded-2xl flex items-center justify-center">
                                <p class="text-lg font-medium text-blue-800 italic">"${escapeHTML(tip.text)}"</p>
                            </div>
                        </div>
                    </div>
                `;
                list.innerHTML += card;
            });
        }

        function showAddTipModal() {
            el('generic-modal-title').textContent = "Postar Dica An√¥nima";
            const body = el('generic-modal-body');
            body.innerHTML = `
                <p class="text-gray-600 mb-4">Sua dica ser√° enviada para aprova√ß√£o do administrador. Se aprovada, ela aparecer√° no mural para todos.</p>
                <form id="add-tip-form">
                    <textarea id="tip-text" class="w-full p-2 border border-gray-300 rounded-lg" rows="4" placeholder="Escreva uma dica extra sobre voc√™..." required></textarea>
                    <div class="flex justify-end mt-4">
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Enviar para Aprova√ß√£o</button>
                    </div>
                </form>
            `;
            el('generic-modal').classList.remove('hidden');

            el('add-tip-form').addEventListener('submit', async(e) => {
                e.preventDefault();
                const text = el('tip-text').value;
                try {
                    const tipsRef = collection(db, 'turmas', userData.turma, 'tips');
                    await addDoc(tipsRef, {
                        text: text,
                        userId: currentUser.uid, // Para o admin saber quem postou (mas n√£o √© p√∫blico)
                        approved: false,
                        createdAt: new Date().toISOString()
                    });
                    el('generic-modal').classList.add('hidden');
                } catch (error) {
                    console.error("Erro ao postar dica:", error);
                }
            });
        }

        // ---- Mural de Agradecimentos ----
        function renderThanksMural(thanks) {
            const list = el('thanks-list');
            if (!currentTurmaData || !currentTurmaData.game.thanksMuralEnabled) {
                return; // N√£o renderiza se estiver desabilitado
            }

            list.innerHTML = '';
            // Ordena por data (mais recente primeiro)
            thanks.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

            if (thanks.length === 0) {
                list.innerHTML = `<p class="text-gray-500 text-center col-span-full">Nenhum agradecimento ainda. Seja o primeiro!</p>`;
                return;
            }

            thanks.forEach(msg => {
                const initials = msg.userName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const date = new Date(msg.createdAt).toLocaleString('pt-BR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                const card = `
                    <div class="bg-white p-5 rounded-2xl shadow-lg flex items-start space-x-4">
                        <div class="w-12 h-12 rounded-full bg-green-600 flex items-center justify-center text-white text-2xl font-bold flex-shrink-0">
                            <span>${initials}</span>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800">${escapeHTML(msg.userName)}</p>
                            <p class="text-gray-700 mt-1 italic">"${escapeHTML(msg.text)}"</p>
                            <p class="text-xs text-gray-400 mt-2">${date}</p>
                        </div>
                    </div>
                `;
                list.innerHTML += card;
            });
        }

        function showAddThanksModal() {
            el('generic-modal-title').textContent = "Deixar Agradecimento";
            const body = el('generic-modal-body');
            body.innerHTML = `
                <p class="text-gray-600 mb-4">Sua mensagem ser√° p√∫blica para a turma e **n√£o ser√° an√¥nima**. Deixe um recado legal para seus colegas!</p>
                <form id="add-thanks-form">
                    <textarea id="thanks-text" class="w-full p-2 border border-gray-300 rounded-lg" rows="4" placeholder="Escreva sua mensagem..." required></textarea>
                    <div class="flex justify-end mt-4">
                        <button type="submit" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Postar Mensagem</button>
                    </div>
                </form>
            `;
            el('generic-modal').classList.remove('hidden');

            el('add-thanks-form').addEventListener('submit', async(e) => {
                e.preventDefault();
                const text = el('thanks-text').value;
                try {
                    const thanksRef = collection(db, 'turmas', userData.turma, 'thanks');
                    await addDoc(thanksRef, {
                        text: text,
                        userId: currentUser.uid,
                        userName: userData.name,
                        createdAt: new Date().toISOString()
                    });
                    el('generic-modal').classList.add('hidden');
                } catch (error) {
                    console.error("Erro ao postar agradecimento:", error);
                }
            });
        }

        // ===================================================================================
        // 6. PAINEL DO ADMINISTRADOR
        // ===================================================================================

        // Handler de Login Admin
        async function handleAdminLogin(e) {
            e.preventDefault();
            el('admin-password-error').textContent = '';
            const password = el('admin-password-input').value;
            const turmaRef = doc(db, 'turmas', userData.turma);

            try {
                const turmaSnap = await getDoc(turmaRef);
                const turmaData = turmaSnap.data();

                if (turmaData.adminPassword) {
                    // Senha j√° existe, verificar
                    if (password === turmaData.adminPassword) {
                        adminPasswordVerified = true;
                        el('admin-password-screen').classList.add('hidden');
                        el('admin-dashboard').classList.remove('hidden');
                        renderAdminDashboard();
                    } else {
                        el('admin-password-error').textContent = 'Senha incorreta.';
                    }
                } else {
                    // Primeira vez, definir senha
                    await updateDoc(turmaRef, { adminPassword: password });
                    adminPasswordVerified = true;
                    el('admin-password-screen').classList.add('hidden');
                    el('admin-dashboard').classList.remove('hidden');
                    renderAdminDashboard();
                }
            } catch (error) {
                console.error("Erro no login admin:", error);
                el('admin-password-error').textContent = 'Erro ao verificar senha.';
            }
        }

        // Renderiza o painel admin (chamado ap√≥s login admin e no listener da turma)
        async function renderAdminDashboard() {
            if (!currentTurmaData || !adminPasswordVerified) return;

            const game = currentTurmaData.game;

            // 1. Info da Rodada
            el('admin-current-round').textContent = game.round || 0;
            el('admin-game-status').textContent = game.status;
            const startBtn = el('admin-start-round-btn');
            const releaseBtn = el('admin-release-gifts-btn');

            startBtn.onclick = startNewRound;
            releaseBtn.onclick = releaseGifts;

            if (game.status === 'waiting' || game.status === 'revealing') {
                startBtn.disabled = false;
                startBtn.textContent = (game.round === 0) ? 'Iniciar 1¬™ Rodada' : 'Iniciar Nova Rodada';
                releaseBtn.disabled = true;
            } else { // running
                startBtn.disabled = true;
                startBtn.textContent = 'Rodada em Andamento';
                releaseBtn.disabled = false;
            }

            // 2. Progresso da Turma e Lista de Participantes
            const usersQuery = query(collection(db, 'users'), where('turma', '==', userData.turma));
            const querySnapshot = await getDocs(usersQuery);
            const participants = [];
            let doneCount = 0;
            querySnapshot.forEach(docSnap => {
                const user = docSnap.data();
                participants.push(user);
                if (user.currentGame.status === 'done') {
                    doneCount++;
                }
            });

            // Atualiza barra de progresso
            const totalParticipants = participants.length;
            const progress = (totalParticipants > 0) ? (doneCount / totalParticipants) * 100 : 0;
            el('admin-round-progress-text').textContent = `${doneCount}/${totalParticipants}`;
            el('admin-round-progress-bar').style.width = `${progress}%`;

            // Atualiza lista de participantes
            const list = el('admin-participants-list');
            list.innerHTML = '';
            participants.sort((a, b) => a.name.localeCompare(b.name)).forEach(user => {
                const isDone = user.currentGame.status === 'done';
                const statusColor = isDone ? 'text-green-600' : 'text-red-600';
                const statusText = isDone ? 'Completo' : 'Pendente';
                list.innerHTML += `
                    <div class="bg-white p-4 rounded-lg shadow flex items-center justify-between">
                        <span class="font-medium">${user.name}</span>
                        <span class="text-sm font-bold ${statusColor}">${statusText}</span>
                    </div>
                `;
            });

            // 3. Nuvem de Palavras
            renderWordCloud(participants);

            // 4. Gerenciamento (Dicas e Agradecimentos)
            renderAdminTipsList();
            const thanksBtn = el('admin-toggle-thanks-btn');
            if (game.thanksMuralEnabled) {
                thanksBtn.textContent = "Trancar Mural";
                thanksBtn.classList.remove('bg-red-100', 'text-red-700');
                thanksBtn.classList.add('bg-green-100', 'text-green-700');
            } else {
                thanksBtn.textContent = "Liberar Mural";
                thanksBtn.classList.remove('bg-green-100', 'text-green-700');
                thanksBtn.classList.add('bg-red-100', 'text-red-700');
            }
            thanksBtn.onclick = toggleThanksMural;
        }

        // ---- A√ß√µes do Admin ----

        // Iniciar Nova Rodada
        async function startNewRound() {
            if (!confirm("Tem certeza que deseja iniciar uma nova rodada? Isso sortear√° novos amigos para todos.")) {
                return;
            }

            el('admin-start-round-btn').disabled = true;
            el('admin-start-round-btn').textContent = "Sorteando...";

            const newRoundNumber = (currentTurmaData.game.round || 0) + 1;

            try {
                // 1. Buscar todos os participantes da turma
                const usersQuery = query(collection(db, 'users'), where('turma', '==', userData.turma));
                const querySnapshot = await getDocs(usersQuery);
                let participants = [];
                querySnapshot.forEach(docSnap => {
                    participants.push({ id: docSnap.id, ...docSnap.data() });
                });

                if (participants.length < 2) {
                    alert("Precisa de pelo menos 2 participantes para iniciar.");
                    el('admin-start-round-btn').disabled = false;
                    return;
                }

                // 2. Realizar o sorteio
                const assignments = performDraw(participants, newRoundNumber);
                if (!assignments) {
                    alert("Falha no sorteio. N√£o h√° pares suficientes para evitar repeti√ß√µes. Tente novamente ou aguarde mais rodadas.");
                    el('admin-start-round-btn').disabled = false;
                    return;
                }

                // 3. Atualizar todos os usu√°rios no DB (em batch)
                const batch = writeBatch(db);
                assignments.forEach(pair => {
                    const userRef = doc(db, 'users', pair.from);
                    batch.update(userRef, {
                        'currentGame.status': 'guessing',
                        'currentGame.target': pair.to,
                        'currentGame.targetName': null,
                        'currentGame.guesses': 3,
                        'stats.rounds': (participants.find(p => p.id === pair.from).stats.rounds || 0) + 1
                    });
                });

                // 4. Atualizar o estado da turma
                const turmaRef = doc(db, 'turmas', userData.turma);
                batch.update(turmaRef, {
                    'game.status': 'running',
                    'game.round': newRoundNumber,
                    'game.progress': 0, // Resetar progresso
                    'game.totalParticipants': participants.length
                });

                // 5. Conceder badge "Veterano" (se for a rodada 3)
                if (newRoundNumber === 3) {
                    participants.forEach(p => {
                        // Usar grantBadge (que √© seguro) em vez de no batch
                        grantBadge(p.id, 'veterano');
                    });
                }

                await batch.commit();
                // UI ser√° atualizada pelo onSnapshot

            } catch (error) {
                console.error("Erro ao iniciar rodada:", error);
                alert("Erro ao iniciar rodada. Tente novamente.");
                el('admin-start-round-btn').disabled = false;
            }
        }

        // Algoritmo de Sorteio (Evita repetir o √∫ltimo alvo)
        function performDraw(participants) {
            let p_list = participants.map(p => p.id);
            let assignments = {};
            let available = [...p_list];

            // Tentar embaralhar e verificar
            for (let i = 0; i < 20; i++) { // Tentar 20x
                assignments = {};
                available = [...p_list];
                p_list.sort(() => 0.5 - Math.random()); // Embaralha quem sorteia
                let possible = true;

                for (const p_id of p_list) {
                    const participant = participants.find(p => p.id === p_id);
                    const lastTarget = participant.gameHistory.length > 0 ? participant.gameHistory[participant.gameHistory.length - 1].targetId : null;

                    // Filtra alvos dispon√≠veis: n√£o pode ser ele mesmo, n√£o pode ser o √∫ltimo alvo
                    let targets = available.filter(t => t !== p_id && t !== lastTarget);
                    if (targets.length === 0) {
                        // Se os √∫nicos dispon√≠veis s√£o ele mesmo ou o √∫ltimo, tenta pegar qualquer um que n√£o seja ele mesmo
                        targets = available.filter(t => t !== p_id);
                    }

                    if (targets.length === 0) {
                        possible = false;
                        break; // Falha, tentar de novo
                    }

                    const target = targets[Math.floor(Math.random() * targets.length)];
                    assignments[p_id] = target;
                    available = available.filter(t => t !== target); // Remove alvo da lista
                }

                if (possible) {
                    // Sucesso!
                    return Object.keys(assignments).map(fromId => ({ from: fromId, to: assignments[fromId] }));
                }
            }
            // Falhou ap√≥s 20 tentativas
            return null;
        }

        // Liberar Presentes (Final da Rodada)
        async function releaseGifts() {
            if (!confirm("Tem certeza? Isso marcar√° a rodada como 'conclu√≠da' e todos ver√£o os presentes que receberam. Esta a√ß√£o N√ÉO pode ser desfeita.")) {
                return;
            }

            el('admin-release-gifts-btn').disabled = true;
            el('admin-release-gifts-btn').textContent = "Liberando...";

            try {
                // 1. Atualizar o estado da turma
                const turmaRef = doc(db, 'turmas', userData.turma);
                await updateDoc(turmaRef, {
                    'game.status': 'revealing' // 'revealing' √© o novo 'waiting'
                });

                // 2. Conceder badge "Turma Unida" (se 100% completou)
                // CORRE√á√ÉO: A l√≥gica da badge "Turma Unida" estava com bugs.
                // Esta √© a nova l√≥gica correta.
                const game = currentTurmaData.game;
                if (game.progress === game.totalParticipants && game.totalParticipants > 0) {
                    const usersQuery = query(collection(db, 'users'), where('turma', '==', userData.turma));
                    const querySnapshot = await getDocs(usersQuery);
                    const batch = writeBatch(db);
                    querySnapshot.forEach(docSnap => {
                        const userRef = doc(db, 'users', docSnap.id);
                        // Usar arrayUnion para adicionar a badge sem sobrescrever
                        batch.update(userRef, {
                            badges: arrayUnion('turma-unida')
                        });
                    });
                    await batch.commit();
                }

                // 3. Atualizar stats.received de todos
                const usersQuery = query(collection(db, 'users'), where('turma', '==', userData.turma));
                const querySnapshot = await getDocs(usersQuery);
                const batch = writeBatch(db);
                querySnapshot.forEach(docSnap => {
                    const userRef = doc(db, 'users', docSnap.id);
                    const currentReceived = docSnap.data().stats.received || 0;
                    // (Poderia checar quantos presentes foram recebidos nesta rodada, mas incrementar em 1 √© mais simples)
                    batch.update(userRef, {
                        'stats.received': currentReceived + 1
                    });
                });
                await batch.commit();

                // UI ser√° atualizada pelo onSnapshot

            } catch (error) {
                console.error("Erro ao liberar presentes:", error);
                alert("Erro ao liberar presentes. Tente novamente.");
                el('admin-release-gifts-btn').disabled = false;
            }
        }

        // ---- Admin: Nuvem de Palavras ----
        async function renderWordCloud(participants) {
            let allPositiveFeedback = "";

            // Coletar todos os feedbacks positivos de todos os usu√°rios
            const promises = participants.map(p => {
                return getDocs(collection(db, 'users', p.id, 'receivedGifts'));
            });

            const snapshots = await Promise.all(promises);
            snapshots.forEach(snapshot => {
                snapshot.forEach(docSnap => {
                    allPositiveFeedback += docSnap.data().feedbackPositive + " ";
                });
            });

            // Processar texto (remover stopwords)
            const words = allPositiveFeedback.toLowerCase().match(/\b(\w+)\b/g) || [];
            const frequencies = {};
            const stopwords = [
                'de', 'a', 'o', 'que', 'e', 'do', 'da', 'em', 'um', 'para', 'com', 'n√£o', 'uma',
                'os', 'no', 'se', 'na', 'por', 'mais', 'as', 'dos', 'como', 'mas', 'ao', 'ele',
                'das', '√†', 'seu', 'sua', 'ou', 'quando', 'muito', 'nos', 'j√°', 'eu', 'tamb√©m',
                's√≥', 'pelo', 'pela', 'at√©', 'isso', 'ela', 'entre', 'depois', 'sem', 'mesmo',
                'aos', 'ter', 'seus', 'quem', 'nas', 'me', 'esse', 'eles', 'voc√™', 'voc√™s',
                'essa', 'num', 'nem', 'suas', 'meu', '√†s', 'minha', 'numa', 'pelos', 'pelas',
                'elas', 'qual', 'n√≥s', 'lhe', 'deles', 'essas', 'esses', 'pelas', 'este',
                'dele', 'tu', 'te', 'nossos', 'nossas', 'teu', 'tua', 'teus', 'tuas', 'nosso',
                'nossa', 'meus', 'minhas', 'tua', 'for', '√©', 's√£o', 'foi', 'era', 'ser',
                'ter', 'tem', 'tenho', 'foi', 'seria', 'est√°', 'estava', 'est√°vamos'
                // Adicione mais stopwords comuns se necess√°rio
            ];

            words.forEach(word => {
                if (word.length > 3 && !stopwords.includes(word)) {
                    frequencies[word] = (frequencies[word] || 0) + 1;
                }
            });

            const wordList = Object.keys(frequencies).map(key => [key, frequencies[key]]);

            if (wordList.length > 0) {
                WordCloud(el('word-cloud-canvas'), {
                    list: wordList,
                    weightFactor: 6,
                    minFontSize: 10,
                    fontFamily: 'Inter, sans-serif',
                    color: 'random-dark',
                    backgroundColor: '#f9fafb' // bg-gray-50
                });
            } else {
                const ctx = el('word-cloud-canvas').getContext('2d');
                ctx.clearRect(0, 0, 600, 250);
                ctx.font = "16px Inter";
                ctx.fillStyle = "#6b7280";
                ctx.textAlign = "center";
                ctx.fillText("Aguardando feedbacks positivos para gerar a nuvem...", 300, 125);
            }
        }

        // ---- Admin: Gerenciamento (Dicas, Agradecimentos) ----
        async function renderAdminTipsList() {
            const tipsQuery = query(collection(db, 'turmas', userData.turma, 'tips'), where("approved", "==", false));
            const querySnapshot = await getDocs(tipsQuery);

            const list = el('admin-tips-list');
            const empty = el('admin-tips-empty');
            list.innerHTML = ''; // Limpa

            if (querySnapshot.empty) {
                list.appendChild(empty);
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            querySnapshot.forEach(docSnap => {
                const tip = { id: docSnap.id, ...docSnap.data() };
                const item = document.createElement('div');
                item.className = "bg-gray-50 p-3 rounded-lg flex items-center justify-between";
                item.innerHTML = `
                    <span class="italic text-gray-700 w-3/4 truncate" title="${escapeHTML(tip.text)}">"${escapeHTML(tip.text)}"</span>
                    <div class="flex space-x-2">
                        <button data-id="${tip.id}" class="admin-approve-tip text-green-600 hover:text-green-800"><i class="ph-bold ph-check-circle text-2xl"></i></button>
                        <button data-id="${tip.id}" class="admin-reject-tip text-red-600 hover:text-red-800"><i class="ph-bold ph-x-circle text-2xl"></i></button>
                    </div>
                `;
                list.appendChild(item);
            });

            // Adiciona listeners
            qsa('.admin-approve-tip').forEach(btn => btn.onclick = async(e) => {
                const id = e.currentTarget.dataset.id;
                await updateDoc(doc(db, 'turmas', userData.turma, 'tips', id), { approved: true });
                renderAdminTipsList(); // Re-renderiza a lista
            });
            qsa('.admin-reject-tip').forEach(btn => btn.onclick = async(e) => {
                const id = e.currentTarget.dataset.id;
                await deleteDoc(doc(db, 'turmas', userData.turma, 'tips', id));
                renderAdminTipsList(); // Re-renderiza a lista
            });
        }

        async function toggleThanksMural() {
            const newStatus = !currentTurmaData.game.thanksMuralEnabled;
            await updateDoc(doc(db, 'turmas', userData.turma), { 'game.thanksMuralEnabled': newStatus });
            // UI ser√° atualizada pelo onSnapshot
        }

        async function showGrantBadgeModal() {
            // Modal para conceder "Escritor de Ouro"
            const usersQuery = query(collection(db, 'users'), where('turma', '==', userData.turma));
            const querySnapshot = await getDocs(usersQuery);
            let options = '';
            querySnapshot.forEach(docSnap => {
                options += `<option value="${docSnap.id}">${docSnap.data().name}</option>`;
            });

            el('generic-modal-title').textContent = "Conceder Badge 'Escritor de Ouro'";
            const body = el('generic-modal-body');
            body.innerHTML = `
                <p class="text-gray-600 mb-4">Escolha o aluno que escreveu o feedback mais construtivo e gentil desta rodada.</p>
                <form id="grant-badge-form">
                    <select id="badge-user-select" class="w-full p-2 border border-gray-300 rounded-lg bg-white" required>
                        <option value="">Selecione um aluno...</option>
                        ${options}
                    </select>
                    <div class="flex justify-end mt-4">
                        <button type="submit" class="bg-yellow-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-yellow-600">Conceder</button>
                    </div>
                </form>
            `;
            el('generic-modal').classList.remove('hidden');

            el('grant-badge-form').addEventListener('submit', async(e) => {
                e.preventDefault();
                const userId = el('badge-user-select').value;
                if (!userId) return;
                await grantBadge(userId, 'escritor');
                el('generic-modal').classList.add('hidden');
            });
        }

        // ===================================================================================
        // 7. M√ìDULO DO QUIZ
        // ===================================================================================

        function showQuizModal() {
            currentQuizQuestion = 0;
            quizScore = 0;
            // Embaralhar perguntas
            quizQuestions.sort(() => 0.5 - Math.random());
            renderQuizQuestion();
            el('generic-modal').classList.remove('hidden');
        }

        function renderQuizQuestion() {
            if (currentQuizQuestion >= quizQuestions.length) {
                // Fim do Quiz (mostrar 10)
                showQuizResult();
                return;
            }

            const q = quizQuestions[currentQuizQuestion];
            el('generic-modal-title').textContent = `Quiz Surpresa (${currentQuizQuestion + 1} / ${quizQuestions.length})`;
            const body = el('generic-modal-body');
            let answersHTML = '';
            q.a.forEach((answer, index) => {
                answersHTML += `<button data-index="${index}" class="quiz-answer-btn block w-full text-left p-3 border border-gray-300 rounded-lg hover:bg-gray-100">${escapeHTML(answer)}</button>`;
            });

            body.innerHTML = `
                <p class="text-lg font-medium text-gray-800 mb-4">${escapeHTML(q.q)}</p>
                <div class="space-y-3">
                    ${answersHTML}
                </div>
                <p id="quiz-feedback" class="text-center font-medium mt-4"></p>
            `;

            qsa('.quiz-answer-btn').forEach(btn => {
                btn.addEventListener('click', handleQuizAnswer);
            });
        }

        async function handleQuizAnswer(e) {
            const selectedIndex = parseInt(e.currentTarget.dataset.index);
            const correctIndex = quizQuestions[currentQuizQuestion].correct;
            const feedback = el('quiz-feedback');

            // Desabilitar bot√µes
            qsa('.quiz-answer-btn').forEach(btn => btn.disabled = true);

            if (selectedIndex === correctIndex) {
                // Acertou
                quizScore++;
                e.currentTarget.classList.add('bg-green-100', 'border-green-400');
                feedback.textContent = "Correto!";
                feedback.className = "text-center font-medium mt-4 text-green-600";
            } else {
                // Errou
                e.currentTarget.classList.add('bg-red-100', 'border-red-400');
                // Destacar a correta
                qsa('.quiz-answer-btn')[correctIndex].classList.add('bg-green-100', 'border-green-400');
                feedback.textContent = "Incorreto!";
                feedback.className = "text-center font-medium mt-4 text-red-600";
            }

            // Conceder badge "Sabe-Tudo"
            if (quizScore >= 5) {
                await grantBadge(currentUser.uid, 'sabe-tudo');
            }

            // Pr√≥xima pergunta
            currentQuizQuestion++;
            setTimeout(renderQuizQuestion, 1500);
        }

        function showQuizResult() {
            el('generic-modal-title').textContent = "Quiz Finalizado!";
            const body = el('generic-modal-body');
            body.innerHTML = `
                <div class="text-center">
                    <p class="text-lg text-gray-700">Sua pontua√ß√£o foi:</p>
                    <p class="text-6xl font-bold text-blue-600 my-4">${quizScore} / ${quizQuestions.length}</p>
                    <p class="text-gray-600">√ìtimo trabalho! Voc√™ pode fechar esta janela.</p>
                </div>
            `;
        }

        // ===================================================================================
        // 8. UTILIT√ÅRIOS (Badges, Helpers)
        // ===================================================================================

        // Fun√ß√£o segura para conceder badge (evita duplicatas)
        async function grantBadge(userId, badgeKey) {
            if (!userId || !badgeKey) return;
            try {
                const userRef = doc(db, 'users', userId);
                await updateDoc(userRef, {
                    badges: arrayUnion(badgeKey)
                });
            } catch (error) {
                console.error(`Erro ao conceder badge ${badgeKey} para ${userId}:`, error);
            }
        }

        // Helper para escapar HTML
        function escapeHTML(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
        }

    </script>

</body>

</html>
