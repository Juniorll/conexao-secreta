<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conex√£o Secreta</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase 11.6.1 (M√≥dulos JS) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            setPersistence,
            inMemoryPersistence,
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            addDoc,
            updateDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            getDocs,
            writeBatch,
            increment,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        window.firebase = {
            initializeApp,
            getAuth,
            setPersistence,
            inMemoryPersistence,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            getFirestore,
            doc,
            setDoc,
            getDoc,
            addDoc,
            updateDoc,
            onSnapshot,
            collection,
            query,
            where,
            getDocs,
            writeBatch,
            increment,
            serverTimestamp
        };
    </script>

    <!-- Lib de Anima√ß√£o (Confetti) -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

    <!-- Lib de Nuvem de Palavras (WordCloud2.js) -->
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.js"></script>

    <style>
        /* Fonte Inter - Padr√£o do Tailwind */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Fundo suave */
        }
        /* Ocultar scrollbars */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Anima√ß√£o de fade-in */
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Anima√ß√£o da caixa de presente */
        .gift-box-shake {
            animation: shake 0.82s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }
        @keyframes shake {
          10%, 90% { transform: translate3d(-1px, 0, 0); }
          20%, 80% { transform: translate3d(2px, 0, 0); }
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
          40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Container Principal -->
    <div id="app-container" class="min-h-screen w-full transition-all duration-500">

        <!-- ===== TELA DE LOADING INICIAL ===== -->
        <div id="loading-spinner" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-100">
            <svg class="animate-spin h-12 w-12 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg font-medium text-gray-700">Conectando...</p>
        </div>

        <!-- ===== TELA DE LOGIN / CADASTRO ===== -->
        <div id="login-view" class="hidden min-h-screen w-full flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 p-4">
            <div class="w-full max-w-md">
                <!-- Painel de Login -->
                <div id="login-panel" class="bg-white rounded-xl shadow-2xl p-8 transition-all duration-300">
                    <h2 class="text-3xl font-bold text-center text-gray-900 mb-2">Conex√£o Secreta</h2>
                    <p class="text-center text-gray-500 mb-6">Entre para come√ßar a brincadeira!</p>
                    
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="login-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="seu.email@exemplo.com">
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                            <input type="password" id="login-password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-indigo-700 transition-transform transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                            Entrar
                        </button>
                        <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
                    </form>
                    <p class="text-center text-sm text-gray-600 mt-6">
                        N√£o tem uma conta? 
                        <button id="show-register-btn" class="font-medium text-indigo-600 hover:text-indigo-500">Cadastre-se</button>
                    </p>
                </div>

                <!-- Painel de Cadastro -->
                <div id="register-panel" class="hidden bg-white rounded-xl shadow-2xl p-8 transition-all duration-300">
                    <h2 class="text-3xl font-bold text-center text-gray-900 mb-6">Criar Conta</h2>
                    <form id="register-form">
                        <div class="mb-4">
                            <label for="register-name" class="block text-sm font-medium text-gray-700 mb-1">Seu Nome (real)</label>
                            <input type="text" id="register-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Nome Sobrenome">
                        </div>
                        <div class="mb-4">
                            <label for="register-turma" class="block text-sm font-medium text-gray-700 mb-1">Sua Turma</label>
                            <select id="register-turma" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                                <option value="" disabled selected>Selecione sua turma...</option>
                                <option value="1IATEC-ANCHIETA">1IATEC-ANCHIETA</option>
                                <option value="1MA-CHAMPAGNAT">1MA-CHAMPAGNAT</option>
                                <option value="1MB-CHAMPAGNAT">1MB-CHAMPAGNAT</option>
                                <option value="1TB-CHAMPAGNAT">1TB-CHAMPAGNAT</option>
                                <option value="1MATEC-OLYMPIA">1MATEC-OLYMPIA</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="register-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="register-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="seu.email@exemplo.com">
                        </div>
                        <div class="mb-4">
                            <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1">Senha (m√≠n. 6 caracteres)</label>
                            <input type="password" id="register-password" required minlength="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-indigo-700 transition-transform transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                            Criar Conta
                        </button>
                        <p id="register-error" class="text-red-500 text-sm mt-4 text-center"></p>
                    </form>
                    <p class="text-center text-sm text-gray-600 mt-6">
                        J√° tem uma conta? 
                        <button id="show-login-btn" class="font-medium text-indigo-600 hover:text-indigo-500">Entrar</button>
                    </p>
                </div>
            </div>
        </div>

        <!-- ===== INTERFACE PRINCIPAL DA APLICA√á√ÉO ===== -->
        <div id="app-view" class="hidden">
            <!-- Navbar -->
            <nav class="bg-white shadow-md sticky top-0 z-40">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex justify-between h-16">
                        <div class="flex items-center">
                            <span class="text-2xl font-bold text-indigo-600">Conex√£o Secreta</span>
                            <span id="nav-turma-name" class="ml-4 text-sm font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full"></span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <button id="nav-admin-btn" class="items-center px-3 py-2 border border-yellow-400 rounded-md text-sm font-medium text-yellow-700 bg-yellow-100 hover:bg-yellow-200" onclick="showView('admin-view')">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m12 0a2 2 0 100-4m0 4a2 2 0 110-4M6 20v-2a2 2 0 114 0v2H6zm12 0v-2a2 2 0 114 0v2h-4z"></path></svg>
                                Admin
                            </button>
                            <button id="nav-profile-btn" class="p-2 rounded-full text-gray-500 hover:text-gray-700 hover:bg-gray-100" title="Meu Perfil" onclick="showView('profile-view')">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            </button>
                            <button id="nav-logout-btn" class="p-2 rounded-full text-gray-500 hover:text-red-600 hover:bg-red-100" title="Sair">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Conte√∫do da P√°gina -->
            <main id="page-content" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

                <!-- ===== 1. DASHBOARD (VIEW PADR√ÉO) ===== -->
                <div id="dashboard-view" class="fade-in">
                    <div class="bg-white shadow-xl rounded-2xl p-6 md:p-8">
                        <h1 class="text-3xl font-bold mb-2">Ol√°, <span id="dashboard-user-name"></span>!</h1>
                        <p class="text-lg text-gray-600 mb-6">Bem-vindo(a) √† sua central.</p>

                        <!-- Estado do Jogo -->
                        <div id="game-status-box" class="bg-indigo-50 border-l-4 border-indigo-500 p-6 rounded-lg shadow-lg">
                            <!-- Conte√∫do din√¢mico aqui -->
                        </div>

                        <!-- Menu de Navega√ß√£o R√°pida -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8">
                            <button class="bg-white p-6 rounded-lg shadow-lg border border-gray-200 hover:shadow-xl hover:-translate-y-1 transition-all" onclick="showView('shelf-view')">
                                <span class="text-3xl">üéÅ</span>
                                <h3 class="text-xl font-bold mt-2">Estante de Presentes</h3>
                                <p class="text-gray-600">Veja os feedbacks que voc√™ recebeu.</p>
                            </button>
                            <button class="bg-white p-6 rounded-lg shadow-lg border border-gray-200 hover:shadow-xl hover:-translate-y-1 transition-all" onclick="showView('stats-view')">
                                <span class="text-3xl">üìä</span>
                                <h3 class="text-xl font-bold mt-2">Meu Painel Pessoal</h3>
                                <p class="text-gray-600">Suas estat√≠sticas e conquistas.</p>
                            </button>
                            <button class="bg-white p-6 rounded-lg shadow-lg border border-gray-200 hover:shadow-xl hover:-translate-y-1 transition-all" onclick="showView('hint-mural-view')">
                                <span class="text-3xl">üïµÔ∏è</span>
                                <h3 class="text-xl font-bold mt-2">Mural de Dicas</h3>
                                <p class="text-gray-600">Veja dicas extras da turma.</p>
                            </button>
                            <button class="bg-white p-6 rounded-lg shadow-lg border border-gray-200 hover:shadow-xl hover:-translate-y-1 transition-all" onclick="showView('thanks-mural-view')">
                                <span class="text-3xl">üôè</span>
                                <h3 class="text-xl font-bold mt-2">Mural de Agradecimentos</h3>
                                <p class="text-gray-600">Deixe uma mensagem para a turma.</p>
                            </button>
                            <button class="bg-white p-6 rounded-lg shadow-lg border border-gray-200 hover:shadow-xl hover:-translate-y-1 transition-all" onclick="showView('profile-view')">
                                <span class="text-3xl">üé®</span>
                                <h3 class="text-xl font-bold mt-2">Editar Meu Perfil</h3>
                                <p class="text-gray-600">Mude suas dicas, avatar e cor.</p>
                            </button>
                            <button id="quiz-button-wrapper" class="hidden bg-white p-6 rounded-lg shadow-lg border border-gray-200 hover:shadow-xl hover:-translate-y-1 transition-all" onclick="showView('quiz-view')">
                                <span class="text-3xl">üß†</span>
                                <h3 class="text-xl font-bold mt-2">Quiz Surpresa!</h3>
                                <p class="text-gray-600">Est√° entediado? Jogue um quiz.</p>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ===== 2. PERFIL DO USU√ÅRIO ===== -->
                <div id="profile-view" class="hidden fade-in">
                    <button class="mb-4 text-indigo-600 font-medium" onclick="showView('dashboard-view')">&larr; Voltar ao Dashboard</button>
                    <div class="bg-white shadow-xl rounded-2xl p-6 md:p-8">
                        <h1 class="text-3xl font-bold mb-6">Meu Perfil</h1>
                        <form id="profile-form">
                            <!-- Perguntas Tem√°ticas -->
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-lg font-semibold text-gray-800 mb-2">1. Se voc√™ pudesse criar um aplicativo para resolver qualquer problema do *mundo*, o que ele faria?</label>
                                    <textarea id="profile-q1" rows="3" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" placeholder="Descreva sua ideia..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-lg font-semibold text-gray-800 mb-2">2. Qual tecnologia (real ou fict√≠cia, ex: de um filme) voc√™ mais gostaria de ter no seu dia-a-dia e por qu√™?</label>
                                    <textarea id="profile-q2" rows="3" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" placeholder="Teletransporte? Um rob√¥? ..."></textarea>
                                </div>
                                <div>
                                    <label class="block text-lg font-semibold text-gray-800 mb-2">3. Qual foi a coisa mais interessante ou surpreendente que voc√™ descobriu/aprendeu usando a tecnologia esta semana?</label>
                                    <textarea id="profile-q3" rows="3" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" placeholder="Pode ser um atalho, um site, uma not√≠cia..."></textarea>
                                </div>
                            </div>
                            
                            <hr class="my-8">

                            <!-- Perfil Colorido -->
                            <h2 class="text-2xl font-bold mb-4">Personaliza√ß√£o</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Sele√ß√£o de Avatar (Emoji) -->
                                <div>
                                    <label class="block text-lg font-semibold text-gray-800 mb-2">Escolha seu Avatar (Emoji)</label>
                                    <div class="flex flex-wrap gap-2">
                                        <button type="button" class="avatar-select text-3xl p-2 rounded-lg hover:bg-gray-200 focus:bg-indigo-200 focus:ring-2 focus:ring-indigo-500">üòÄ</button>
                                        <button type="button" class="avatar-select text-3xl p-2 rounded-lg hover:bg-gray-200 focus:bg-indigo-200 focus:ring-2 focus:ring-indigo-500">üòé</button>
                                        <button type="button" class="avatar-select text-3xl p-2 rounded-lg hover:bg-gray-200 focus:bg-indigo-200 focus:ring-2 focus:ring-indigo-500">ü•≥</button>
                                        <button type="button" class="avatar-select text-3xl p-2 rounded-lg hover:bg-gray-200 focus:bg-indigo-200 focus:ring-2 focus:ring-indigo-500">ü§î</button>
                                        <button type="button" class="avatar-select text-3xl p-2 rounded-lg hover:bg-gray-200 focus:bg-indigo-200 focus:ring-2 focus:ring-indigo-500">üßë‚Äçüíª</button>
                                        <button type="button" class="avatar-select text-3xl p-2 rounded-lg hover:bg-gray-200 focus:bg-indigo-200 focus:ring-2 focus:ring-indigo-500">üöÄ</button>
                                        <button type="button" class="avatar-select text-3xl p-2 rounded-lg hover:bg-gray-200 focus:bg-indigo-200 focus:ring-2 focus:ring-indigo-500">üí°</button>
                                        <button type="button" class="avatar-select text-3xl p-2 rounded-lg hover:bg-gray-200 focus:bg-indigo-200 focus:ring-2 focus:ring-indigo-500">üé®</button>
                                    </div>
                                    <input type="hidden" id="profile-avatar">
                                </div>
                                <!-- Sele√ß√£o de Cor Tema -->
                                <div>
                                    <label class="block text-lg font-semibold text-gray-800 mb-2">Escolha sua Cor Tema</label>
                                    <div class="flex flex-wrap gap-2">
                                        <button type="button" class="color-select w-10 h-10 rounded-full bg-indigo-500 ring-offset-2 hover:ring-4" data-color="indigo"></button>
                                        <button type="button" class="color-select w-10 h-10 rounded-full bg-purple-500 ring-offset-2 hover:ring-4" data-color="purple"></button>
                                        <button type="button" class="color-select w-10 h-10 rounded-full bg-pink-500 ring-offset-2 hover:ring-4" data-color="pink"></button>
                                        <button type="button" class="color-select w-10 h-10 rounded-full bg-teal-500 ring-offset-2 hover:ring-4" data-color="teal"></button>
                                        <button type="button" class="color-select w-10 h-10 rounded-full bg-orange-500 ring-offset-2 hover:ring-4" data-color="orange"></button>
                                        <button type="button" class="color-select w-10 h-10 rounded-full bg-gray-700 ring-offset-2 hover:ring-4" data-color="gray"></button>
                                    </div>
                                    <input type="hidden" id="profile-color">
                                </div>
                            </div>

                            <button type="submit" class="mt-8 w-full md:w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition-transform transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                Salvar Perfil
                            </button>
                        </form>
                    </div>
                </div>

                <!-- ===== 3. TELA DO JOGO (SORTEIO, ADIVINHA√á√ÉO, FEEDBACK) ===== -->
                <div id="game-view" class="hidden fade-in">
                    <button class="mb-4 text-indigo-600 font-medium" onclick="showView('dashboard-view')">&larr; Voltar ao Dashboard</button>
                    
                    <!-- 3a. Anima√ß√£o de Sorteio -->
                    <div id="game-draw-animation" class="hidden text-center p-8 bg-white rounded-2xl shadow-xl">
                        <h2 class="text-3xl font-bold mb-4">Sorteio em Andamento!</h2>
                        <p class="text-lg text-gray-600 mb-8">Estamos encontrando seu amigo secreto...</p>
                        <div id="gift-box-animation" class="cursor-pointer inline-block" title="Clique para abrir!">
                            <span class="text-9xl gift-box-shake">üéÅ</span>
                        </div>
                        <p class="mt-4 text-gray-500 italic">Clique na caixa para revelar!</p>
                    </div>

                    <!-- 3b. Tela de Adivinha√ß√£o -->
                    <div id="game-guess-panel" class="hidden">
                        <!-- O card de dicas ser√° colorido dinamicamente -->
                        <div id="guess-card" class="rounded-2xl shadow-xl p-6 md:p-8 transition-all duration-500">
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <h2 class="text-3xl font-bold text-white">Decifre o Enigma!</h2>
                                    <p class="text-lg text-white/80">Voc√™ tirou uma pessoa que...</p>
                                </div>
                                <span id="guess-avatar" class="text-5xl bg-white/20 p-2 rounded-lg"></span>
                            </div>
                            
                            <!-- Dicas -->
                            <div class="space-y-4 text-white">
                                <div class="bg-white/20 p-4 rounded-lg shadow">
                                    <p class="font-medium opacity-80 mb-1">...criaria um app para:</p>
                                    <p class="text-lg font-semibold" id="guess-q1">...</p>
                                </div>
                                <div class="bg-white/20 p-4 rounded-lg shadow">
                                    <p class="font-medium opacity-80 mb-1">...gostaria de ter esta tecnologia:</p>
                                    <p class="text-lg font-semibold" id="guess-q2">...</p>
                                </div>
                                <div class="bg-white/20 p-4 rounded-lg shadow">
                                    <p class="font-medium opacity-80 mb-1">...descobriu/aprendeu isso:</p>
                                    <p class="text-lg font-semibold" id="guess-q3">...</p>
                                </div>
                            </div>

                            <!-- Formul√°rio de Adivinha√ß√£o -->
                            <div class="mt-8">
                                <h3 class="text-2xl font-bold text-white mb-4">Quem voc√™ acha que √©?</h3>
                                <div class="flex flex-col sm:flex-row gap-4">
                                    <select id="guess-select" class="flex-grow w-full sm:w-auto px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-white bg-white text-gray-900">
                                        <option value="">Selecione um nome...</option>
                                        <!-- Nomes da turma ser√£o preenchidos aqui -->
                                    </select>
                                    <button id="guess-submit-btn" class="bg-white text-gray-900 font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-gray-100 transition-transform transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2">
                                        Adivinhar!
                                    </button>
                                </div>
                                <p id="guess-feedback" class="text-white font-medium mt-4 text-center"></p>
                                <p id="guess-attempts" class="text-white/80 text-sm mt-2 text-center">Tentativas restantes: 3</p>
                            </div>
                        </div>
                    </div>

                    <!-- 3c. Tela de Enviar Feedback (Ap√≥s acertar) -->
                    <div id="game-feedback-panel" class="hidden">
                        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
                            <div class="text-center mb-6">
                                <h2 class="text-3xl font-bold text-green-600">Voc√™ acertou!</h2>
                                <p class="text-xl text-gray-700">Seu amigo secreto √© <strong id="feedback-receiver-name" class="font-bold">...</strong>.</p>
                                <p class="text-gray-600 mt-2">Agora √© hora de preparar o presente! Lembre-se, seu nome ser√° mantido em segredo.</p>
                                <button id="feedback-tips-btn" class="mt-4 text-sm text-indigo-600 font-medium hover:underline">Ver dicas de como dar um bom feedback</button>
                            </div>

                            <form id="feedback-form">
                                <!-- Estrutura Guiada -->
                                <div class="space-y-6">
                                    <div>
                                        <label class="block text-lg font-semibold text-gray-800 mb-2">1. Algo que eu realmente admiro em voc√™ √©...</label>
                                        <textarea id="feedback-admire" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" placeholder="Seja espec√≠fico e positivo!"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-lg font-semibold text-gray-800 mb-2">2. Uma sugest√£o que eu te daria como amigo(a) √©...</label>
                                        <textarea id="feedback-suggest" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" placeholder="Uma dica construtiva e gentil."></textarea>
                                    </div>
                                </div>

                                <hr class="my-8">

                                <!-- Escolha do Presente -->
                                <h2 class="text-2xl font-bold mb-4">Meu Presente para Voc√™</h2>
                                <p class="text-gray-600 mb-4">Escolha **UMA** op√ß√£o de presente (real ou zueira).</p>
                                <div class="flex gap-4 mb-4">
                                    <label class="flex-1 p-4 border border-gray-300 rounded-lg has-[:checked]:bg-indigo-50 has-[:checked]:border-indigo-500 transition-all cursor-pointer">
                                        <input type="radio" name="present-type" value="real" class="mr-2 accent-indigo-600">
                                        <span class="text-lg font-bold">üéÅ Presente Real</span>
                                    </label>
                                    <label class="flex-1 p-4 border border-gray-300 rounded-lg has-[:checked]:bg-pink-50 has-[:checked]:border-pink-500 transition-all cursor-pointer">
                                        <input type="radio" name="present-type" value="zueira" class="mr-2 accent-pink-600">
                                        <span class="text-lg font-bold">ü§™ Presente da Zueira</span>
                                    </label>
                                </div>

                                <!-- Campos de Presente (din√¢micos) -->
                                <div id="present-real-box" class="hidden space-y-4">
                                    <div>
                                        <label class="block text-lg font-semibold text-gray-800 mb-2">Qual presente "real" voc√™ daria?</label>
                                        <input type="text" id="feedback-present-real" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" placeholder="Ex: Um livro, um fone de ouvido, uma planta...">
                                    </div>
                                    <div>
                                        <label class="block text-lg font-semibold text-gray-800 mb-2">Por que voc√™ daria esse presente?</label>
                                        <textarea id="feedback-justification-real" rows="2" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500" placeholder="Justifique sua escolha..."></textarea>
                                    </div>
                                </div>
                                <div id="present-zueira-box" class="hidden space-y-4">
                                    <div>
                                        <label class="block text-lg font-semibold text-gray-800 mb-2">Qual presente da "zueira" voc√™ daria?</label>
                                        <input type="text" id="feedback-present-zueira" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-pink-500" placeholder="Ex: Um alarme que n√£o desliga, um √≥culos de sol...">
                                    </div>
                                    <div>
                                        <label class="block text-lg font-semibold text-gray-800 mb-2">Por que voc√™ daria esse presente?</label>
                                        <textarea id="feedback-justification-zueira" rows="2" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-pink-500" placeholder="Explique a piada..."></textarea>
                                    </div>
                                </div>
                                <p id="present-error" class="text-red-500 text-sm mt-4 text-center"></p>

                                <button type="submit" class="mt-8 w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 transition-transform transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                    Enviar Presente e Feedback!
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- 3d. Tela de Espera (Ap√≥s enviar) -->
                    <div id="game-wait-panel" class="hidden text-center p-8 bg-white rounded-2xl shadow-xl">
                        <h2 class="text-3xl font-bold mb-4">Feedback Enviado!</h2>
                        <p class="text-lg text-gray-600 mb-8">Obrigado pela sua participa√ß√£o. Agora s√≥ precisamos esperar o administrador liberar a entrega dos presentes para todos.</p>
                        <span class="text-8xl">üëç</span>
                        <p class="mt-6 text-gray-500">Enquanto espera, que tal jogar o <button class="font-bold text-indigo-600 hover:underline" onclick="showView('quiz-view')">Quiz Surpresa</button>?</button></p>
                    </div>

                </div>

                <!-- ===== 4. ESTANTE DE PRESENTES ===== -->
                <div id="shelf-view" class="hidden fade-in">
                    <button class="mb-4 text-indigo-600 font-medium" onclick="showView('dashboard-view')">&larr; Voltar ao Dashboard</button>
                    <div class="bg-white shadow-xl rounded-2xl p-6 md:p-8">
                        <h1 class="text-3xl font-bold mb-6">üéÅ Minha Estante de Presentes</h1>
                        <div id="shelf-content" class="space-y-6">
                            <!-- Os feedbacks recebidos ser√£o inseridos aqui -->
                            <p id="shelf-empty-msg" class="text-gray-500 text-center py-8">Sua estante est√° vazia. Quando o admin liberar os presentes, eles aparecer√£o aqui!</p>
                        </div>
                    </div>
                </div>

                <!-- ===== 5. MEU PAINEL PESSOAL (ESTAT√çSTICAS) ===== -->
                <div id="stats-view" class="hidden fade-in">
                    <button class="mb-4 text-indigo-600 font-medium" onclick="showView('dashboard-view')">&larr; Voltar ao Dashboard</button>
                    <div class="bg-white shadow-xl rounded-2xl p-6 md:p-8">
                        <h1 class="text-3xl font-bold mb-6">üìä Meu Painel Pessoal</h1>
                        
                        <!-- Estat√≠sticas -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                            <div class="bg-gray-100 p-4 rounded-lg text-center">
                                <p class="text-sm font-medium text-gray-600">Feedbacks Enviados</p>
                                <p id="stats-sent" class="text-3xl font-bold text-indigo-600">0</p>
                            </div>
                            <div class="bg-gray-100 p-4 rounded-lg text-center">
                                <p class="text-sm font-medium text-gray-600">Rea√ß√µes Recebidas</p>
                                <p id="stats-reactions" class="text-3xl font-bold text-indigo-600">0</p>
                            </div>
                            <div class="bg-gray-100 p-4 rounded-lg text-center">
                                <p class="text-sm font-medium text-gray-600">Qu√£o Enigm√°tico?</p>
                                <p id="stats-enigma" class="text-lg font-bold text-indigo-600">Ainda sem dados</p>
                                <p class="text-xs text-gray-500">(M√©dia de tent. para te achar)</p>
                            </div>
                        </div>

                        <!-- Conquistas (Badges) -->
                        <h2 class="text-2xl font-bold mb-4">Minhas Conquistas (Badges)</h2>
                        <div id="stats-badges" class="flex flex-wrap gap-3">
                            <p id="stats-badges-empty" class="text-gray-500">Voc√™ ainda n√£o ganhou nenhuma conquista. Continue participando!</p>
                            <!-- Badges ser√£o inseridas aqui -->
                        </div>
                    </div>
                </div>

                <!-- ===== 6. MURAL DE DICAS ===== -->
                <div id="hint-mural-view" class="hidden fade-in">
                    <button class="mb-4 text-indigo-600 font-medium" onclick="showView('dashboard-view')">&larr; Voltar ao Dashboard</button>
                    <div class="bg-white shadow-xl rounded-2xl p-6 md:p-8">
                        <h1 class="text-3xl font-bold mb-2">üïµÔ∏è Mural de Dicas</h1>
                        <p class="text-gray-600 mb-6">Est√° dif√≠cil adivinhar? Veja dicas extras (an√¥nimas) que a turma postou. (Aprovadas pelo admin).</p>
                        
                        <!-- Formul√°rio para postar dica -->
                        <form id="hint-mural-form" class="mb-6 p-4 bg-gray-50 rounded-lg border">
                            <label class="block text-lg font-semibold text-gray-800 mb-2">Postar uma dica an√¥nima sobre voc√™</h3c>
                            <textarea id="hint-mural-text" rows="2" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Ex: Eu uso √≥culos..."></textarea>
                            <button type="submit" class="mt-2 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-transform">
                                Enviar para Aprova√ß√£o
                            </button>
                        </form>

                        <!-- Lista de Dicas -->
                        <div id="hint-mural-list" class="space-y-4">
                            <p id="hint-mural-empty" class="text-gray-500 text-center py-8">Nenhuma dica aprovada no mural ainda.</p>
                            <!-- Dicas aprovadas ser√£o inseridas aqui -->
                        </div>
                    </div>
                </div>

                <!-- ===== 7. MURAL DE AGRADECIMENTOS ===== -->
                <div id="thanks-mural-view" class="hidden fade-in">
                    <button class="mb-4 text-indigo-600 font-medium" onclick="showView('dashboard-view')">&larr; Voltar ao Dashboard</button>
                    <div class="bg-white shadow-xl rounded-2xl p-6 md:p-8">
                        <h1 class="text-3xl font-bold mb-2">üôè Mural de Agradecimentos</h1>
                        <p class="text-gray-600 mb-6">Deixe uma mensagem **n√£o-an√¥nima** para a turma sobre a experi√™ncia!</p>
                        
                        <div id="thanks-mural-disabled" class="hidden text-center p-6 bg-gray-100 rounded-lg">
                            <p class="text-lg font-medium text-gray-700">O Mural de Agradecimentos ainda n√£o foi liberado pelo administrador. Ele fica dispon√≠vel apenas no final da brincadeira.</p>
                        </div>
                        
                        <div id="thanks-mural-enabled" class="hidden">
                            <!-- Formul√°rio para postar -->
                            <form id="thanks-mural-form" class="mb-6 p-4 bg-gray-50 rounded-lg border">
                                <label class="block text-lg font-semibold text-gray-800 mb-2">Sua mensagem (ser√° p√∫blica):</label>
                                <textarea id="thanks-mural-text" rows="3" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm" placeholder="Ex: Adorei a brincadeira, pessoal! Obrigado pelos feedbacks."></textarea>
                                <button type="submit" class="mt-2 bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-transform">
                                    Postar Agradecimento
                                </button>
                            </form>

                            <!-- Lista de Posts -->
                            <div id="thanks-mural-list" class="space-y-4">
                                <p id="thanks-mural-empty" class="text-gray-500 text-center py-8">Ningu√©m agradeceu ainda. Seja o primeiro!</p>
                                <!-- Posts ser√£o inseridos aqui -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== 8. QUIZ SURPRESA ===== -->
                <div id="quiz-view" class="hidden fade-in">
                    <button class="mb-4 text-indigo-600 font-medium" onclick="showView('dashboard-view')">&larr; Voltar ao Dashboard</button>
                    <div class="bg-white shadow-xl rounded-2xl p-6 md:p-8">
                        <h1 class="text-3xl font-bold mb-6">üß† Quiz Surpresa de TI</h1>
                        <div id="quiz-content" class="text-center">
                            <!-- O quiz ser√° carregado aqui -->
                            <p id="quiz-loading" class="text-gray-600">Carregando pergunta...</p>
                        </div>
                        <div id="quiz-result" class="hidden text-center mt-6">
                            <p class="text-2xl font-bold" id="quiz-result-text"></p>
                            <p id="quiz-result-explanation" class="text-gray-700 mt-2"></p>
                            <button id="quiz-next-btn" class="mt-6 bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-transform">
                                Pr√≥xima Pergunta
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ===== 9. PAINEL DE ADMINISTRA√á√ÉO ===== -->
                <div id="admin-view" class="hidden fade-in">
                    <button class="mb-4 text-indigo-600 font-medium" onclick="showView('dashboard-view')">&larr; Voltar ao Dashboard</button>
                    <div class="bg-white shadow-xl rounded-2xl p-6 md:p-8">
                        <h1 class="text-3xl font-bold mb-6">Painel do Administrador</h1>

                        <!-- Setup Inicial do Admin -->
                        <div id="admin-setup-panel" class="hidden p-6 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg mb-6">
                            <h3 class="text-xl font-bold text-yellow-800 mb-2">Aten√ß√£o: A√ß√£o Necess√°ria!</h3>
                            <p class="text-yellow-700 mb-4">Sua turma ainda n√£o tem um administrador. Defina uma senha de admin para proteger este painel. (Qualquer um pode fazer isso **uma vez**).</p>
                            <form id="admin-password-form" class="flex gap-4">
                                <input type="password" id="admin-password-input" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Crie uma senha de admin" required>
                                <button type="submit" class="bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-700">Salvar Senha</button>
                            </form>
                        </div>

                        <!-- Verifica√ß√£o de Senha do Admin -->
                        <div id="admin-lock-panel" class="hidden p-6 bg-gray-100 rounded-lg mb-6 text-center">
                            <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Painel Protegido</h3>
                            <form id="admin-check-form" class="flex flex-col max-w-sm mx-auto gap-4">
                                <input type="password" id="admin-check-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Digite a senha de admin" required>
                                <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">Desbloquear</button>
                            </form>
                            <p id="admin-check-error" class="text-red-500 text-sm mt-4"></p>
                        </div>

                        <!-- Conte√∫do Principal do Admin (Protegido) -->
                        <div id="admin-content" class="hidden">
                            <!-- A√ß√µes do Jogo -->
                            <div class="mb-8">
                                <h2 class="text-2xl font-bold mb-4">Controle do Jogo (Rodada <span id="admin-current-round">0</span>)</h2>
                                <div id="admin-game-status" class="mb-4 p-4 bg-gray-100 rounded-lg font-medium">
                                    Status atual: <span id="admin-status-text" class="font-bold text-indigo-600">...</span>
                                </div>
                                <div class="flex flex-wrap gap-4">
                                    <button id="admin-start-round-btn" class="bg-green-600 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:bg-green-700 transition-transform">
                                        Iniciar Sorteio (Rodada <span id="admin-next-round-num">1</span>)
                                    </button>
                                    <button id="admin-release-gifts-btn" class="bg-blue-600 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:bg-blue-700 transition-transform" disabled>
                                        Liberar Entrega de Presentes
                                    </button>
                                    <button id="admin-enable-thanks-btn" class="bg-purple-600 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:bg-purple-700 transition-transform" disabled>
                                        Liberar Mural de Agradecimentos
                                    </button>
                                    <button id="admin-seed-quiz-btn" class="bg-gray-700 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:bg-gray-800 transition-transform">
                                        (Re)Carregar Banco de Quest√µes
                                    </button>
                                </div>
                            </div>

                            <!-- Progresso da Turma -->
                            <div class="mb-8">
                                <h2 class="text-2xl font-bold mb-4">Progresso da Turma</h2>
                                <div class="mb-4">
                                    <label class="font-medium">Perfis Conclu√≠dos:</label>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div id="admin-progress-profile" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label class="font-medium">Adivinha√ß√µes Conclu√≠das:</label>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div id="admin-progress-guess" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label class="font-medium">Feedbacks Enviados:</label>
                                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                                        <div id="admin-progress-feedback" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div id="admin-participant-list" class="max-h-60 overflow-y-auto no-scrollbar p-4 bg-gray-50 rounded-lg border">
                                    <!-- Lista de participantes -->
                                </div>
                            </div>
                            
                            <!-- Nuvem de Palavras -->
                            <div class="mb-8">
                                <h2 class="text-2xl font-bold mb-4">Nuvem de Palavras Positivas</h2>
                                <p class="text-gray-600 mb-4">Gerada a partir dos campos "Algo que admiro em voc√™..." de **todas** as rodadas.</p>
                                <button id="admin-wordcloud-btn" class="mb-4 bg-indigo-100 text-indigo-700 font-bold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-200">Gerar/Atualizar Nuvem</button>
                                <div class="w-full h-80 bg-gray-100 rounded-lg flex items-center justify-center">
                                    <canvas id="wordcloud-canvas" width="600" height="320"></canvas>
                                    <p id="wordcloud-empty" class="text-gray-500">Nenhum feedback positivo enviado ainda.</p>
                                </div>
                            </div>
                            
                            <!-- Mural de Dicas - Aprova√ß√£o -->
                            <div class="mb-8">
                                <h2 class="text-2xl font-bold mb-4">Aprovar Dicas do Mural</h2>
                                <div id="admin-hint-approval-list" class="max-h-60 overflow-y-auto no-scrollbar p-4 bg-gray-50 rounded-lg border">
                                    <p id="admin-hint-empty" class="text-gray-500 text-center">Nenhuma dica pendente de aprova√ß√£o.</p>
                                    <!-- Dicas para aprovar -->
                                </div>
                            </div>

                            <!-- Relat√≥rio Final -->
                            <div class="mb-8">
                                <h2 class="text-2xl font-bold mb-4">Relat√≥rio Final da Turma</h2>
                                <button id="admin-report-btn" class="mb-4 bg-indigo-100 text-indigo-700 font-bold py-2 px-4 rounded-lg shadow-sm hover:bg-indigo-200">Gerar/Atualizar Relat√≥rio</BUtton>
                                <div id="admin-report-content" class="hidden grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-gray-100 p-4 rounded-lg text-center">
                                        <p class="text-sm font-medium text-gray-600">Participa√ß√£o (√ölt. Rodada)</p>
                                        <p id="report-participation" class="text-3xl font-bold text-indigo-600">0%</p>
                                    </div>
                                    <div class="bg-gray-100 p-4 rounded-lg text-center">
                                        <p class="text-sm font-medium text-gray-600">M√©dia de Tentativas</p>
                                        <p id="report-avg-guesses" class="text-3xl font-bold text-indigo-600">0.0</p>
                                    </div>
                                    <div class="bg-gray-100 p-4 rounded-lg text-center">
                                        <p class="text-sm font-medium text-gray-600">Total de Feedbacks</p>
                                        <p id="report-total-feedbacks" class="text-3xl font-bold text-indigo-600">0</p>
                                    </div>
                                    <div class="bg-gray-100 p-4 rounded-lg md:col-span-3">
                                        <p class="text-sm font-medium text-gray-600 text-center mb-2">Badges Mais Conquistadas</p>
                                        <div id="report-top-badges" class="flex flex-wrap justify-center gap-2">
                                            <p class="text-gray-500 text-sm">Sem dados</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Gest√£o de Badges Manuais -->
                            <div class="mb-8">
                                <h2 class="text-2xl font-bold mb-4">Gerenciar Badges Manuais</h2>
                                <p class="text-gray-600 mb-4">Conceda badges de "Escritor(a) de Ouro" ou "Mestre do Enigma" para os alunos que se destacaram.</p>
                                <div class="flex flex-col sm:flex-row gap-4">
                                    <select id="admin-badge-user" class="flex-grow w-full sm:w-auto px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-white">
                                        <option value="">Selecione um aluno...</option>
                                    </select>
                                    <select id="admin-badge-name" class="flex-grow w-full sm:w-auto px-4 py-3 border border-gray-300 rounded-lg shadow-sm bg-white">
                                        <option value="Escritor(a) de Ouro">Escritor(a) de Ouro</option>
                                        <option value="Mestre do Enigma">Mestre do Enigma</option>
                                    </select>
                                    <button id="admin-badge-submit" class="bg-yellow-500 text-white font-bold py-3 px-5 rounded-lg shadow-md hover:bg-yellow-600">
                                        Conceder Badge
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

            </main>
        </div>

        <!-- ===== MODAL CONTAINER ===== -->
        <div id="modal-container" class="hidden fixed inset-0 z-50 overflow-y-auto">
            <div class="flex items-center justify-center min-h-screen p-4">
                <!-- Backdrop -->
                <div class="fixed inset-0 bg-black/60 transition-opacity" id="modal-backdrop"></div>
                
                <!-- Conte√∫do do Modal -->
                <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 md:p-8 z-10 fade-in" id="modal-content">
                    <!-- O conte√∫do do modal ser√° inserido dinamicamente aqui -->
                </div>
            </div>
        </div>

    </div>

    <!-- ===== TEMPLATES (para clonar) ===== -->
    <template id="shelf-card-template">
        <div class="bg-gray-50 border border-gray-200 rounded-xl shadow-lg p-6 fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Rodada <span data-id="round-number"></span></h3>
                <span data-id="present-emoji" class="text-4xl"></span>
            </div>
            
            <p class="text-gray-500 mb-1">Seu amigo(a) secreto(a) disse:</p>
            <blockquote class="border-l-4 border-indigo-300 pl-4 py-2 bg-indigo-50 rounded-r-lg mb-4">
                <p class="text-lg font-semibold text-gray-800 mb-2">"Algo que admiro em voc√™ √©..."</p>
                <p class="text-gray-700 italic" data-id="admire-text"></p>
            </blockquote>
            <blockquote class="border-l-4 border-orange-300 pl-4 py-2 bg-orange-50 rounded-r-lg mb-4">
                <p class="text-lg font-semibold text-gray-800 mb-2">"Uma sugest√£o que eu te daria √©..."</p>
                <p class="text-gray-700 italic" data-id="suggest-text"></p>
            </blockquote>
            
            <p class="text-gray-500 mb-1">E te deu este presente:</p>
            <div class="bg-white border border-gray-200 p-4 rounded-lg">
                <p class="text-lg font-bold text-gray-900" data-id="present-text"></p>
                <p class="text-gray-600 text-sm mt-1"><strong>Justificativa:</strong> <span data-id="justification-text"></span></p>
            </div>

            <!-- Rea√ß√µes -->
            <div class="mt-6">
                <p class="text-sm font-medium text-gray-600 mb-2">Como voc√™ se sentiu? (Enviar rea√ß√£o an√¥nima)</p>
                <div class="flex space-x-2" data-id="reaction-buttons">
                    <button class="reaction-btn text-2xl p-2 rounded-lg hover:bg-gray-200 transition-all" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</button>
                    <button class="reaction-btn text-2xl p-2 rounded-lg hover:bg-gray-200 transition-all" data-emoji="üòÇ">üòÇ</button>
                    <button class="reaction-btn text-2xl p-2 rounded-lg hover:bg-gray-200 transition-all" data-emoji="üí°">üí°</button>
                    <button class="reaction-btn text-2xl p-2 rounded-lg hover:bg-gray-200 transition-all" data-emoji="üôè">üôè</button>
                    <button class="reaction-btn text-2xl p-2 rounded-lg hover:bg-gray-200 transition-all" data-emoji="üëç">üëç</button>
                </div>
                <p data-id="reaction-sent" class="hidden text-lg font-medium text-green-700">Rea√ß√£o enviada! <span data-id="sent-emoji"></span></p>
            </div>
        </div>
    </template>

    <template id="badge-template">
        <div class="inline-flex items-center gap-2 bg-yellow-100 text-yellow-800 font-bold px-3 py-1.5 rounded-full text-sm shadow-md" data-tippy-content="">
            <span data-id="badge-icon" class="text-lg"></span>
            <span data-id="badge-name"></span>
        </div>
    </template>

    <template id="hint-mural-card-template">
        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 shadow-sm">
            <p class="text-lg italic text-indigo-900">"..."</p>
            <button data-id="use-hint-btn" class="text-sm text-indigo-600 font-medium hover:underline mt-2">Usar esta dica (conquista O(A) Observador(a))</button>
        </div>
    </template>

    <template id="thanks-mural-card-template">
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 shadow-sm">
            <p class="text-lg text-green-900 mb-2">"..."</p>
            <p class="text-sm font-bold text-green-700">- ...</p>
        </div>
    </template>

    <template id="admin-hint-approval-card-template">
        <div class="p-4 bg-white border rounded-lg mb-2 flex items-center justify-between">
            <p class="text-gray-700 italic">"..."</p>
            <div class="flex gap-2">
                <button data-id="approve-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold p-2 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </button>
                <button data-id="reject-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold p-2 rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>
    </template>

    <template id="admin-participant-card-template">
        <div class="p-3 bg-white border rounded-lg mb-2 flex justify-between items-center">
            <div>
                <p class="font-bold text-gray-800" data-id="name"></p>
                <p class="text-xs text-gray-500" data-id="email"></p>
            </div>
            <div class="flex gap-2 text-sm">
                <span data-id="profile-status" class="px-2 py-0.5 rounded-full font-medium"></span>
                <span data-id="guess-status" class="px-2 py-0.5 rounded-full font-medium"></span>
                <span data-id="feedback-status" class="px-2 py-0.5 rounded-full font-medium"></span>
            </div>
        </div>
    </template>

    <template id="quiz-question-template">
        <h2 class="text-2xl font-bold mb-4" data-id="question-text"></h2>
        <div class="space-y-3" data-id="options-list">
            <!-- Op√ß√µes ser√£o inseridas aqui -->
        </div>
    </template>

    <template id="quiz-option-template">
        <button class="w-full text-left p-4 bg-gray-100 border border-gray-300 rounded-lg hover:bg-indigo-100 hover:border-indigo-500 transition-all text-lg font-medium">
        </button>
    </template>

    <template id="modal-feedback-tips-template">
        <h2 class="text-2xl font-bold mb-4">üí° Dicas para um Feedback de Ouro</h2>
        <p class="text-gray-600 mb-6">Lembre-se, o objetivo √© ajudar seu colega a se sentir bem e a crescer. Seu anonimato est√° garantido.</p>
        <ul class="space-y-4">
            <li class="flex items-start">
                <span class="text-green-500 text-2xl mr-3">‚úÖ</span>
                <div>
                    <strong class="font-semibold text-gray-800">Seja Espec√≠fico(a) no Elogio.</strong>
                    <p class="text-gray-600">Em vez de "voc√™ √© legal", diga: "Eu admiro como voc√™ sempre ajuda quem est√° com dificuldade na mat√©ria."</p>
                </div>
            </li>
            <li class="flex items-start">
                <span class="text-green-500 text-2xl mr-3">‚úÖ</span>
                <div>
                    <strong class="font-semibold text-gray-800">Foque na A√ß√£o, n√£o na Pessoa.</strong>
                    <p class="text-gray-600">Na sugest√£o, em vez de "voc√™ √© distra√≠do", diga: "Minha sugest√£o √© tentar focar um pouco mais quando o professor est√° explicando X."</t>
                </div>
            </li>
            <li class="flex items-start">
                <span class="text-green-500 text-2xl mr-3">‚úÖ</span>
                <div>
                    <strong class="font-semibold text-gray-800">Seja Gentil e Construtivo(a).</strong>
                    <p class="text-gray-600">A ideia √© uma sugest√£o de amigo. Pense em como voc√™ gostaria de receber uma dica para melhorar.</p>
                </div>
            </li>
        </ul>
        <button id="modal-close-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">
            Entendi!
        </button>
    </template>

    <template id="modal-alert-template">
        <h2 class="text-2xl font-bold mb-4" data-id="title"></h2>
        <p class="text-gray-700 text-lg" data-id="message"></p>
        <button id="modal-close-btn" class="mt-6 w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700">
            Fechar
        </button>
    </template>


    <!-- ============================================= -->
    <!-- ========== SCRIPT PRINCIPAL DA APP ========== -->
    <!-- ============================================= -->
    <script type="module">
        // Importa√ß√µes (j√° carregadas no window.firebase)
        const {
            initializeApp, getAuth, setPersistence, inMemoryPersistence, createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, signOut, onAuthStateChanged,
            getFirestore, doc, setDoc, getDoc, addDoc, updateDoc, onSnapshot, 
            collection, query, where, getDocs, writeBatch, increment, serverTimestamp
        } = window.firebase;

        // ===== CONFIGURA√á√ÉO DO FIREBASE =====
        // COLE A CONFIGURA√á√ÉO DO SEU PROJETO AQUI
        const firebaseConfig = {
            apiKey: "AIzaSyDnqK4Hx-Y_Hr9_Cc5oKD9g6RTZSe-eBTA",
            authDomain: "conexao-secreta.firebaseapp.com",
            projectId: "conexao-secreta",
            storageBucket: "conexao-secreta.firebasestorage.app",
            messagingSenderId: "156846006416",
            appId: "1:156846006416:web:9e87f70a3afe9e8264b815",
            measurementId: "G-G4KFHMMCTJ"
        };
        // ===================================

        // Vari√°veis Globais de Estado
        let app, auth, db;
        let currentUser = null;
        let currentUserData = null;
        let currentTurmaId = null;
        let currentTurmaData = null;
        let turmaMembers = []; // Lista de {id, nome, perfilCompleto}
        let currentRoundPairings = []; // Lista de {giverId, receiverId, status, attempts}
        let unsubscribeTurmaListener = null;
        let unsubscribeMembersListener = null;
        let unsubscribeRoundListener = null;
        let unsubscribeHintListener = null;
        let unsubscribeThanksListener = null;
        let adminUnlocked = false; // Flag para painel de admin

        // IDs dos Elementos do DOM (para facilitar)
        const allViews = ['login-view', 'app-view', 'loading-spinner', 'dashboard-view', 'profile-view', 'game-view', 'shelf-view', 'stats-view', 'hint-mural-view', 'thanks-mural-view', 'quiz-view', 'admin-view'];
        const gamePanels = ['game-draw-animation', 'game-guess-panel', 'game-feedback-panel', 'game-wait-panel'];
        const el = (id) => document.getElementById(id);

        // Paleta de Cores do Tema
        const themeColors = {
            indigo: { bg: 'bg-indigo-500', text: 'text-indigo-500', ring: 'ring-indigo-500', hover: 'hover:bg-indigo-600', border: 'border-indigo-500', accent: 'accent-indigo-600' },
            purple: { bg: 'bg-purple-500', text: 'text-purple-500', ring: 'ring-purple-500', hover: 'hover:bg-purple-600', border: 'border-purple-500', accent: 'accent-purple-600' },
            pink: { bg: 'bg-pink-500', text: 'text-pink-500', ring: 'ring-pink-500', hover: 'hover:bg-pink-600', border: 'border-pink-500', accent: 'accent-pink-600' },
            teal: { bg: 'bg-teal-500', text: 'text-teal-500', ring: 'ring-teal-500', hover: 'hover:bg-teal-600', border: 'border-teal-500', accent: 'accent-teal-600' },
            orange: { bg: 'bg-orange-500', text: 'text-orange-500', ring: 'ring-orange-500', hover: 'hover:bg-orange-600', border: 'border-orange-500', accent: 'accent-orange-600' },
            gray: { bg: 'bg-gray-700', text: 'text-gray-700', ring: 'ring-gray-700', hover: 'hover:bg-gray-800', border: 'border-gray-700', accent: 'accent-gray-700' },
        };

        // Conquistas (Badges) - Defini√ß√µes
        const badgeDefs = {
            "Detetive de Primeira": { icon: "üéØ", color: "bg-green-100 text-green-800", description: "Acertou o amigo secreto na primeira tentativa." },
            "Escritor(a) de Ouro": { icon: "‚úçÔ∏è", color: "bg-yellow-100 text-yellow-800", description: "Escreveu um feedback de alta qualidade (concedido pelo admin)." },
            "Turma Unida": { icon: "ü§ù", color: "bg-blue-100 text-blue-800", description: "Todos na turma enviaram seus feedbacks na rodada." },
            "Veterano(a) da Conex√£o": { icon: "üèÖ", color: "bg-purple-100 text-purple-800", description: "Completou 3 ou mais rodadas." },
            "Queridinho(a) An√¥nimo(a)": { icon: "üíñ", color: "bg-pink-100 text-pink-800", description: "Recebeu 5+ rea√ß√µes positivas nos feedbacks que escreveu." },
            "Mestre do Enigma": { icon: "üß©", color: "bg-gray-100 text-gray-800", description: "Seu perfil foi o mais dif√≠cil de adivinhar (concedido pelo admin)." },
            "O(A) Observador(a)": { icon: "üëÄ", color: "bg-indigo-100 text-indigo-800", description: "Usou o Mural de Dicas para ajudar a adivinhar." },
            "Perfil Completo": { icon: "‚úÖ", color: "bg-teal-100 text-teal-800", description: "Preencheu todas as perguntas do perfil." },
            "Sabe-Tudo": { icon: "üß†", color: "bg-orange-100 text-orange-800", description: "Acertou 5 ou mais perguntas no Quiz Surpresa." },
        };

        // Banco de Quest√µes do Quiz
        const quizBank = [
            { q: "Qual componente √© considerado o 'c√©rebro' do computador?", o: ["Mem√≥ria RAM", "CPU (Processador)", "Placa de V√≠deo", "HD/SSD"], a: "CPU (Processador)", ex: "A CPU (Unidade Central de Processamento) executa todas as instru√ß√µes e c√°lculos." },
            { q: "O que significa 'Phishing'?", o: ["Um tipo de v√≠rus", "Um software de edi√ß√£o", "Uma t√©cnica para pescar", "Uma tentativa de roubar dados fingindo ser um site confi√°vel"], a: "Uma tentativa de roubar dados fingindo ser um site confi√°vel", ex: "Phishing √© uma fraude onde e-mails ou sites falsos tentam 'pescar' suas senhas." },
            { q: "Qual destes √© um software, e n√£o um hardware?", o: ["Mouse", "Monitor", "Microsoft Excel", "Teclado"], a: "Microsoft Excel", ex: "Software √© um programa ou aplicativo (o que voc√™ n√£o pode tocar), hardware √© a parte f√≠sica." },
            { q: "O que significa 'IoT'?", o: ["Internet of Things (Internet das Coisas)", "International Office of Technology", "Internet on Time", "Input/Output Transfer"], a: "Internet of Things (Internet das Coisas)", ex: "IoT refere-se a dispositivos do dia-a-dia (como geladeiras, l√¢mpadas) conectados √† internet." },
            { q: "No Excel, qual s√≠mbolo inicia uma f√≥rmula?", o: ["!", "&", "=", "#"], a: "=", ex: "Toda f√≥rmula no Excel come√ßa com o sinal de igual (=)." },
            { q: "Qual a principal fun√ß√£o de um 'Firewall'?", o: ["Acelerar a internet", "Bloquear acesso n√£o autorizado √† rede", "Limpar v√≠rus do PC", "Fazer backup de arquivos"], a: "Bloquear acesso n√£o autorizado √† rede", ex: "O Firewall age como um muro de seguran√ßa entre seu PC e a internet." },
            { q: "O que √© 'Armazenamento em Nuvem'?", o: ["Salvar arquivos em um pendrive", "Salvar arquivos em servidores na internet", "Um tipo de previs√£o do tempo", "Uma mem√≥ria RAM mais r√°pida"], a: "Salvar arquivos em servidores na internet", ex: "Servi√ßos como Google Drive, OneDrive ou Dropbox s√£o exemplos de armazenamento em nuvem." },
            { q: "No Word, o que faz o atalho Ctrl + B (ou Cmd + B)?", o: ["Salvar", "Imprimir", "Colocar em Negrito", "Copiar"], a: "Colocar em Negrito", ex: "B vem de 'Bold' (Negrito em ingl√™s)." },
            { q: "Qual destes N√ÉO √© um navegador de internet?", o: ["Google Chrome", "Mozilla Firefox", "Adobe Photoshop", "Microsoft Edge"], a: "Adobe Photoshop", ex: "Photoshop √© um software de edi√ß√£o de imagens, n√£o um navegador." },
            { q: "O que √© 'Hardware'?", o: ["As partes l√≥gicas (programas)", "As partes f√≠sicas (componentes)", "Um tipo de malware", "A velocidade da internet"], a: "As partes f√≠sicas (componentes)", ex: "Hardware √© tudo o que voc√™ pode tocar: monitor, teclado, mouse, processador, etc." }
        ];

        
        // ===================================
        // ===== INICIALIZA√á√ÉO E AUTENTICA√á√ÉO =====
        // ===================================

        // Roda quando o DOM est√° pronto
        document.addEventListener('DOMContentLoaded', () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Usar persist√™ncia local para n√£o deslogar ao fechar a aba
                // setPersistence(auth, inMemoryPersistence); // Usar inMemory para dev/teste se necess√°rio
            } catch (error) {
                console.error("Erro ao inicializar Firebase:", error);
                el('loading-spinner').innerHTML = `<p class="text-red-500">Erro fatal ao conectar. Verifique o firebaseConfig.</p>`;
                return;
            }

            // O observador de autentica√ß√£o controla o estado da UI
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    loadUserDataAndInitApp(user.uid);
                } else {
                    currentUser = null;
                    currentUserData = null;
                    currentTurmaId = null;
                    adminUnlocked = false;
                    cleanupListeners(); // Limpa listeners antigos
                    el('loading-spinner').classList.add('hidden'); // <-- CORRE√á√ÉO DO BUG
                    showView('login-view');
                }
            });

            // Handlers de Login/Cadastro
            setupAuthHandlers();
            setupProfileHandlers();
            setupGameHandlers();
            setupAdminHandlers();
            setupMuralHandlers();
            setupQuizHandlers();
            setupNavigationHandlers();
        });

        // Carrega dados do usu√°rio e inicia os listeners da aplica√ß√£o
        async function loadUserDataAndInitApp(userId) {
            const userDocRef = doc(db, "users", userId);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                currentUserData = userDocSnap.data();
                currentTurmaId = currentUserData.turma;
                el('nav-turma-name').textContent = currentTurmaId;
                el('dashboard-user-name').textContent = currentUserData.nome.split(' ')[0];
                
                // Mostrar bot√£o de admin se for admin
                // REMOVIDO: O bot√£o agora √© sempre vis√≠vel, protegido por senha.
                /*
                if (currentUserData.isAdmin) {
                    el('nav-admin-btn').classList.remove('hidden');
                } else {
                    el('nav-admin-btn').classList.add('hidden');
                }
                */

                // Verifica se o perfil est√° completo
                if (!currentUserData.perfil || !currentUserData.perfil.q1 || !currentUserData.perfil.avatar) {
                    // For√ßa preenchimento do perfil
                    showMessage('Bem-vindo(a)!', 'Por favor, complete seu perfil para participar da brincadeira.', () => showView('profile-view'));
                    loadProfileForm(); // Carrega dados existentes, se houver
                } else {
                    // Perfil completo, inicia os listeners
                    await initAppListeners();
                    showView('dashboard-view');
                }
            } else {
                // Isso n√£o deveria acontecer se o cadastro funcionar
                console.error("Usu√°rio autenticado mas sem documento no Firestore.");
                showMessage('Erro', 'N√£o encontramos seus dados. Por favor, tente relogar.');
                handleLogout();
            }
            el('loading-spinner').classList.add('hidden');
        }

        // Configura os listeners principais da aplica√ß√£o (Turma, Membros, etc.)
        async function initAppListeners() {
            if (!currentTurmaId) return;
            cleanupListeners(); // Garante que n√£o haja listeners duplicados

            // Listener para o estado da turma
            const turmaDocRef = doc(db, "turmas", currentTurmaId);
            unsubscribeTurmaListener = onSnapshot(turmaDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentTurmaData = docSnap.data();
                    updateUIBasedOnGameState(currentTurmaData.status);
                } else {
                    // Admin ainda n√£o configurou a turma (senha, etc.)
                    // No nosso fluxo, o admin s√≥ aparece *depois* do usu√°rio
                }
            });

            // Listener para os membros da turma (para adivinha√ß√£o e admin)
            const membersQuery = query(collection(db, "users"), where("turma", "==", currentTurmaId));
            unsubscribeMembersListener = onSnapshot(membersQuery, (querySnapshot) => {
                turmaMembers = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    turmaMembers.push({
                        id: doc.id,
                        nome: data.nome,
                        perfilCompleto: !!(data.perfil && data.perfil.q1 && data.perfil.avatar)
                    });
                });
                // Ordena por nome
                turmaMembers.sort((a, b) => a.nome.localeCompare(b.nome));
                populateGuessDropdown();
                // Atualiza painel de admin se estiver aberto
                if (adminUnlocked) updateAdminParticipants();
            });
        }

        // Limpa todos os listeners do Firestore para evitar memory leaks
        function cleanupListeners() {
            if (unsubscribeTurmaListener) unsubscribeTurmaListener();
            if (unsubscribeMembersListener) unsubscribeMembersListener();
            if (unsubscribeRoundListener) unsubscribeRoundListener();
            if (unsubscribeHintListener) unsubscribeHintListener();
            if (unsubscribeThanksListener) unsubscribeThanksListener();
        }

        // Configura bot√µes de Login, Cadastro e Logout
        function setupAuthHandlers() {
            // Troca de painel Login <-> Cadastro
            el('show-register-btn').addEventListener('click', () => {
                el('login-panel').classList.add('hidden');
                el('register-panel').classList.remove('hidden');
            });
            el('show-login-btn').addEventListener('click', () => {
                el('register-panel').classList.add('hidden');
                el('login-panel').classList.remove('hidden');
            });

            // Submit Login
            el('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = el('login-email').value;
                const password = el('login-password').value;
                el('login-error').textContent = '';
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // Sucesso! Esconde o login e mostra o loading
                    // enquanto o onAuthStateChanged carrega os dados.
                    el('loading-spinner').classList.remove('hidden');
                    showView('loading-spinner');
                    // O onAuthStateChanged vai cuidar do resto
                } catch (error) {
                    console.error("Erro de login:", error.code);
                    el('login-error').textContent = getFirebaseAuthErrorMessage(error.code);
                }
            });

            // Submit Cadastro
            el('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = el('register-email').value;
                const password = el('register-password').value;
                const nome = el('register-name').value;
                const turma = el('register-turma').value;
                el('register-error').textContent = '';

                if (!turma) {
                    el('register-error').textContent = 'Por favor, selecione sua turma.';
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // Cria o documento do usu√°rio no Firestore
                    const userDocRef = doc(db, "users", user.uid);
                    await setDoc(userDocRef, {
                        uid: user.uid,
                        nome: nome,
                        email: email,
                        turma: turma,
                        isAdmin: false, // Padr√£o
                        badges: [],
                        stats: {
                            feedbacksSent: 0,
                            reactionsReceivedOnSent: 0,
                            timesGuessedOnTry: { "1": 0, "2": 0, "3": 0, "fail": 0 },
                            quizCorrect: 0
                        },
                        perfil: {
                            q1: "", q2: "", q3: "", avatar: "", themeColor: "indigo"
                        },
                        createdAt: serverTimestamp()
                    });
                    
                    // Cria o documento da turma (se n√£o existir)
                    const turmaDocRef = doc(db, "turmas", turma);
                    const turmaDocSnap = await getDoc(turmaDocRef);
                    if (!turmaDocSnap.exists()) {
                        await setDoc(turmaDocRef, {
                            nome: turma,
                            status: "idle", // Estado inicial
                            currentRound: 0,
                            adminPassword: null,
                            thanksMuralEnabled: false
                        });
                    }
                    
                    // Sucesso, o onAuthStateChanged vai for√ßar o preenchimento do perfil
                } catch (error) {
                    console.error("Erro de cadastro:", error.code);
                    el('register-error').textContent = getFirebaseAuthErrorMessage(error.code);
                }
            });

            // Logout
            el('nav-logout-btn').addEventListener('click', handleLogout);
        }

        async function handleLogout() {
            adminUnlocked = false; // Bloqueia painel de admin
            await signOut(auth);
            // Sucesso, o onAuthStateChanged vai cuidar do resto
        }

        // ===================================
        // ===== NAVEGA√á√ÉO E UI GERAL =====
        // ===================================

        // Controla a visibilidade das views principais
        window.showView = function(viewId) {
            // Esconde todas as views
            allViews.forEach(id => {
                if (id !== 'login-view' && id !== 'app-view' && id !== 'loading-spinner') {
                    el(id)?.classList.add('hidden');
                }
            });
            
            // Mostra a view solicitada
            if (viewId === 'login-view' || viewId === 'loading-spinner') {
                el('app-view').classList.add('hidden');
                el(viewId).classList.remove('hidden');
            } else {
                el('app-view').classList.remove('hidden');
                el(viewId)?.classList.remove('hidden');
            }

            // A√ß√µes espec√≠ficas ao mostrar view
            if (viewId === 'shelf-view') loadShelf();
            if (viewId === 'stats-view') loadStats();
            if (viewId === 'hint-mural-view') loadHintMural();
            if (viewId === 'thanks-mural-view') loadThanksMural();
            if (viewId === 'quiz-view') loadNewQuizQuestion();
            if (viewId === 'profile-view') loadProfileForm();
            if (viewId === 'admin-view') loadAdminPanel();
        }
        
        // Controla a visibilidade dos pain√©is dentro do 'game-view'
        function showGamePanel(panelId) {
            gamePanels.forEach(id => el(id).classList.add('hidden'));
            el(panelId)?.classList.remove('hidden');
        }

        // Configura bot√µes de navega√ß√£o (ex: dicas de feedback)
        function setupNavigationHandlers() {
            // Modal de Dicas de Feedback
            el('feedback-tips-btn').addEventListener('click', () => {
                const template = el('modal-feedback-tips-template').content.cloneNode(true);
                showModal(template);
            });
        }

        // Mostra um modal gen√©rico
        function showModal(contentTemplate) {
            const modalContent = el('modal-content');
            modalContent.innerHTML = ''; // Limpa anterior
            modalContent.appendChild(contentTemplate);
            el('modal-container').classList.remove('hidden');

            // Adiciona listener para fechar
            const closeBtn = modalContent.querySelector('#modal-close-btn');
            if (closeBtn) {
                closeBtn.onclick = hideModal; // Remove listener anterior
                closeBtn.addEventListener('click', hideModal);
            }
            el('modal-backdrop').onclick = hideModal;
            el('modal-backdrop').addEventListener('click', hideModal);
        }

        // Esconde o modal
        function hideModal() {
            el('modal-container').classList.add('hidden');
            el('modal-content').innerHTML = '';
        }

        // Mostra uma mensagem simples (alert)
        function showMessage(title, message, onClose = null) {
            const template = el('modal-alert-template').content.cloneNode(true);
            template.querySelector('[data-id="title"]').textContent = title;
            template.querySelector('[data-id="message"]').textContent = message;
            showModal(template);
            
            if(onClose) {
                el('modal-content').querySelector('#modal-close-btn').addEventListener('click', onClose);
                el('modal-backdrop').addEventListener('click', onClose);
            }
        }
        
        // Dispara o confete de comemora√ß√£o
        function playConfetti() {
            confetti({
                particleCount: 150,
                spread: 100,
                origin: { y: 0.6 }
            });
        }
        
        // Mapeia c√≥digos de erro do Firebase para mensagens amig√°veis
        function getFirebaseAuthErrorMessage(code) {
            switch (code) {
                case 'auth/invalid-email':
                    return 'Formato de e-mail inv√°lido.';
                case 'auth/user-not-found':
                    return 'Nenhuma conta encontrada com este e-mail.';
                case 'auth/wrong-password':
                    return 'Senha incorreta. Tente novamente.';
                case 'auth/email-already-in-use':
                    return 'Este e-mail j√° est√° sendo usado por outra conta.';
                case 'auth/weak-password':
                    return 'Sua senha √© muito fraca. Use pelo menos 6 caracteres.';
                case 'auth/requires-recent-login':
                    return 'Esta a√ß√£o √© sens√≠vel e requer login recente. Logue novamente.';
                default:
                    return 'Ocorreu um erro. Tente novamente mais tarde.';
            }
        }

        // ===================================
        // ===== PERFIL DO USU√ÅRIO (View 2) =====
        // ===================================

        function setupProfileHandlers() {
            // Sele√ß√£o de Avatar
            document.querySelectorAll('.avatar-select').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.avatar-select').forEach(b => b.classList.remove('bg-indigo-200', 'ring-2', 'ring-indigo-500'));
                    btn.classList.add('bg-indigo-200', 'ring-2', 'ring-indigo-500');
                    el('profile-avatar').value = btn.textContent;
                });
            });

            // Sele√ß√£o de Cor
            document.querySelectorAll('.color-select').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.color-select').forEach(b => b.classList.remove('ring-4', 'ring-indigo-500'));
                    btn.classList.add('ring-4', 'ring-indigo-500');
                    el('profile-color').value = btn.dataset.color;
                });
            });

            // Submit Formul√°rio de Perfil
            el('profile-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const perfilData = {
                    q1: el('profile-q1').value,
                    q2: el('profile-q2').value,
                    q3: el('profile-q3').value,
                    avatar: el('profile-avatar').value,
                    themeColor: el('profile-color').value || 'indigo',
                };

                if (!perfilData.q1 || !perfilData.q2 || !perfilData.q3) {
                    showMessage('Ops!', 'Por favor, preencha todas as 3 perguntas para ajudar seu amigo a te decifrar!');
                    return;
                }
                if (!perfilData.avatar) {
                    showMessage('Ops!', 'Por favor, escolha um avatar (emoji)!');
                    return;
                }

                try {
                    const userDocRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userDocRef, { perfil: perfilData });
                    
                    // Atualiza dados locais
                    currentUserData.perfil = perfilData;

                    // Concede a badge "Perfil Completo"
                    await grantBadge("Perfil Completo");

                    showMessage('Sucesso!', 'Seu perfil foi salvo. Voc√™ ser√° redirecionado para o dashboard.', () => {
                        hideModal();
                        showView('dashboard-view');
                        // Recarrega os listeners para refletir o novo estado (agora com perfil)
                        initAppListeners(); 
                    });
                } catch (error) {
                    console.error("Erro ao salvar perfil:", error);
                    showMessage('Erro', 'N√£o foi poss√≠vel salvar seu perfil. Tente novamente.');
                }
            });
        }

        // Carrega dados do perfil no formul√°rio
        function loadProfileForm() {
            if (!currentUserData || !currentUserData.perfil) return;
            const { q1, q2, q3, avatar, themeColor } = currentUserData.perfil;
            el('profile-q1').value = q1 || '';
            el('profile-q2').value = q2 || '';
            el('profile-q3').value = q3 || '';
            el('profile-avatar').value = avatar || '';
            el('profile-color').value = themeColor || 'indigo';

            // Marca o avatar selecionado
            document.querySelectorAll('.avatar-select').forEach(btn => {
                btn.classList.remove('bg-indigo-200', 'ring-2', 'ring-indigo-500');
                if (btn.textContent === avatar) {
                    btn.classList.add('bg-indigo-200', 'ring-2', 'ring-indigo-500');
                }
            });

            // Marca a cor selecionada
            document.querySelectorAll('.color-select').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-indigo-500');
                if (btn.dataset.color === themeColor) {
                    btn.classList.add('ring-4', 'ring-indigo-500');
                }
            });
        }


        // ===================================
        // ===== ESTADO DO JOGO (Dashboard) =====
        // ===================================

        // Fun√ß√£o central que reage √†s mudan√ßas de estado da turma
        async function updateUIBasedOnGameState(status) {
            const statusBox = el('game-status-box');
            let statusHTML = '';
            
            // Gerencia bot√£o do Quiz (s√≥ aparece em tempo ocioso)
            if (status === 'idle' || status === 'revealed' || status === 'feedback_submitted') {
                 el('quiz-button-wrapper').classList.remove('hidden');
            } else {
                el('quiz-button-wrapper').classList.add('hidden');
            }

            // Pega o estado do jogador na rodada atual
            const myPairing = await getMyCurrentPairing();
            const myStatus = myPairing ? myPairing.status : null; // pending, guessed, submitted

            switch (status) {
                case 'idle':
                    statusHTML = `
                        <h3 class="text-xl font-bold text-indigo-800 mb-2">Aguardando...</h3>
                        <p class="text-indigo-700">O administrador ainda n√£o iniciou a pr√≥xima rodada (Rodada ${currentTurmaData.currentRound + 1}).</p>
                        <p class="text-indigo-700 mt-2">Enquanto isso, que tal jogar o <strong>Quiz Surpresa</strong>?</p>
                    `;
                    // Se a view do jogo estiver aberta, redireciona
                    if (!el('game-view').classList.contains('hidden')) showView('dashboard-view');
                    break;
                
                case 'guessing':
                    // Se eu j√° enviei meu feedback, vou para a tela de espera
                    if (myStatus === 'submitted') {
                        statusHTML = `
                            <h3 class="text-xl font-bold text-green-800 mb-2">Feedback Enviado!</h3>
                            <p class="text-green-700">Voc√™ j√° concluiu sua parte na Rodada ${currentTurmaData.currentRound}.</p>
                            <p class="text-green-700 mt-2">Estamos aguardando os outros participantes e a libera√ß√£o dos presentes pelo admin.</p>
                        `;
                        showGamePanel('game-wait-panel'); // Mostra painel de espera se estiver na view
                    }
                    // Se eu j√° adivinhei, mas n√£o enviei feedback
                    else if (myStatus === 'guessed') {
                        statusHTML = `
                            <h3 class="text-xl font-bold text-orange-800 mb-2">A√ß√£o Necess√°ria!</h3>
                            <p class="text-orange-700">Voc√™ j√° adivinhou seu amigo! Agora, por favor, <strong>envie seu feedback e presente</strong>.</p>
                            <button class="mt-4 bg-orange-500 text-white font-bold py-2 px-4 rounded-lg shadow" onclick="showView('game-view')">Ir para Feedback</button>
                        `;
                        loadGameView(); // Prepara a tela de feedback
                    }
                    // Se eu ainda n√£o adivinhei
                    else {
                         statusHTML = `
                            <h3 class="text-xl font-bold text-red-800 mb-2">A√ß√£o Necess√°ria!</h3>
                            <p class="text-red-700">A Rodada ${currentTurmaData.currentRound} come√ßou! Voc√™ precisa <strong>adivinhar seu amigo secreto</strong>.</p>
                            <button class="mt-4 bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow" onclick="showView('game-view')">Come√ßar a Adivinhar!</button>
                        `;
                        loadGameView(); // Prepara a tela de sorteio/adivinha√ß√£o
                    }
                    break;
                
                case 'revealed':
                    statusHTML = `
                        <h3 class="text-xl font-bold text-green-800 mb-2">Presentes Entregues! üéÅ</h3>
                        <p class="text-green-700">O administrador liberou os presentes da Rodada ${currentTurmaData.currentRound}.</p>
                        <p class="text-green-700 mt-2">V√° para a sua <strong>Estante de Presentes</strong> para ver o que voc√™ recebeu!</p>
                        <button class="mt-4 bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow" onclick="showView('shelf-view')">Ver minha Estante</button>
                    `;
                    break;
                
                default:
                    statusHTML = `<p>Status desconhecido: ${status}</p>`;
            }
            statusBox.innerHTML = statusHTML;
        }


        // ===================================
        // ===== JOGO (View 3) =====
        // ===================================

        // Configura os bot√µes de Adivinhar e Enviar Feedback
        function setupGameHandlers() {
            // Anima√ß√£o da Caixa de Presente
            el('gift-box-animation').addEventListener('click', async () => {
                const myPairing = await getMyCurrentPairing();
                if (!myPairing) {
                    showMessage('Erro', 'N√£o conseguimos encontrar seu par. Avise o administrador.');
                    return;
                }
                const receiverProfile = await getReceiverProfile(myPairing.receiverId);
                if (!receiverProfile) {
                    showMessage('Erro', 'N√£o conseguimos carregar o perfil do seu amigo. Avise o administrador.');
                    return;
                }
                
                populateGuessPanel(receiverProfile);
                showGamePanel('game-guess-panel');
            });
            
            // Bot√£o de Adivinhar
            el('guess-submit-btn').addEventListener('click', handleGuess);
            
            // Bot√µes de tipo de presente
            document.querySelectorAll('input[name="present-type"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'real') {
                        el('present-real-box').classList.remove('hidden');
                        el('present-zueira-box').classList.add('hidden');
                    } else {
                        el('present-real-box').classList.add('hidden');
                        el('present-zueira-box').classList.remove('hidden');
                    }
                });
            });
            
            // Submit do Formul√°rio de Feedback
            el('feedback-form').addEventListener('submit', handleSubmitFeedback);
        }
        
        // Carrega a view do jogo com base no estado do jogador
        async function loadGameView() {
            if (!currentTurmaData || currentTurmaData.status !== 'guessing') {
                // Se o jogo n√£o est√° em 'guessing', n√£o faz nada aqui
                return;
            }

            const myPairing = await getMyCurrentPairing();
            if (!myPairing) {
                showMessage('Erro', 'N√£o foi poss√≠vel carregar seu par. Avise o admin.', () => showView('dashboard-view'));
                return;
            }

            // myStatus: 'pending', 'guessed', 'submitted'
            if (myPairing.status === 'submitted') {
                showGamePanel('game-wait-panel');
            } else if (myPairing.status === 'guessed') {
                const receiverName = turmaMembers.find(m => m.id === myPairing.receiverId)?.nome;
                el('feedback-receiver-name').textContent = receiverName || 'Seu Amigo Secreto';
                showGamePanel('game-feedback-panel');
            } else {
                // Status √© 'pending', mostra anima√ß√£o de sorteio
                showGamePanel('game-draw-animation');
            }
        }
        
        // Preenche o painel de adivinha√ß√£o com as dicas
        function populateGuessPanel(receiverProfile) {
            const { q1, q2, q3, avatar, themeColor } = receiverProfile.perfil;
            el('guess-q1').textContent = q1;
            el('guess-q2').textContent = q2;
            el('guess-q3').textContent = q3;
            el('guess-avatar').textContent = avatar;
            
            // Aplica a cor tema
            const colorClass = themeColors[themeColor]?.bg || 'bg-indigo-500';
            el('guess-card').classList.add(colorClass);
            
            // Reseta o feedback
            el('guess-feedback').textContent = '';
            el('guess-attempts').textContent = 'Tentativas restantes: 3';
        }
        
        // Preenche o dropdown de nomes para adivinhar
        function populateGuessDropdown() {
            const select = el('guess-select');
            select.innerHTML = '<option value="">Selecione um nome...</option>'; // Limpa
            turmaMembers.forEach(member => {
                // N√£o posso me tirar
                if (member.id !== currentUser.uid) {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.nome;
                    select.appendChild(option);
                }
            });
        }
        
        // L√≥gica de Adivinha√ß√£o
        async function handleGuess() {
            const guessedId = el('guess-select').value;
            if (!guessedId) {
                el('guess-feedback').textContent = 'Por favor, selecione um nome!';
                return;
            }

            const myPairing = await getMyCurrentPairing();
            if (!myPairing) return;
            
            const remainingAttempts = 3 - myPairing.attempts;
            if (remainingAttempts <= 0) {
                 el('guess-feedback').textContent = 'Voc√™ n√£o tem mais tentativas!';
                 return;
            }
            
            const roundDocRef = doc(db, "rounds", `${currentTurmaId}_round_${currentTurmaData.currentRound}`);
            
            // Tentativa Correta
            if (guessedId === myPairing.receiverId) {
                playConfetti();
                el('guess-feedback').textContent = `Correto! Voc√™ tirou ${turmaMembers.find(m => m.id === guessedId)?.nome}!`;
                el('guess-feedback').classList.remove('text-red-300');
                el('guess-submit-btn').disabled = true;
                el('guess-select').disabled = true;

                // Salva o status e n√∫mero de tentativas
                const newPairings = currentRoundPairings.map(p => 
                    p.giverId === currentUser.uid ? { ...p, status: 'guessed', attempts: p.attempts + 1 } : p
                );
                await updateDoc(roundDocRef, { pairings: newPairings });

                // Concede a badge "Detetive de Primeira"
                if (myPairing.attempts === 0) {
                    await grantBadge("Detetive de Primeira");
                }
                
                // Salva estat√≠stica de adivinha√ß√£o
                const statKey = `stats.timesGuessedOnTry.${myPairing.attempts + 1}`;
                const receiverDocRef = doc(db, "users", myPairing.receiverId);
                await updateDoc(receiverDocRef, { [statKey]: increment(1) });
                
                // Avan√ßa para o painel de feedback
                setTimeout(() => {
                    el('feedback-receiver-name').textContent = turmaMembers.find(m => m.id === guessedId)?.nome;
                    showGamePanel('game-feedback-panel');
                }, 2500); // Espera 2.5s para o usu√°rio ler

            } 
            // Tentativa Incorreta
            else {
                const newAttempts = myPairing.attempts + 1;
                const newRemaining = 3 - newAttempts;
                
                el('guess-feedback').textContent = `Incorreto! Tente novamente.`;
                el('guess-feedback').classList.add('text-red-300');
                el('guess-attempts').textContent = `Tentativas restantes: ${newRemaining}`;

                const newPairings = currentRoundPairings.map(p => 
                    p.giverId === currentUser.uid ? { ...p, attempts: newAttempts } : p
                );
                await updateDoc(roundDocRef, { pairings: newPairings });

                if (newRemaining <= 0) {
                    el('guess-feedback').textContent = `Voc√™ esgotou suas tentativas! Seu amigo era ${turmaMembers.find(m => m.id === myPairing.receiverId)?.nome}.`;
                    el('guess-submit-btn').disabled = true;
                    el('guess-select').disabled = true;
                    
                    // Salva estat√≠stica de falha
                    const receiverDocRef = doc(db, "users", myPairing.receiverId);
                    await updateDoc(receiverDocRef, { "stats.timesGuessedOnTry.fail": increment(1) });
                    
                    // Atualiza status para 'guessed' mesmo assim, para poder dar feedback
                    const finalPairings = newPairings.map(p => 
                        p.giverId === currentUser.uid ? { ...p, status: 'guessed' } : p
                    );
                    await updateDoc(roundDocRef, { pairings: finalPairings });
                    
                    setTimeout(() => {
                        el('feedback-receiver-name').textContent = turmaMembers.find(m => m.id === myPairing.receiverId)?.nome;
                        showGamePanel('game-feedback-panel');
                    }, 3000);
                }
            }
        }
        
        // L√≥gica de Envio de Feedback
        async function handleSubmitFeedback(e) {
            e.preventDefault();
            const admire = el('feedback-admire').value;
            const suggest = el('feedback-suggest').value;
            const presentType = document.querySelector('input[name="present-type"]:checked')?.value;
            
            let present = '';
            let justification = '';
            
            if (!presentType) {
                el('present-error').textContent = 'Por favor, escolha um tipo de presente (Real ou Zueira).';
                return;
            }
            
            if (presentType === 'real') {
                present = el('feedback-present-real').value;
                justification = el('feedback-justification-real').value;
            } else {
                present = el('feedback-present-zueira').value;
                justification = el('feedback-justification-zueira').value;
            }
            
            if (!admire || !suggest || !present || !justification) {
                el('present-error').textContent = 'Por favor, preencha todos os campos do feedback e do presente.';
                return;
            }
            el('present-error').textContent = '';

            const myPairing = await getMyCurrentPairing();
            if (!myPairing) return;

            try {
                // 1. Salva o feedback na cole√ß√£o 'feedbacks'
                await addDoc(collection(db, "feedbacks"), {
                    round: currentTurmaData.currentRound,
                    turma: currentTurmaId,
                    giverId: currentUser.uid,
                    receiverId: myPairing.receiverId,
                    admire: admire,
                    suggest: suggest,
                    presentType: presentType,
                    present: present,
                    justification: justification,
                    reaction: null,
                    createdAt: serverTimestamp()
                });

                // 2. Atualiza o status do par na rodada
                const roundDocRef = doc(db, "rounds", `${currentTurmaId}_round_${currentTurmaData.currentRound}`);
                const newPairings = currentRoundPairings.map(p => 
                    p.giverId === currentUser.uid ? { ...p, status: 'submitted' } : p
                );
                await updateDoc(roundDocRef, { pairings: newPairings });

                // 3. Atualiza as estat√≠sticas do doador
                const userDocRef = doc(db, "users", currentUser.uid);
                await updateDoc(userDocRef, { "stats.feedbacksSent": increment(1) });
                
                // 4. Concede badge de veterano (se aplic√°vel)
                if (currentTurmaData.currentRound >= 3) {
                    await grantBadge("Veterano(a) da Conex√£o");
                }
                
                // 5. Mostra tela de espera
                showGamePanel('game-wait-panel');
                
                // 6. Atualiza dados locais (para UI do dashboard)
                // O listener de 'rounds' vai pegar a mudan√ßa, mas podemos for√ßar
                const pairing = await getMyCurrentPairing();
                if(pairing) pairing.status = 'submitted';
                updateUIBasedOnGameState('guessing'); // Re-renderiza o dashboard

            } catch (error) {
                console.error("Erro ao enviar feedback:", error);
                showMessage('Erro', 'N√£o foi poss√≠vel enviar seu feedback. Tente novamente.');
            }
        }
        
        // Helper para pegar o par do usu√°rio atual na rodada ativa
        async function getMyCurrentPairing() {
            if (!currentTurmaData || currentTurmaData.currentRound === 0) {
                return null;
            }
            
            // Se j√° temos os pairings carregados, usa eles
            if (currentRoundPairings.length > 0) {
                return currentRoundPairings.find(p => p.giverId === currentUser.uid);
            }
            
            // Se n√£o, busca no DB (deve ser raro, o listener de admin deve pegar)
            const roundDocRef = doc(db, "rounds", `${currentTurmaId}_round_${currentTurmaData.currentRound}`);
            const roundDocSnap = await getDoc(roundDocRef);
            
            if (roundDocSnap.exists()) {
                currentRoundPairings = roundDocSnap.data().pairings;
                return currentRoundPairings.find(p => p.giverId === currentUser.uid);
            }
            return null;
        }

        // Helper para pegar o perfil do amigo sorteado
        async function getReceiverProfile(receiverId) {
            const receiverDocRef = doc(db, "users", receiverId);
            const receiverDocSnap = await getDoc(receiverDocRef);
            return receiverDocSnap.exists() ? receiverDocSnap.data() : null;
        }


        // ===================================
        // ===== ESTANTE (View 4) =====
        // ===================================

        async function loadShelf() {
            const shelfContent = el('shelf-content');
            shelfContent.innerHTML = ''; // Limpa
            const template = el('shelf-card-template');
            
            try {
                const q = query(
                    collection(db, "feedbacks"),
                    where("receiverId", "==", currentUser.uid)
                    // N√£o podemos ordenar por 'round' (desc) sem um √≠ndice composto.
                    // Vamos ordenar no JS.
                );
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    shelfContent.innerHTML = `<p id="shelf-empty-msg" class="text-gray-500 text-center py-8">Sua estante est√° vazia. Quando o admin liberar os presentes, eles aparecer√£o aqui!</p>`;
                    return;
                }

                let feedbacks = [];
                querySnapshot.forEach((doc) => {
                    feedbacks.push({ id: doc.id, ...doc.data() });
                });
                
                // Ordena por rodada, da mais recente para a mais antiga
                feedbacks.sort((a, b) => b.round - a.round);

                feedbacks.forEach(fb => {
                    const card = template.content.cloneNode(true);
                    card.querySelector('[data-id="round-number"]').textContent = fb.round;
                    card.querySelector('[data-id="admire-text"]').textContent = fb.admire;
                    card.querySelector('[data-id="suggest-text"]').textContent = fb.suggest;
                    card.querySelector('[data-id="present-text"]').textContent = fb.present;
                    card.querySelector('[data-id="justification-text"]').textContent = fb.justification;
                    
                    if (fb.presentType === 'zueira') {
                        card.querySelector('[data-id="present-emoji"]').textContent = 'ü§™';
                    } else {
                        card.querySelector('[data-id="present-emoji"]').textContent = 'üéÅ';
                    }

                    const reactionButtons = card.querySelector('[data-id="reaction-buttons"]');
                    const reactionSent = card.querySelector('[data-id="reaction-sent"]');
                    
                    if (fb.reaction) {
                        reactionButtons.classList.add('hidden');
                        reactionSent.classList.remove('hidden');
                        reactionSent.querySelector('[data-id="sent-emoji"]').textContent = fb.reaction;
                    } else {
                        reactionButtons.querySelectorAll('.reaction-btn').forEach(btn => {
                            btn.addEventListener('click', () => handleEmojiReaction(fb.id, btn.dataset.emoji));
                        });
                    }
                    
                    shelfContent.appendChild(card);
                });

            } catch (error) {
                console.error("Erro ao carregar estante:", error);
                shelfContent.innerHTML = `<p class="text-red-500 text-center py-8">Erro ao carregar seus presentes.</p>`;
            }
        }
        
        async function handleEmojiReaction(feedbackId, emoji) {
            try {
                const feedbackRef = doc(db, "feedbacks", feedbackId);
                const feedbackSnap = await getDoc(feedbackRef);
                if (!feedbackSnap.exists()) return;
                
                const feedbackData = feedbackSnap.data();
                
                // 1. Atualiza o feedback com a rea√ß√£o
                await updateDoc(feedbackRef, { reaction: emoji });

                // 2. Atualiza as estat√≠sticas do DOADOR (giver)
                if (['‚ù§Ô∏è', 'üí°', 'üôè', 'üëç'].includes(emoji)) {
                    const giverRef = doc(db, "users", feedbackData.giverId);
                    await updateDoc(giverRef, { "stats.reactionsReceivedOnSent": increment(1) });
                    
                    // 3. Verifica se concede a badge "Queridinho"
                    const giverSnap = await getDoc(giverRef);
                    if (giverSnap.exists() && giverSnap.data().stats.reactionsReceivedOnSent >= 4) { // 4 + o incremento atual = 5
                         // Usamos um batch para garantir que a badge s√≥ seja dada uma vez
                        const batch = writeBatch(db);
                        const newBadges = Array.from(new Set([...giverSnap.data().badges, "Queridinho(a) An√¥nimo(a)"]));
                        batch.update(giverRef, { badges: newBadges });
                        await batch.commit();
                    }
                }
                
                // 4. Atualiza a UI da Estante
                loadShelf();

            } catch (error) {
                console.error("Erro ao enviar rea√ß√£o:", error);
                showMessage('Erro', 'N√£o foi poss√≠vel enviar sua rea√ß√£o.');
            }
        }

        // ===================================
        // ===== PAINEL PESSOAL (View 5) =====
        // ===================================

        async function loadStats() {
            // Recarrega os dados do usu√°rio para garantir que est√£o atualizados
            const userDocRef = doc(db, "users", currentUser.uid);
            const userDocSnap = await getDoc(userDocRef);
            if (!userDocSnap.exists()) return;
            currentUserData = userDocSnap.data();
            
            const stats = currentUserData.stats;
            
            // Stats
            el('stats-sent').textContent = stats.feedbacksSent || 0;
            el('stats-reactions').textContent = stats.reactionsReceivedOnSent || 0;
            
            // C√°lculo do "Enigma"
            const { "1": t1, "2": t2, "3": t3, fail } = stats.timesGuessedOnTry;
            const totalGuesses = (t1 || 0) + (t2 || 0) + (t3 || 0) + (fail || 0);
            if (totalGuesses > 0) {
                const weightedSum = (t1*1) + (t2*2) + (t3*3) + (fail*4); // 4 para falha
                const avg = (weightedSum / totalGuesses).toFixed(1);
                el('stats-enigma').textContent = `${avg} / 4.0`;
            } else {
                el('stats-enigma').textContent = 'Ainda sem dados';
            }
            
            // Badges
            const badgesContainer = el('stats-badges');
            badgesContainer.innerHTML = ''; // Limpa
            const template = el('badge-template');
            
            if (currentUserData.badges && currentUserData.badges.length > 0) {
                el('stats-badges-empty').classList.add('hidden');
                
                // Garante que n√£o h√° duplicatas
                const uniqueBadges = [...new Set(currentUserData.badges)];
                
                uniqueBadges.forEach(badgeName => {
                    const def = badgeDefs[badgeName];
                    if (def) {
                        const badge = template.content.cloneNode(true);
                        const badgeEl = badge.querySelector('div');
                        badgeEl.classList.add(def.color);
                        badgeEl.setAttribute('title', def.description);
                        badgeEl.querySelector('[data-id="badge-icon"]').textContent = def.icon;
                        badgeEl.querySelector('[data-id="badge-name"]').textContent = badgeName;
                        badgesContainer.appendChild(badge);
                    }
                });
            } else {
                el('stats-badges-empty').classList.remove('hidden');
            }
        }
        
        // Helper para conceder uma badge (s√≥ adiciona se n√£o existir)
        async function grantBadge(badgeName) {
            if (!currentUserData.badges.includes(badgeName)) {
                const newBadges = [...currentUserData.badges, badgeName];
                const userDocRef = doc(db, "users", currentUser.uid);
                await updateDoc(userDocRef, { badges: newBadges });
                currentUserData.badges = newBadges; // Atualiza local
                
                // Mostra notifica√ß√£o
                const def = badgeDefs[badgeName];
                if (def) {
                    showMessage('Conquista Desbloqueada!', `Voc√™ ganhou a badge: ${def.icon} ${badgeName}!`);
                }
            }
        }

        // ===================================
        // ===== MURAIS (View 6 e 7) =====
        // ===================================

        function setupMuralHandlers() {
            // Postar no Mural de Dicas
            el('hint-mural-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = el('hint-mural-text').value;
                if (text.length < 5) {
                    showMessage('Ops!', 'Sua dica precisa ter pelo menos 5 caracteres.');
                    return;
                }
                
                try {
                    await addDoc(collection(db, "muralDicas"), {
                        turma: currentTurmaId,
                        text: text,
                        authorId: currentUser.uid,
                        approved: false,
                        createdAt: serverTimestamp()
                    });
                    el('hint-mural-text').value = '';
                    showMessage('Sucesso!', 'Sua dica foi enviada para aprova√ß√£o do administrador.');
                } catch (error) {
                    console.error("Erro ao postar dica:", error);
                    showMessage('Erro', 'N√£o foi poss√≠vel enviar sua dica.');
                }
            });
            
            // Postar no Mural de Agradecimentos
            el('thanks-mural-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = el('thanks-mural-text').value;
                if (text.length < 5) {
                    showMessage('Ops!', 'Sua mensagem precisa ter pelo menos 5 caracteres.');
                    return;
                }
                
                try {
                    await addDoc(collection(db, "muralAgradecimentos"), {
                        turma: currentTurmaId,
                        text: text,
                        authorId: currentUser.uid,
                        authorName: currentUserData.nome,
                        createdAt: serverTimestamp()
                    });
                    el('thanks-mural-text').value = '';
                    // O listener vai atualizar a lista
                } catch (error) {
                    console.error("Erro ao postar agradecimento:", error);
                    showMessage('Erro', 'N√£o foi poss√≠vel enviar sua mensagem.');
                }
            });
        }
        
        // Carrega o Mural de Dicas (aprovadas)
        async function loadHintMural() {
            const list = el('hint-mural-list');
            list.innerHTML = '';
            const template = el('hint-mural-card-template');
            
            const q = query(
                collection(db, "muralDicas"),
                where("turma", "==", currentTurmaId),
                where("approved", "==", true)
                // Ordenar por data (precisa de √≠ndice)
            );
            
            // Listener para atualiza√ß√µes em tempo real
            if (unsubscribeHintListener) unsubscribeHintListener();
            unsubscribeHintListener = onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    list.innerHTML = `<p id="hint-mural-empty" class="text-gray-500 text-center py-8">Nenhuma dica aprovada no mural ainda.</p>`;
                    return;
                }
                list.innerHTML = ''; // Limpa antes de repopular
                
                querySnapshot.docs
                    .sort((a, b) => b.data().createdAt - a.data().createdAt) // Ordena por data
                    .forEach(doc => {
                        const data = doc.data();
                        const card = template.content.cloneNode(true);
                        card.querySelector('p').textContent = `"${data.text}"`;
                        card.querySelector('[data-id="use-hint-btn"]').addEventListener('click', async () => {
                            await grantBadge("O(A) Observador(a)");
                            showMessage('Badge Conquistada!', 'Voc√™ usou uma dica e ganhou a badge "O(A) Observador(a)"!');
                        });
                        list.appendChild(card);
                    });
            });
        }
        
        // Carrega o Mural de Agradecimentos
        async function loadThanksMural() {
            // Verifica se o admin liberou
            if (!currentTurmaData || !currentTurmaData.thanksMuralEnabled) {
                el('thanks-mural-disabled').classList.remove('hidden');
                el('thanks-mural-enabled').classList.add('hidden');
                return;
            }
            el('thanks-mural-disabled').classList.add('hidden');
            el('thanks-mural-enabled').classList.remove('hidden');

            const list = el('thanks-mural-list');
            list.innerHTML = '';
            const template = el('thanks-mural-card-template');
            
            const q = query(
                collection(db, "muralAgradecimentos"),
                where("turma", "==", currentTurmaId)
            );
            
            if (unsubscribeThanksListener) unsubscribeThanksListener();
            unsubscribeThanksListener = onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    list.innerHTML = `<p id="thanks-mural-empty" class="text-gray-500 text-center py-8">Ningu√©m agradeceu ainda. Seja o primeiro!</p>`;
                    return;
                }
                list.innerHTML = '';
                
                querySnapshot.docs
                    .sort((a, b) => b.data().createdAt - a.data().createdAt)
                    .forEach(doc => {
                        const data = doc.data();
                        const card = template.content.cloneNode(true);
                        card.querySelector('p:first-child').textContent = `"${data.text}"`;
                        card.querySelector('p:last-child').textContent = `- ${data.authorName}`;
                        list.appendChild(card);
                    });
            });
        }

        // ===================================
        // ===== QUIZ SURPRESA (View 8) =====
        // ===================================
        let currentQuizQuestion = null;
        
        function setupQuizHandlers() {
             el('quiz-next-btn').addEventListener('click', loadNewQuizQuestion);
        }

        function loadNewQuizQuestion() {
            el('quiz-content').classList.remove('hidden');
            el('quiz-result').classList.add('hidden');
            
            const content = el('quiz-content');
            content.innerHTML = ''; // Limpa
            
            // Pega uma pergunta aleat√≥ria
            currentQuizQuestion = quizBank[Math.floor(Math.random() * quizBank.length)];
            
            const template = el('quiz-question-template').content.cloneNode(true);
            template.querySelector('[data-id="question-text"]').textContent = currentQuizQuestion.q;
            
            const optionsList = template.querySelector('[data-id="options-list"]');
            const optionTemplate = el('quiz-option-template');
            
            // Embaralha as op√ß√µes
            const shuffledOptions = [...currentQuizQuestion.o].sort(() => Math.random() - 0.5);
            
            shuffledOptions.forEach(optionText => {
                const optionBtn = optionTemplate.content.cloneNode(true).querySelector('button');
                optionBtn.textContent = optionText;
                optionBtn.addEventListener('click', () => handleQuizAnswer(optionText));
                optionsList.appendChild(optionBtn);
            });
            
            content.appendChild(template);
        }
        
        async function handleQuizAnswer(selectedOption) {
            el('quiz-content').classList.add('hidden');
            el('quiz-result').classList.remove('hidden');
            
            const resultText = el('quiz-result-text');
            const explanationText = el('quiz-result-explanation');
            
            if (selectedOption === currentQuizQuestion.a) {
                resultText.textContent = 'Correto! ü•≥';
                resultText.className = 'text-2xl font-bold text-green-600';
                explanationText.textContent = currentQuizQuestion.ex;
                
                // Atualiza stats e verifica badge
                const userDocRef = doc(db, "users", currentUser.uid);
                await updateDoc(userDocRef, { "stats.quizCorrect": increment(1) });
                currentUserData.stats.quizCorrect++;
                
                if (currentUserData.stats.quizCorrect >= 5) {
                    await grantBadge("Sabe-Tudo");
                }
            } else {
                resultText.textContent = 'Incorreto üòï';
                resultText.className = 'text-2xl font-bold text-red-600';
                explanationText.textContent = `A resposta correta era: "${currentQuizQuestion.a}". ${currentQuizQuestion.ex}`;
            }
        }

        // ===================================
        // ===== PAINEL DE ADMIN (View 9) =====
        // ===================================
        
        function setupAdminHandlers() {
            // Setup inicial de senha
            el('admin-password-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const pass = el('admin-password-input').value;
                if (pass.length < 4) {
                    showMessage('Erro', 'A senha de admin deve ter pelo menos 4 caracteres.');
                    return;
                }
                
                try {
                    const turmaDocRef = doc(db, "turmas", currentTurmaId);
                    await updateDoc(turmaDocRef, { adminPassword: pass }); // NOTA: Isso salva a senha em plaintext. Para produ√ß√£o, usar hash.
                    
                    // Define o usu√°rio atual como admin
                    const userDocRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userDocRef, { isAdmin: true });
                    currentUserData.isAdmin = true;
                    el('nav-admin-btn').classList.remove('hidden');
                    
                    adminUnlocked = true;
                    el('admin-setup-panel').classList.add('hidden');
                    el('admin-content').classList.remove('hidden');
                    
                } catch (error) {
                    console.error("Erro ao definir senha de admin:", error);
                    showMessage('Erro', 'N√£o foi poss√≠vel salvar a senha.');
                }
            });
            
            // Verifica√ß√£o de senha
            el('admin-check-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const pass = el('admin-check-input').value;
                el('admin-check-error').textContent = '';
                
                if (pass === currentTurmaData.adminPassword) {
                    adminUnlocked = true;
                    el('admin-lock-panel').classList.add('hidden');
                    el('admin-content').classList.remove('hidden');
                    updateAdminParticipants(); // Carrega dados do admin
                    updateAdminRoundProgress();
                    loadAdminHintApprovals();
                } else {
                    el('admin-check-error').textContent = 'Senha incorreta.';
                }
            });
            
            // Bot√µes de A√ß√£o do Admin
            el('admin-start-round-btn').addEventListener('click', handleStartRound);
            el('admin-release-gifts-btn').addEventListener('click', handleReleaseGifts);
            el('admin-enable-thanks-btn').addEventListener('click', handleEnableThanks);
            el('admin-seed-quiz-btn').addEventListener('click', seedQuizBank);
            el('admin-wordcloud-btn').addEventListener('click', generateWordCloud);
            el('admin-report-btn').addEventListener('click', generateAdminReport);
            el('admin-badge-submit').addEventListener('click', handleGrantManualBadge);
        }
        
        // Carrega o painel de admin, verificando senha
        function loadAdminPanel() {
            if (!currentTurmaData) {
                // Turma ainda n√£o foi criada, o que √© estranho
                return;
            }
            
            // Se o admin j√° desbloqueou, s√≥ mostra o conte√∫do
            if (adminUnlocked) {
                el('admin-setup-panel').classList.add('hidden');
                el('admin-lock-panel').classList.add('hidden');
                el('admin-content').classList.remove('hidden');
                updateAdminParticipants(); // Recarrega dados
                updateAdminRoundProgress();
                loadAdminHintApprovals();
                return;
            }

            // Se a senha de admin n√£o foi definida, mostra setup
            if (!currentTurmaData.adminPassword) {
                el('admin-setup-panel').classList.remove('hidden');
                el('admin-lock-panel').classList.add('hidden');
                el('admin-content').classList.add('hidden');
            } 
            // Se a senha existe, mostra painel de bloqueio
            else {
                el('admin-setup-panel').classList.add('hidden');
                el('admin-lock-panel').classList.remove('hidden');
                el('admin-content').classList.add('hidden');
                el('admin-check-input').value = '';
                el('admin-check-error').textContent = '';
            }
        }
        
        // Atualiza a UI do admin (status, bot√µes)
        function updateAdminUI() {
            if (!currentTurmaData) return;
            const status = currentTurmaData.status;
            const round = currentTurmaData.currentRound;
            
            el('admin-current-round').textContent = round;
            el('admin-next-round-num').textContent = round + 1;
            
            const startBtn = el('admin-start-round-btn');
            const releaseBtn = el('admin-release-gifts-btn');
            const thanksBtn = el('admin-enable-thanks-btn');
            
            startBtn.disabled = true;
            releaseBtn.disabled = true;
            thanksBtn.disabled = !!currentTurmaData.thanksMuralEnabled; // Desativa se j√° ativou
            
            let statusText = '';
            
            // Verifica progresso
            const total = turmaMembers.length;
            const profiles = turmaMembers.filter(m => m.perfilCompleto).length;
            const profilesPercent = total > 0 ? (profiles / total) * 100 : 0;
            
            const guessed = currentRoundPairings.filter(p => p.status === 'guessed' || p.status === 'submitted').length;
            const guessedPercent = total > 0 ? (guessed / total) * 100 : 0;
            
            const submitted = currentRoundPairings.filter(p => p.status === 'submitted').length;
            const submittedPercent = total > 0 ? (submitted / total) * 100 : 0;
            
            el('admin-progress-profile').style.width = `${profilesPercent}%`;
            el('admin-progress-guess').style.width = `${guessedPercent}%`;
            el('admin-progress-feedback').style.width = `${submittedPercent}%`;

            switch (status) {
                case 'idle':
                    statusText = 'Ocioso. Aguardando in√≠cio da pr√≥xima rodada.';
                    startBtn.disabled = false;
                    // Verifica se todos os perfis est√£o completos
                    if (profilesPercent < 100) {
                        startBtn.disabled = true;
                        statusText = 'Aguardando todos os usu√°rios completarem seus perfis.';
                    }
                    break;
                case 'guessing':
                    statusText = 'Rodada em andamento. Alunos est√£o adivinhando e enviando feedbacks.';
                    releaseBtn.disabled = false;
                    // S√≥ pode liberar se TODOS tiverem enviado
                    if (submittedPercent < 100) {
                        releaseBtn.disabled = true;
                        statusText += ` (${submitted}/${total} feedbacks enviados).`;
                    }
                    break;
                case 'revealed':
                    statusText = `Rodada ${round} finalizada. Presentes foram entregues.`;
                    startBtn.disabled = false; // Pode iniciar a pr√≥xima
                    thanksBtn.disabled = !!currentTurmaData.thanksMuralEnabled;
                    break;
            }
            el('admin-status-text').textContent = statusText;
        }

        // Atualiza a lista de participantes no painel de admin
        function updateAdminParticipants() {
            const list = el('admin-participant-list');
            const userSelect = el('admin-badge-user');
            list.innerHTML = '';
            userSelect.innerHTML = '<option value="">Selecione um aluno...</option>';
            const template = el('admin-participant-card-template');
            
            turmaMembers.forEach(member => {
                // Popula lista de participantes
                const card = template.content.cloneNode(true);
                card.querySelector('[data-id="name"]').textContent = member.nome;
                card.querySelector('[data-id="email"]').textContent = member.id === currentUser.uid ? "(Voc√™)" : ""; // N√£o mostrar email
                
                // Status do Perfil
                const profileStatus = card.querySelector('[data-id="profile-status"]');
                if (member.perfilCompleto) {
                    profileStatus.textContent = 'Perfil OK';
                    profileStatus.className = 'px-2 py-0.5 rounded-full font-medium text-xs bg-green-100 text-green-800';
                } else {
                    profileStatus.textContent = 'Pendente';
                    profileStatus.className = 'px-2 py-0.5 rounded-full font-medium text-xs bg-red-100 text-red-800';
                }
                
                // Status do Jogo
                const pairing = currentRoundPairings.find(p => p.giverId === member.id);
                const guessStatus = card.querySelector('[data-id="guess-status"]');
                const feedbackStatus = card.querySelector('[data-id="feedback-status"]');
                
                if (pairing) {
                    if (pairing.status === 'submitted') {
                        guessStatus.textContent = 'Adivinhou';
                        guessStatus.className = 'px-2 py-0.5 rounded-full font-medium text-xs bg-green-100 text-green-800';
                        feedbackStatus.textContent = 'Enviou';
                        feedbackStatus.className = 'px-2 py-0.5 rounded-full font-medium text-xs bg-green-100 text-green-800';
                    } else if (pairing.status === 'guessed') {
                        guessStatus.textContent = 'Adivinhou';
                        guessStatus.className = 'px-2 py-0.5 rounded-full font-medium text-xs bg-green-100 text-green-800';
                        feedbackStatus.textContent = 'Pendente';
                        feedbackStatus.className = 'px-2 py-0.5 rounded-full font-medium text-xs bg-yellow-100 text-yellow-800';
                    } else {
                        guessStatus.textContent = 'Pendente';
                        guessStatus.className = 'px-2 py-0.5 rounded-full font-medium text-xs bg-red-100 text-red-800';
                        feedbackStatus.textContent = '...';
                        feedbackStatus.className = 'px-2 py-0.5 rounded-full font-medium text-xs bg-gray-100 text-gray-800';
                    }
                } else {
                     guessStatus.textContent = '...';
                     guessStatus.className = 'px-2 py-0.5 rounded-full font-medium text-xs bg-gray-100 text-gray-800';
                     feedbackStatus.textContent = '...';
                     feedbackStatus.className = 'px-2 py-0.5 rounded-full font-medium text-xs bg-gray-100 text-gray-800';
                }
                
                list.appendChild(card);
                
                // Popula select de badges
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.nome;
                userSelect.appendChild(option);
            });
            
            // Atualiza UI geral do admin
            updateAdminUI();
        }
        
        // Listener para progresso da rodada
        function updateAdminRoundProgress() {
            if (unsubscribeRoundListener) unsubscribeRoundListener();
            
            if (currentTurmaData && currentTurmaData.currentRound > 0) {
                const roundDocRef = doc(db, "rounds", `${currentTurmaId}_round_${currentTurmaData.currentRound}`);
                unsubscribeRoundListener = onSnapshot(roundDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        currentRoundPairings = docSnap.data().pairings;
                    } else {
                        currentRoundPairings = [];
                    }
                    updateAdminParticipants(); // Re-renderiza a lista e UI
                });
            } else {
                currentRoundPairings = [];
                updateAdminParticipants();
            }
        }
        
        // A√ß√£o: Iniciar Rodada
        async function handleStartRound() {
            if (!confirm('Tem certeza que deseja iniciar uma nova rodada? Todos os perfis devem estar completos.')) {
                return;
            }

            const membersWithProfile = turmaMembers.filter(m => m.perfilCompleto);
            if (membersWithProfile.length < 2) {
                showMessage('Erro', 'Precisa de pelo menos 2 jogadores com perfis completos para iniciar.');
                return;
            }
            
            // L√≥gica de Sorteio (Algoritmo de Fisher-Yates + verifica√ß√£o)
            let givers = membersWithProfile.map(m => m.id);
            let receivers = [...givers];
            
            // 1. Carregar pares da rodada anterior para evitar repeti√ß√£o
            let lastRoundPairings = new Map();
            const lastRoundNum = currentTurmaData.currentRound;
            if (lastRoundNum > 0) {
                const lastRoundDoc = await getDoc(doc(db, "rounds", `${currentTurmaId}_round_${lastRoundNum}`));
                if (lastRoundDoc.exists()) {
                    lastRoundDoc.data().pairings.forEach(p => lastRoundPairings.set(p.giverId, p.receiverId));
                }
            }

            // 2. Embaralhar receivers
            for (let i = receivers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [receivers[i], receivers[j]] = [receivers[j], receivers[i]];
            }

            // 3. Verificar pares (auto-presente e repeti√ß√£o)
            let pairings = [];
            let needsReshuffle = false;
            for (let i = 0; i < givers.length; i++) {
                const giverId = givers[i];
                const receiverId = receivers[i];
                
                // Se deu auto-presente OU repetiu o par anterior
                if (giverId === receiverId || lastRoundPairings.get(giverId) === receiverId) {
                    // Tenta trocar com o pr√≥ximo
                    const next_i = (i + 1) % givers.length;
                    const nextReceiverId = receivers[next_i];
                    
                    // Se o pr√≥ximo tamb√©m for inv√°lido para mim OU eu for inv√°lido para o pr√≥ximo
                    if (giverId === nextReceiverId || lastRoundPairings.get(giverId) === nextReceiverId || 
                        givers[next_i] === receiverId || lastRoundPairings.get(givers[next_i]) === receiverId) 
                    {
                        needsReshuffle = true; // Falha, precisa re-sortear
                        break;
                    }
                    
                    // Troca v√°lida
                    [receivers[i], receivers[next_i]] = [receivers[next_i], receivers[i]];
                    pairings.push({ giverId: givers[i], receiverId: receivers[i], status: 'pending', attempts: 0 });
                } else {
                    pairings.push({ giverId: givers[i], receiverId: receivers[i], status: 'pending', attempts: 0 });
                }
            }
            
            // Se o shuffle simples falhou, tenta de novo (raro para turmas > 3)
            if (needsReshuffle) {
                // Para simplificar, vamos apenas re-chamar a fun√ß√£o
                console.warn("Reshuffle necess√°rio. Tentando novamente.");
                if (givers.length > 2) { // Evita loop infinito
                    handleStartRound();
                    return;
                } else {
                     showMessage("Erro", "N√£o foi poss√≠vel sortear sem repetir com apenas 2 jogadores. Aguarde uma 3a pessoa.");
                     return;
                }
            }
            
            // 4. Salvar no DB
            try {
                const newRoundNum = currentTurmaData.currentRound + 1;
                const roundDocRef = doc(db, "rounds", `${currentTurmaId}_round_${newRoundNum}`);
                await setDoc(roundDocRef, { pairings: pairings, status: 'active' });
                
                const turmaDocRef = doc(db, "turmas", currentTurmaId);
                await updateDoc(turmaDocRef, { 
                    status: 'guessing', 
                    currentRound: newRoundNum 
                });
                
                showMessage('Sucesso!', `Rodada ${newRoundNum} iniciada! Os alunos j√° podem adivinhar.`);
                // O listener do admin vai atualizar a UI
                updateAdminRoundProgress();
            } catch (error) {
                console.error("Erro ao iniciar rodada:", error);
                showMessage('Erro', 'N√£o foi poss√≠vel salvar os pares da rodada.');
            }
        }
        
        // A√ß√£o: Liberar Presentes
        async function handleReleaseGifts() {
            if (!confirm('Tem certeza? Isso ir√° liberar os feedbacks e presentes para TODOS os participantes desta rodada.')) {
                return;
            }
            try {
                const turmaDocRef = doc(db, "turmas", currentTurmaId);
                await updateDoc(turmaDocRef, { status: 'revealed' });
                
                // Concede a badge "Turma Unida" para todos
                const batch = writeBatch(db);
                turmaMembers.forEach(member => {
                    const userRef = doc(db, "users", member.id);
                    const userBadges = currentUserData.badges || []; // Assume-se que todos t√™m
                    const newBadges = Array.from(new Set([...userBadges, "Turma Unida"]));
                    batch.update(userRef, { badges: newBadges });
                });
                await batch.commit();
                
                showMessage('Sucesso!', 'Presentes liberados! A badge "Turma Unida" foi concedida a todos.');
            } catch (error) {
                console.error("Erro ao liberar presentes:", error);
            }
        }
        
        // A√ß√£o: Liberar Mural de Agradecimentos
        async function handleEnableThanks() {
            if (!confirm('Tem certeza? Isso libera o Mural de Agradecimentos (n√£o-an√¥nimo) para todos.')) {
                return;
            }
            try {
                const turmaDocRef = doc(db, "turmas", currentTurmaId);
                await updateDoc(turmaDocRef, { thanksMuralEnabled: true });
                el('admin-enable-thanks-btn').disabled = true;
                showMessage('Sucesso!', 'Mural de Agradecimentos est√° liberado.');
            } catch (error) {
                console.error("Erro ao liberar mural:", error);
            }
        }
        
        // A√ß√£o: Carregar Quest√µes do Quiz
        async function seedQuizBank() {
            if (!confirm('Isso ir√° (re)carregar o banco de quest√µes do quiz para esta turma. Continuar?')) {
                return;
            }
            try {
                const turmaDocRef = doc(db, "turmas", currentTurmaId);
                await updateDoc(turmaDocRef, { quizBank: quizBank }); // Salva o banco local no firestore
                showMessage('Sucesso!', 'Banco de quest√µes do quiz foi carregado.');
            } catch (error) {
                console.error("Erro ao carregar quiz:", error);
            }
        }
        
        // A√ß√£o: Gerar Nuvem de Palavras
        async function generateWordCloud() {
            const canvas = el('wordcloud-canvas');
            const emptyMsg = el('wordcloud-empty');
            emptyMsg.textContent = 'Carregando feedbacks...';
            
            try {
                const q = query(collection(db, "feedbacks"), where("turma", "==", currentTurmaId));
                const querySnapshot = await getDocs(q);
                
                let allPositiveWords = '';
                querySnapshot.forEach(doc => {
                    allPositiveWords += doc.data().admire + ' ';
                });
                
                if (allPositiveWords.trim() === '') {
                    emptyMsg.textContent = 'Nenhum feedback positivo enviado ainda.';
                    return;
                }
                
                // Processar palavras: min√∫sculas, remover pontua√ß√£o, remover stopwords
                const stopwords = ['de', 'a', 'o', 'que', 'e', 'do', 'da', 'em', 'um', 'para', '√©', 'com', 'n√£o', 'uma', 'os', 'no', 'na', 'por', 'mais', 'as', 'dos', 'como', 'mas', 'foi', 'ao', 'ele', 'das', 'tem', '√†', 'seu', 'sua', 'ou', 'ser', 'quando', 'muito', 'h√°', 'nos', 'j√°', 'est√°', 'eu', 'tamb√©m', 's√≥', 'pelo', 'pela', 'at√©', 'isso', 'ela', 'entre', 'era', 'depois', 'sem', 'mesmo', 'aos', 'ter', 'seus', 'quem', 'nas', 'me', 'esse', 'eles', 'est√£o', 'voc√™', 'tinha', 'foram', 'essa', 'num', 'nem', 'seja', 'qual', 'ser√°', 'n√≥s', 'tenho', 'lhe', 'deles', 'essas', 'esses', 'pelas', 'este', 'fosse', 'dele', 'tu', 'te', 'voc√™s', 'meu', 'minha', 'numa', 'pelos', 'elas', 'suas', 'meus', 'minhas', 'teu', 'tua', 'teus', 'tuas', 'nosso', 'nossa', 'nossos', 'nossas', 'dela', 'delas', 'esta', 'estes', 'estas', 'aquele', 'aquela', 'aqueles', 'aquelas', 'isto', 'aquilo', 'estou', 'est√°', 'estamos', 'est√£o', 'estive', 'esteve', 'estivemos', 'estiveram', 'estava', 'est√°vamos', 'estavam', 'estivera', 'estiv√©ramos', 'esteja', 'estejamos', 'estejam', 'estivesse', 'estiv√©ssemos', 'estivessem', 'estiver', 'estivermos', 'estiverem', 'hei', 'h√°', 'havemos', 'h√£o', 'houve', 'houvemos', 'houveram', 'houvera', 'houv√©ramos', 'haja', 'hajamos', 'hajam', 'houvesse', 'houv√©ssemos', 'houvessem', 'houver', 'houvermos', 'houverem', 'houverei', 'houver√°', 'houveremos', 'houver√£o', 'houveria', 'houver√≠amos', 'houveriam', 'sou', 'somos', 's√£o', 'era', '√©ramos', 'eram', 'fui', 'foi', 'fomos', 'foram', 'fora', 'f√¥ramos', 'seja', 'sejamos', 'sejam', 'fosse', 'f√¥ssemos', 'fossem', 'for', 'formos', 'forem', 'serei', 'ser√°', 'seremos', 'ser√£o', 'seria', 'ser√≠amos', 'seriam', 'tenho', 'tem', 'temos', 't√™m', 'tinha', 't√≠nhamos', 'tinham', 'tive', 'teve', 'tivemos', 'tiveram', 'tivera', 'tiv√©ramos', 'tenha', 'tenhamos', 'tenham', 'tivesse', 'tiv√©ssemos', 'tivessem', 'tiver', 'tivermos', 'tiverem', 'terei', 'ter√°', 'teremos', 'ter√£o', 'teria', 'ter√≠amos', 'teriam', 'que', 'muito', 'sempre', 'como', 'porque', 'gosto', 'acho', 'pessoa', 'algu√©m'];
                
                const wordCounts = {};
                const words = allPositiveWords.toLowerCase().replace(/[.,!?"'()]/g, ' ').split(/\s+/);
                
                words.forEach(word => {
                    if (word.length > 2 && !stopwords.includes(word)) {
                        wordCounts[word] = (wordCounts[word] || 0) + 1;
                    }
                });
                
                const wordList = Object.entries(wordCounts).map(([text, weight]) => [text, weight * 10]);
                
                if (wordList.length === 0) {
                     emptyMsg.textContent = 'Nenhuma palavra significativa encontrada.';
                     return;
                }

                emptyMsg.classList.add('hidden');
                canvas.classList.remove('hidden');
                
                // Usa a Lib WordCloud2
                WordCloud(canvas, { 
                    list: wordList,
                    gridSize: 10,
                    weightFactor: 2,
                    fontFamily: 'Inter, sans-serif',
                    color: 'random-dark',
                    backgroundColor: '#f9fafb', // bg-gray-50
                    rotateRatio: 0.3,
                    minRotation: -Math.PI / 6,
                    maxRotation: Math.PI / 6,
                    shuffle: true
                });

            } catch (error) {
                console.error("Erro ao gerar nuvem:", error);
                emptyMsg.textContent = 'Erro ao gerar nuvem de palavras.';
            }
        }
        
        // A√ß√£o: Gerar Relat√≥rio Final
        async function generateAdminReport() {
            const reportContent = el('admin-report-content');
            reportContent.classList.remove('hidden');
            
            try {
                // 1. Participa√ß√£o e M√©dia de Tentativas (da rodada atual)
                let totalAttempts = 0;
                let totalGuessed = 0;
                const submitted = currentRoundPairings.filter(p => p.status === 'submitted').length;
                
                currentRoundPairings.forEach(p => {
                    if (p.status === 'guessed' || p.status === 'submitted') {
                        totalGuessed++;
                        totalAttempts += p.attempts;
                    }
                });
                
                const participation = turmaMembers.length > 0 ? (submitted / turmaMembers.length * 100).toFixed(0) : 0;
                const avgGuesses = totalGuessed > 0 ? (totalAttempts / totalGuessed).toFixed(1) : 0;
                
                el('report-participation').textContent = `${participation}%`;
                el('report-avg-guesses').textContent = avgGuesses;
                
                // 2. Total de Feedbacks (geral)
                const fbQuery = query(collection(db, "feedbacks"), where("turma", "==", currentTurmaId));
                const fbSnap = await getDocs(fbQuery);
                el('report-total-feedbacks').textContent = fbSnap.size;
                
                // 3. Badges mais conquistadas
                const badgeCounts = {};
                turmaMembers.forEach(memberId => {
                    // Precisamos buscar cada usu√°rio, pois 'turmaMembers' n√£o tem badges
                    // Para otimizar, usar√≠amos os dados que j√° temos
                });
                
                // Vamos usar os dados de 'turmaMembers' (que vem do listener de 'users')
                const allBadges = [];
                const usersSnap = await getDocs(query(collection(db, "users"), where("turma", "==", currentTurmaId)));
                usersSnap.forEach(doc => {
                    allBadges.push(...(doc.data().badges || []));
                });
                
                allBadges.forEach(badge => {
                    badgeCounts[badge] = (badgeCounts[badge] || 0) + 1;
                });
                
                const topBadges = Object.entries(badgeCounts)
                                  .sort(([,a],[,b]) => b - a)
                                  .slice(0, 5);
                
                const badgesContainer = el('report-top-badges');
                badgesContainer.innerHTML = '';
                if (topBadges.length === 0) {
                    badgesContainer.innerHTML = `<p class="text-gray-500 text-sm">Sem dados</p>`;
                    return;
                }
                
                topBadges.forEach(([name, count]) => {
                    const def = badgeDefs[name];
                    if (def) {
                        badgesContainer.innerHTML += `
                            <span class="inline-flex items-center gap-2 ${def.color} font-bold px-3 py-1.5 rounded-full text-sm shadow-md">
                                ${def.icon} ${name} (x${count})
                            </span>
                        `;
                    }
                });

            } catch (error) {
                console.error("Erro ao gerar relat√≥rio:", error);
            }
        }
        
        // A√ß√£o: Conceder Badge Manual
        async function handleGrantManualBadge() {
            const userId = el('admin-badge-user').value;
            const badgeName = el('admin-badge-name').value;
            
            if (!userId) {
                showMessage('Erro', 'Por favor, selecione um aluno.');
                return;
            }
            
            try {
                const userDocRef = doc(db, "users", userId);
                const userDocSnap = await getDoc(userDocRef);
                if (!userDocSnap.exists()) return;
                
                const currentBadges = userDocSnap.data().badges || [];
                const newBadges = Array.from(new Set([...currentBadges, badgeName]));
                
                await updateDoc(userDocRef, { badges: newBadges });
                showMessage('Sucesso!', `Badge "${badgeName}" concedida para ${userDocSnap.data().nome}.`);
                
            } catch (error) {
                console.error("Erro ao conceder badge:", error);
                showMessage('Erro', 'N√£o foi poss√≠vel conceder a badge.');
            }
        }
        
        // Carrega a lista de dicas para aprova√ß√£o
        async function loadAdminHintApprovals() {
            const list = el('admin-hint-approval-list');
            const template = el('admin-hint-approval-card-template');
            
            const q = query(
                collection(db, "muralDicas"),
                where("turma", "==", currentTurmaId),
                where("approved", "==", false)
            );
            
            // Listener para aprova√ß√µes pendentes
            if (unsubscribeHintListener) unsubscribeHintListener(); // Reusa o listener
            unsubscribeHintListener = onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    list.innerHTML = `<p id="admin-hint-empty" class="text-gray-500 text-center">Nenhuma dica pendente de aprova√ß√£o.</p>`;
                    return;
                }
                list.innerHTML = '';
                
                querySnapshot.forEach(docSnap => {
                    const card = template.content.cloneNode(true);
                    card.querySelector('p').textContent = `"${docSnap.data().text}"`;
                    
                    card.querySelector('[data-id="approve-btn"]').addEventListener('click', async () => {
                        await updateDoc(doc(db, "muralDicas", docSnap.id), { approved: true });
                    });
                    card.querySelector('[data-id="reject-btn"]').addEventListener('click', async () => {
                        await deleteDoc(doc(db, "muralDicas", docSnap.id)); // Ou marcar como 'rejected'
                    });
                    list.appendChild(card);
                });
            });
        }
        
    </script>
</body>
</html>
